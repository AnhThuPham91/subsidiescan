<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsidietool v6 â€” Anh Thu Pham</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg: #f4f3f8;
  --primary: #4a3fa5;
  --primary-light: #7b72d4;
  --primary-xlight: #e8e4f8;
  --accent: #c9a7e8;
  --accent2: #a8d8d0;
  --text: #1a1830;
  --muted: #7a7899;
  --border: #e2e0ef;
  --card: #ffffff;
  --gradient: linear-gradient(135deg,#eee9fb 0%,#f4eefb 45%,#e8f3fb 100%);
  --ok: #e8f6ee; --ok-border: #9ecfb5; --ok-text: #1a5c38;
  --warn: #fef4e4; --warn-border: #f0d070; --warn-text: #7a4a00;
  --danger: #fde8e8; --danger-border: #f0aaaa; --danger-text: #7a1010;
  --excluded: #1a1830; --excluded-bg: #f0eef8; --excluded-border: #b0a8e0;
}

/* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg); color: var(--text); min-height: 100vh;
  background-image:
    radial-gradient(ellipse 70% 40% at 10% 5%,rgba(74,63,165,.07) 0%,transparent 70%),
    radial-gradient(ellipse 50% 50% at 90% 90%,rgba(201,167,232,.1) 0%,transparent 70%);
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  padding: .9rem 2rem; display:flex; align-items:center; gap:.9rem;
  background:rgba(255,255,255,.8); backdrop-filter:blur(14px);
  border-bottom:1px solid var(--border); position:sticky; top:0; z-index:30;
}
.logo {
  width:38px; height:38px; border-radius:11px; flex-shrink:0;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  display:flex; align-items:center; justify-content:center;
  font-family:'DM Serif Display',serif; color:#fff; font-size:1rem;
}
.header-copy h1 { font-family:'DM Serif Display',serif; font-size:1rem; color:var(--primary); }
.header-copy p  { font-size:.68rem; color:var(--muted); font-weight:300; }
.badge { background:var(--primary); color:#fff; font-size:.55rem; padding:.1rem .4rem; border-radius:100px; font-weight:700; letter-spacing:.06em; margin-left:.35rem; vertical-align:middle; }
.progress-bar {
  margin-left:auto; display:flex; align-items:center; gap:.6rem;
}
.pb-step {
  display:flex; align-items:center; gap:.35rem; font-size:.72rem; color:var(--muted); font-weight:500; transition:color .25s;
}
.pb-step.active { color:var(--primary); font-weight:700; }
.pb-step.done   { color:var(--ok-text); }
.pb-dot {
  width:22px; height:22px; border-radius:50%; border:2px solid var(--border);
  background:#fff; display:flex; align-items:center; justify-content:center;
  font-size:.6rem; font-weight:700; transition:all .25s; color:var(--muted); flex-shrink:0;
}
.pb-step.active .pb-dot { border-color:var(--primary); background:var(--primary); color:#fff; }
.pb-step.done   .pb-dot { border-color:var(--ok-border); background:var(--ok); color:var(--ok-text); }
.pb-line { width:28px; height:2px; background:var(--border); border-radius:2px; flex-shrink:0; }
.pb-line.done { background:var(--ok-border); }
@media(max-width:640px){.pb-step span{display:none;} .pb-line{width:12px;} header{padding:.75rem 1rem;}}

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { max-width:820px; margin:0 auto; padding:2rem 1.5rem 6rem; }

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background:var(--card); border:1px solid var(--border); border-radius:18px;
  padding:1.75rem 2rem; margin-bottom:1.25rem;
  box-shadow:0 2px 20px rgba(74,63,165,.05);
}
.card.gradient { background:var(--gradient); }
.card-title {
  font-family:'DM Serif Display',serif; font-size:1rem; color:var(--primary);
  margin-bottom:1.25rem; display:flex; align-items:center; gap:.55rem;
}
.num {
  width:24px; height:24px; border-radius:7px; background:var(--primary); color:#fff;
  font-size:.65rem; font-weight:700; display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.intro-card { background:var(--gradient); border:1px solid var(--border); border-radius:20px; padding:1.75rem 2rem; margin-bottom:1.75rem; }
.intro-card h2 { font-family:'DM Serif Display',serif; font-size:1.3rem; color:var(--primary); margin-bottom:.35rem; }
.intro-card p  { color:var(--muted); font-size:.86rem; line-height:1.65; }
.pills { display:flex; flex-wrap:wrap; gap:.3rem; margin-top:.75rem; }
.pill { background:#fff; border:1px solid var(--border); border-radius:100px; padding:.22rem .65rem; font-size:.71rem; color:var(--primary); font-weight:500; }

/* â”€â”€ Keys card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.keys-details { background:linear-gradient(135deg,#faf8ff,#f5f0ff); border:1px solid var(--accent); border-radius:18px; padding:1.25rem 1.75rem; margin-bottom:1.5rem; }
.keys-details summary { cursor:pointer; font-family:'DM Serif Display',serif; font-size:.95rem; color:var(--primary); list-style:none; display:flex; align-items:center; gap:.5rem; }
.keys-details summary::after { content:'â–¾'; margin-left:auto; color:var(--muted); }
details[open].keys-details summary::after { content:'â–´'; }
.keys-grid { display:grid; grid-template-columns:1fr 1fr; gap:.75rem; margin-top:1rem; }
@media(max-width:580px){ .keys-grid{grid-template-columns:1fr;} }
.key-field label { display:block; font-size:.73rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:.3rem; }
.key-row { position:relative; }
.key-row input { padding-right:3rem !important; font-family:monospace; font-size:.78rem; }
.key-toggle { position:absolute; right:.7rem; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; color:var(--muted); font-size:.72rem; }
.keys-ok { font-size:.72rem; color:var(--ok-text); font-weight:600; display:none; margin-top:.4rem; }

/* â”€â”€ Form fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field { margin-bottom:1.1rem; }
label { display:block; font-size:.82rem; font-weight:600; color:var(--text); margin-bottom:.35rem; }
.sublabel { font-size:.7rem; color:var(--muted); font-weight:400; margin-left:.2rem; }
.field-note { font-size:.75rem; color:var(--muted); line-height:1.55; margin-bottom:.45rem; }
input[type="text"],input[type="password"],input[type="url"],textarea,select {
  width:100%; padding:.7rem .95rem; border:1.5px solid var(--border); border-radius:11px;
  font-family:'DM Sans',sans-serif; font-size:.86rem; color:var(--text);
  background:#fafafa; outline:none; transition:border-color .2s, box-shadow .2s; -webkit-appearance:none;
}
input:focus, textarea:focus { border-color:var(--primary-light); box-shadow:0 0 0 3px rgba(74,63,165,.08); background:#fff; }
textarea { resize:vertical; min-height:88px; line-height:1.55; }
.tag-group { display:flex; flex-wrap:wrap; gap:.35rem; margin-top:.35rem; }
.tag {
  padding:.32rem .72rem; border:1.5px solid var(--border); border-radius:100px;
  font-size:.76rem; cursor:pointer; transition:all .15s; background:#fafafa;
  user-select:none; font-family:'DM Sans',sans-serif;
}
.tag:hover { border-color:var(--primary-light); background:#f0eef8; }
.tag.selected { background:var(--primary); color:#fff; border-color:var(--primary); }

/* â”€â”€ Upload zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.upload-zone {
  border:2px dashed var(--border); border-radius:12px; padding:1.1rem;
  text-align:center; cursor:pointer; transition:all .2s; background:#fafafa; position:relative;
}
.upload-zone:hover,.upload-zone.dragover { border-color:var(--primary-light); background:var(--primary-xlight); }
.upload-zone .uz-icon { font-size:1.4rem; margin-bottom:.2rem; }
.upload-zone p { font-size:.78rem; color:var(--muted); }
.upload-zone strong { color:var(--primary); font-size:.8rem; }
.status-msg { margin-top:.5rem; font-size:.77rem; padding:.4rem .7rem; border-radius:8px; display:none; }
.status-msg.success { background:var(--ok); color:var(--ok-text); display:block; }
.status-msg.loading { background:var(--primary-xlight); color:var(--primary); display:block; }
.status-msg.error   { background:var(--danger); color:var(--danger-text); display:block; }
.context-preview { background:#f5f3fb; border:1px solid var(--border); border-radius:9px; padding:.6rem .85rem; margin-top:.5rem; font-size:.75rem; color:var(--muted); max-height:80px; overflow-y:auto; display:none; line-height:1.5; }
.context-preview.visible { display:block; }
.or-div { text-align:center; color:var(--muted); font-size:.75rem; margin:.6rem 0; position:relative; }
.or-div::before,.or-div::after { content:''; position:absolute; top:50%; width:44%; height:1px; background:var(--border); }
.or-div::before{left:0}.or-div::after{right:0}
.url-row { display:flex; gap:.4rem; }
.url-row input { flex:1; }
.fetch-btn { padding:.7rem 1rem; background:var(--primary); color:#fff; border:none; border-radius:11px; font-family:'DM Sans',sans-serif; font-size:.8rem; font-weight:600; cursor:pointer; white-space:nowrap; transition:all .2s; flex-shrink:0; }
.fetch-btn:hover { background:var(--primary-light); }
.fetch-btn:disabled { opacity:.5; cursor:not-allowed; }
.paste-toggle { font-size:.75rem; color:var(--primary); cursor:pointer; text-decoration:underline; text-underline-offset:2px; margin-top:.4rem; display:inline-block; }
.paste-area { display:none; margin-top:.6rem; }
.paste-area.visible { display:block; }
.paste-save { margin-top:.4rem; padding:.42rem .85rem; background:var(--primary); color:#fff; border:none; border-radius:9px; font-family:'DM Sans',sans-serif; font-size:.77rem; font-weight:600; cursor:pointer; }

/* â”€â”€ Fonds URL card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fonds-url-card { position:relative; }
.fonds-url-card::before { content:'â†“'; position:absolute; top:-1.5rem; left:50%; transform:translateX(-50%); color:var(--border); font-size:1.25rem; }

/* â”€â”€ CTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cta-btn {
  width:100%; padding:1.05rem; background:linear-gradient(135deg,var(--primary),var(--primary-light));
  color:#fff; border:none; border-radius:14px; font-family:'DM Serif Display',serif;
  font-size:1.05rem; cursor:pointer; letter-spacing:.01em;
  box-shadow:0 5px 22px rgba(74,63,165,.28); transition:all .22s; margin-top:.5rem;
}
.cta-btn:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 9px 28px rgba(74,63,165,.35); }
.cta-btn:disabled { opacity:.45; cursor:not-allowed; transform:none; }
.btn-sm { padding:.48rem .95rem; border:1.5px solid var(--border); border-radius:9px; background:#fff; color:var(--text); font-family:'DM Sans',sans-serif; font-size:.78rem; font-weight:600; cursor:pointer; transition:all .15s; }
.btn-sm:hover { border-color:var(--primary-light); color:var(--primary); }
.btn-row { display:flex; gap:.45rem; flex-wrap:wrap; }

/* â”€â”€ Progress screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-screen { display:none; }
.progress-screen.active { display:block; }
.step-list { display:flex; flex-direction:column; gap:.6rem; }
.step {
  display:flex; align-items:center; gap:.8rem; padding:.65rem .95rem;
  border-radius:11px; border:1px solid var(--border); background:#fafafa;
  font-size:.84rem; color:var(--muted); transition:all .3s;
}
.step.active { border-color:var(--primary-light); background:var(--primary-xlight); color:var(--primary); font-weight:600; }
.step.done   { border-color:var(--ok-border); background:var(--ok); color:var(--ok-text); }
.step.error  { border-color:var(--danger-border); background:var(--danger); color:var(--danger-text); }
.step-icon { width:1.4rem; text-align:center; font-size:1rem; flex-shrink:0; }
.step-detail { font-size:.71rem; opacity:.8; margin-top:.06rem; }
.spin { width:15px; height:15px; border:2px solid rgba(74,63,165,.2); border-top-color:var(--primary); border-radius:50%; animation:spin .8s linear infinite; flex-shrink:0; margin-left:auto; }
@keyframes spin{to{transform:rotate(360deg)}}
.log-box { background:#1a1830; color:#b8d4b0; font-family:monospace; font-size:.72rem; border-radius:11px; padding:.85rem 1.1rem; max-height:140px; overflow-y:auto; margin-top:.85rem; line-height:1.7; }
.log-ts   { color:#5a5878; margin-right:.45rem; }
.log-ok   { color:#7ec89a; }
.log-warn { color:#e8c870; }
.log-err  { color:#e87070; }

/* â”€â”€ Results screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.results-screen { display:none; }
.results-screen.active { display:block; }
.fonds-banner {
  background:var(--gradient); border:1px solid var(--border); border-radius:16px;
  padding:1.1rem 1.5rem; margin-bottom:1.25rem; display:flex; align-items:center; gap:.9rem; flex-wrap:wrap;
}
.fb-icon { font-size:1.75rem; }
.fb-text h3 { font-family:'DM Serif Display',serif; font-size:1rem; color:var(--primary); }
.fb-text p  { font-size:.76rem; color:var(--muted); margin-top:.1rem; }
.fb-url  { margin-left:auto; font-size:.74rem; }
.fb-url a { color:var(--primary); font-weight:600; text-decoration:underline; text-underline-offset:2px; }

/* Result card */
.rc {
  background:#fff; border:1px solid var(--border); border-radius:14px;
  margin-bottom:.85rem; overflow:hidden; box-shadow:0 2px 12px rgba(74,63,165,.04);
  transition:box-shadow .2s;
}
.rc:hover { box-shadow:0 5px 20px rgba(74,63,165,.1); }
.rc-head {
  padding:.9rem 1.35rem; display:flex; align-items:center; gap:.85rem;
  cursor:pointer; border-bottom:1px solid transparent; transition:border-color .2s;
}
.rc-head.open { border-bottom-color:var(--border); }
.rc-name { font-weight:700; font-size:.92rem; flex:1; }
.rc-fonds-tag { font-size:.68rem; color:var(--muted); background:#f4f3f8; padding:.15rem .5rem; border-radius:6px; margin-right:.2rem; }
.score-badge { padding:.22rem .65rem; border-radius:100px; font-size:.69rem; font-weight:800; letter-spacing:.04em; white-space:nowrap; flex-shrink:0; }
.s-hoog  { background:#d4f0e2; color:#1a5c38; }
.s-middel{ background:#fef0d6; color:#7a4a00; }
.s-laag  { background:#fde4e4; color:#7a1010; }
.s-uitg  { background:#1a1830; color:#e8e4f8; }
.chevron { color:var(--muted); font-size:.78rem; transition:transform .2s; flex-shrink:0; }
.chevron.open { transform:rotate(180deg); }

.rc-body { display:none; padding:1.1rem 1.35rem 1.35rem; }
.rc-body.open { display:block; }

/* Exclusion banner */
.excl-banner {
  background:var(--excluded-bg); border:1px solid var(--excluded-border);
  border-radius:11px; padding:.8rem 1.1rem; margin-bottom:.85rem;
}
.excl-banner .eb-label { font-size:.73rem; font-weight:800; color:var(--primary); text-transform:uppercase; letter-spacing:.07em; margin-bottom:.35rem; }
.excl-banner ul { padding-left:1.1rem; }
.excl-banner li { font-size:.82rem; color:var(--primary); line-height:1.5; margin:.1rem 0; }

/* Data grid */
.dg { display:grid; grid-template-columns:1fr 1fr; gap:.6rem; margin-bottom:.85rem; }
@media(max-width:540px){.dg{grid-template-columns:1fr;}}
.dc { background:#fafafa; border:1px solid var(--border); border-radius:9px; padding:.55rem .8rem; }
.dc.hl { border-color:var(--primary-light); background:#f3f1fc; }
.dc-lbl { font-size:.63rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.07em; margin-bottom:.18rem; }
.dc-val { font-size:.82rem; color:var(--text); line-height:1.4; }

/* Criteria lists */
.crit-sec { margin-bottom:.7rem; }
.crit-sec h4 { font-size:.7rem; font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.07em; margin-bottom:.3rem; }
.crit-list { display:flex; flex-direction:column; gap:.22rem; }
.ci { display:flex; align-items:flex-start; gap:.4rem; font-size:.8rem; padding:.28rem .5rem; border-radius:7px; }
.ci.soft { background:#fafafa; border:1px solid var(--border); }
.ci.hard { background:var(--danger); border:1px solid var(--danger-border); color:var(--danger-text); }
.ci.pos  { background:var(--ok); border:1px solid var(--ok-border); color:var(--ok-text); }
.ci-dot { flex-shrink:0; margin-top:.05rem; }

/* Match score bar */
.score-bar-wrap { margin-top:.75rem; }
.score-bar-wrap .sb-label { font-size:.72rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; margin-bottom:.35rem; display:flex; justify-content:space-between; align-items:center; }
.score-bar-wrap .sb-label strong { font-size:.9rem; color:var(--primary); }
.score-bar { height:8px; background:var(--border); border-radius:100px; overflow:hidden; }
.score-fill {
  height:100%; border-radius:100px; transition:width .6s ease;
  background:linear-gradient(90deg, var(--primary-light), var(--primary));
}
.score-fill.low  { background:linear-gradient(90deg,#f0b0b0,#e07070); }
.score-fill.mid  { background:linear-gradient(90deg,#f0d470,#e0a820); }

/* Motivation */
.motivation-box { font-size:.85rem; color:var(--text); line-height:1.7; padding:.75rem 1rem; background:#f9f8fe; border-radius:10px; margin-bottom:.75rem; }

/* Evidence */
.ev-item { border:1px solid var(--border); border-radius:9px; padding:.55rem .8rem; margin-bottom:.35rem; }
.ev-url  { font-size:.69rem; color:var(--primary); font-weight:600; display:block; margin-bottom:.18rem; word-break:break-all; text-decoration:underline; }
.ev-quote { font-size:.76rem; color:var(--muted); font-style:italic; line-height:1.5; }

/* Uncertain badge */
.uncertain { color:#9a6a00; background:#fef8e6; border:1px solid #f0d870; border-radius:4px; padding:.06rem .3rem; font-size:.7rem; font-weight:700; }

/* Doelgroep tags */
.dt-tag { display:inline-flex; align-items:center; gap:.25rem; padding:.18rem .55rem; border-radius:6px; font-size:.72rem; font-weight:600; margin:.1rem .15rem 0 0; }
.dt-ok   { background:var(--ok); color:var(--ok-text); }
.dt-warn { background:var(--danger); color:var(--danger-text); }
.dt-neu  { background:#f0eef8; color:var(--primary); }

/* Summary bar */
.summary-bar {
  display:flex; gap:.75rem; flex-wrap:wrap; margin-bottom:1.25rem;
  padding:1rem 1.35rem; background:#fff; border:1px solid var(--border); border-radius:14px;
}
.sb-stat { text-align:center; flex:1; min-width:60px; }
.sb-stat .ss-n { font-family:'DM Serif Display',serif; font-size:1.8rem; line-height:1; color:var(--primary); }
.sb-stat .ss-l { font-size:.7rem; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.05em; margin-top:.2rem; }
.sb-stat.red .ss-n { color:#b04040; }
.sb-stat.green .ss-n { color:#1a5c38; }
.sb-stat.orange .ss-n { color:#b06a00; }

/* Raw JSON */
.raw-toggle { font-size:.72rem; color:var(--muted); cursor:pointer; text-decoration:underline; margin-top:.85rem; display:inline-block; }
.raw-json { display:none; background:#1a1830; color:#a8d4f0; font-family:monospace; font-size:.7rem; border-radius:11px; padding:.85rem; margin-top:.4rem; max-height:260px; overflow-y:auto; white-space:pre-wrap; word-break:break-all; line-height:1.6; }

/* â”€â”€ Util â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:580px){ .main{padding:1.25rem .85rem 4rem;} .card{padding:1.35rem;} }
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€ -->
<header>
  <div class="logo">A</div>
  <div class="header-copy">
    <h1>Subsidietool <span class="badge">v6</span></h1>
    <p>Anh Thu Pham â€” fondsenanalyse & matchsysteem</p>
  </div>
  <div class="progress-bar" id="progressBar">
    <div class="pb-step active" id="pbStep1">
      <div class="pb-dot">1</div>
      <span>Project</span>
    </div>
    <div class="pb-line" id="pbLine1"></div>
    <div class="pb-step" id="pbStep2">
      <div class="pb-dot">2</div>
      <span>Fonds</span>
    </div>
    <div class="pb-line" id="pbLine2"></div>
    <div class="pb-step" id="pbStep3">
      <div class="pb-dot">3</div>
      <span>Analyse</span>
    </div>
    <div class="pb-line" id="pbLine3"></div>
    <div class="pb-step" id="pbStep4">
      <div class="pb-dot">4</div>
      <span>Match</span>
    </div>
  </div>
</header>

<!-- â”€â”€ Main â”€â”€ -->
<div class="main">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  FORM SCREEN                                                   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="formScreen">

  <!-- Intro -->
  <div class="intro-card">
    <h2>Subsidies matchen op regelingsniveau</h2>
    <p>Vul het klantprofiel en een fonds-URL in. De tool crawlt de website, extraheert elke regeling afzonderlijk en berekent per regeling een matchscore â€” inclusief harde uitsluitingschecks.</p>
    <div class="pills">
      <span class="pill">âš¡ Regelingniveau scoring</span>
      <span class="pill">ğŸš« Harde uitsluitingslogica</span>
      <span class="pill">ğŸ•· Apify Playwright crawl</span>
      <span class="pill">ğŸ¤– Claude JSON-analyse</span>
    </div>
  </div>

  <!-- API Keys -->
  <details class="keys-details" id="keysCard" open>
    <summary>ğŸ”‘ API Sleutels</summary>
    <div class="keys-grid">
      <div class="key-field">
        <label>Claude API Key</label>
        <div class="key-row">
          <input type="password" id="claudeKey" placeholder="sk-ant-api03-..." oninput="checkKeys()">
          <button class="key-toggle" onclick="toggleKey('claudeKey',this)">toon</button>
        </div>
      </div>
      <div class="key-field">
        <label>Apify API Token</label>
        <div class="key-row">
          <input type="password" id="apifyToken" placeholder="apify_api_..." oninput="checkKeys()">
          <button class="key-toggle" onclick="toggleKey('apifyToken',this)">toon</button>
        </div>
      </div>
      <div class="key-field">
        <label>SerpAPI Key</label>
        <div class="key-row">
          <input type="password" id="serpKey" placeholder="serpapi_key_..." oninput="checkKeys()">
          <button class="key-toggle" onclick="toggleKey('serpKey',this)">toon</button>
        </div>
      </div>
      <div class="key-field" style="display:flex;align-items:flex-end;">
        <div>
          <p class="keys-ok" id="keysOk">âœ“ Alle sleutels ingevuld</p>
          <p style="font-size:.71rem;color:var(--muted);line-height:1.5;">Keys worden alleen lokaal gebruikt en nooit opgeslagen.</p>
        </div>
      </div>
    </div>
  </details>

  <!-- â”€â”€ STAP 1: Klantprofiel â”€â”€ -->
  <div class="card">
    <div class="card-title"><span class="num">1</span> Klantprofiel</div>

    <div class="field">
      <label>Naam <span class="sublabel">(optioneel)</span></label>
      <input type="text" id="naam" placeholder="bijv. naam van de kunstenaar">
    </div>

    <div class="field">
      <label>Rechtsvorm <span class="sublabel">â€” selecteer Ã©Ã©n</span></label>
      <div class="tag-group" id="rechtsVormTags" data-single="true">
        <span class="tag" data-val="individuele kunstenaar (zzp)">Individuele kunstenaar / ZZP</span>
        <span class="tag" data-val="kunstenaarscollectief (informeel)">Collectief (informeel)</span>
        <span class="tag" data-val="stichting">Stichting</span>
        <span class="tag" data-val="vereniging">Vereniging</span>
        <span class="tag" data-val="bv/nv (commercieel)">BV / NV</span>
        <span class="tag" data-val="student (geen kvk)">Student</span>
      </div>
    </div>

    <div class="field">
      <label>Kunstdiscipline(s)</label>
      <div class="tag-group" id="disciplineTags">
        <span class="tag" data-val="beeldende kunst">Beeldende kunst</span>
        <span class="tag" data-val="muziek">Muziek</span>
        <span class="tag" data-val="theater">Theater</span>
        <span class="tag" data-val="dans">Dans</span>
        <span class="tag" data-val="film">Film</span>
        <span class="tag" data-val="design">Design</span>
        <span class="tag" data-val="architectuur">Architectuur</span>
        <span class="tag" data-val="digitale cultuur">Digitale cultuur</span>
        <span class="tag" data-val="mode/textiel">Mode / Textiel</span>
        <span class="tag" data-val="literatuur">Literatuur</span>
        <span class="tag" data-val="fotografie">Fotografie</span>
        <span class="tag" data-val="erfgoed">Erfgoed</span>
        <span class="tag" data-val="podiumkunsten">Podiumkunsten</span>
        <span class="tag" data-val="interdisciplinair">Interdisciplinair</span>
      </div>
    </div>

    <div class="field">
      <label>CarriÃ¨refase</label>
      <div class="tag-group" id="faseTags" data-single="true">
        <span class="tag" data-val="startend (0-3 jaar)">Startend (0â€“3 jr)</span>
        <span class="tag" data-val="gevestigd (3-10 jaar)">Gevestigd (3â€“10 jr)</span>
        <span class="tag" data-val="ervaren (10+ jaar)">Ervaren (10+ jr)</span>
        <span class="tag" data-val="student">Student</span>
      </div>
    </div>

    <div class="field">
      <label>Woonplaats / stad</label>
      <input type="text" id="regio" placeholder="bijv. Amsterdam, Den Haag, Rotterdam...">
    </div>

    <div class="field">
      <label>Culturele achtergrond <span class="sublabel">(optioneel)</span></label>
      <input type="text" id="achtergrond" placeholder="bijv. Vietnamese roots, Surinaamse achtergrond...">
    </div>
  </div>

  <!-- â”€â”€ STAP 2: Portfolio & Documenten â”€â”€ -->
  <div class="card">
    <div class="card-title"><span class="num">2</span> Portfolio & Documenten <span class="sublabel" style="font-weight:400;font-family:'DM Sans',sans-serif;">â€” optioneel</span></div>

    <div class="field">
      <label>Website of portfolio-URL</label>
      <div class="url-row">
        <input type="text" id="portfolioUrl" placeholder="https://www.kunstenaarnaam.nl">
        <button class="fetch-btn" id="fetchBtn" onclick="fetchWebsite()">ğŸŒ Lezen</button>
      </div>
      <div class="status-msg" id="urlStatus"></div>
      <div class="context-preview" id="urlPreview"></div>
    </div>

    <div class="or-div">of</div>

    <div class="field">
      <label>Projectplan, CV of portfolio uploaden of plakken</label>
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileUpload').click()">
        <div class="uz-icon">ğŸ“„</div>
        <strong>Klik om PDF of .txt te uploaden</strong>
        <p>of sleep een bestand hierheen â€” max 20MB</p>
      </div>
      <input type="file" id="fileUpload" accept=".pdf,.txt,.md" onchange="handleFileUpload(this)" style="display:none">
      <span class="paste-toggle" onclick="togglePaste()">âœï¸ Liever tekst plakken?</span>
      <div class="paste-area" id="pasteArea">
        <textarea id="pasteText" placeholder="Plak hier de inhoud van je projectplan, CV of portfolio..."></textarea>
        <button class="paste-save" onclick="savePastedText()">âœ“ Opslaan als context</button>
      </div>
      <div class="status-msg" id="fileStatus"></div>
      <div class="context-preview" id="filePreview"></div>
    </div>
  </div>

  <!-- â”€â”€ STAP 3: Het project â”€â”€ -->
  <div class="card">
    <div class="card-title"><span class="num">3</span> Het project</div>

    <div class="field">
      <label>Beschrijf het project zo concreet mogelijk</label>
      <textarea id="projectOmschrijving" placeholder="bijv. Een danser ontwikkelt een nieuw solowerk over culturele identiteit. PremiÃ¨re gepland voor voorjaar 2026 in een theater in Rotterdam..."></textarea>
    </div>

    <div class="field">
      <label>Projectfase</label>
      <div class="tag-group" id="faseProjTags">
        <span class="tag" data-val="onderzoek/ontwikkeling">Onderzoek / ontwikkeling</span>
        <span class="tag" data-val="voorproductie">Voorproductie</span>
        <span class="tag" data-val="productie">Productie</span>
        <span class="tag" data-val="presentatie">Presentatie</span>
        <span class="tag" data-val="publicatie">Publicatie</span>
        <span class="tag" data-val="talentontwikkeling">Talentontwikkeling</span>
        <span class="tag" data-val="doorontwikkeling bestaand werk">Doorontwikkeling</span>
      </div>
    </div>

    <div class="field">
      <label>Presentatielocatie</label>
      <div class="tag-group" id="locatieTags">
        <span class="tag" data-val="Nederland">Nederland</span>
        <span class="tag" data-val="internationaal/buitenland">Internationaal</span>
        <span class="tag" data-val="online">Online</span>
      </div>
    </div>

    <div class="field">
      <label>Primair doel</label>
      <div class="tag-group" id="doelTags">
        <span class="tag" data-val="artistieke ontwikkeling">Artistieke ontwikkeling</span>
        <span class="tag" data-val="publieksbereik">Publieksbereik</span>
        <span class="tag" data-val="onderzoek">Onderzoek</span>
        <span class="tag" data-val="educatie">Educatie</span>
        <span class="tag" data-val="participatie">Participatie</span>
        <span class="tag" data-val="internationale samenwerking">Int. samenwerking</span>
        <span class="tag" data-val="talentontwikkeling">Talentontwikkeling</span>
      </div>
    </div>

    <div class="field">
      <label>Type activiteit</label>
      <p class="field-note">Artistiek</p>
      <div class="tag-group" id="typeArtTags" style="margin-bottom:.6rem;">
        <span class="tag" data-val="tentoonstelling">Tentoonstelling</span>
        <span class="tag" data-val="performance">Performance</span>
        <span class="tag" data-val="installatie">Installatie</span>
        <span class="tag" data-val="filmproductie">Filmproductie</span>
        <span class="tag" data-val="publicatie/boek">Publicatie / boek</span>
        <span class="tag" data-val="digitale productie">Digitale productie</span>
        <span class="tag" data-val="prototype">Prototype</span>
      </div>
      <p class="field-note">Participatief / Onderzoek</p>
      <div class="tag-group" id="typePartTags">
        <span class="tag" data-val="workshop">Workshop</span>
        <span class="tag" data-val="educatief programma">Educatief programma</span>
        <span class="tag" data-val="community project">Community project</span>
        <span class="tag" data-val="artistiek onderzoek">Artistiek onderzoek</span>
        <span class="tag" data-val="archiefonderzoek">Archiefonderzoek</span>
      </div>
    </div>

    <div class="field">
      <label>Maatschappelijke focus <span class="sublabel">(indien van toepassing)</span></label>
      <div class="tag-group" id="sociaalTags">
        <span class="tag" data-val="polarisatie/radicalisering">Polarisatie / radicalisering</span>
        <span class="tag" data-val="trans-Atlantisch slavernij/erfgoed">Slavernij / erfgoed</span>
        <span class="tag" data-val="klimaat/duurzaamheid">Klimaat / duurzaamheid</span>
        <span class="tag" data-val="sociaal-maatschappelijk">Sociaal-maatschappelijk</span>
        <span class="tag" data-val="inclusie/diversiteit">Inclusie / diversiteit</span>
      </div>
    </div>

    <div class="field">
      <label>Gevraagd subsidiebedrag</label>
      <div class="tag-group" id="bedragTags" data-single="true">
        <span class="tag" data-val="onder â‚¬1.000">Onder â‚¬1.000</span>
        <span class="tag" data-val="â‚¬1.000â€“â‚¬5.000">â‚¬1.000 â€“ â‚¬5.000</span>
        <span class="tag" data-val="â‚¬5.000â€“â‚¬15.000">â‚¬5.000 â€“ â‚¬15.000</span>
        <span class="tag" data-val="â‚¬15.000+">â‚¬15.000+</span>
        <span class="tag" data-val="onbekend">Onbekend</span>
      </div>
    </div>

    <div class="field">
      <label>Eerder subsidie ontvangen van</label>
      <div class="tag-group" id="ontvangenTags">
        <span class="tag" data-val="Stimuleringsfonds">Stimuleringsfonds</span>
        <span class="tag" data-val="Mondriaanfonds">Mondriaanfonds</span>
        <span class="tag" data-val="Fonds Podiumkunsten">Fonds Podiumkunsten</span>
        <span class="tag" data-val="Filmfonds">Filmfonds</span>
        <span class="tag" data-val="Nederlands Letterenfonds">Nederlands Letterenfonds</span>
        <span class="tag" data-val="Fonds voor Cultuurparticipatie">Cultuurparticipatie</span>
        <span class="tag" data-val="Gemeente">Gemeente subsidie</span>
        <span class="tag" data-val="geen">Nog geen subsidies</span>
      </div>
      <input type="text" id="ontvangenAndere" placeholder="Anders: bijv. AFK, VSBFonds, Cultuurfonds..." style="margin-top:.5rem;">
    </div>

    <div class="field">
      <label>Extra context <span class="sublabel">(deadlines, partners, bijzonderheden)</span></label>
      <textarea id="extraContext" placeholder="bijv. deadline AFK is oktober, samenwerking met Eye Filmmuseum bevestigd..." style="min-height:60px;"></textarea>
    </div>
  </div>

  <!-- â”€â”€ STAP 4: Fonds URL â”€â”€ -->
  <div class="card fonds-url-card">
    <div class="card-title"><span class="num">4</span> Fonds analyseren</div>
    <p class="field-note" style="margin-bottom:.85rem;">Geef de website-URL van het fonds dat je wilt analyseren en matchen. De tool crawlt automatisch alle relevante pagina's en regelingen.</p>

    <div class="field">
      <label>Website URL van het fonds</label>
      <input type="url" id="fondsUrl" placeholder="https://www.fondsnaam.nl/subsidies" oninput="updateCta()">
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.65rem;">
      <div>
        <label style="font-size:.74rem;color:var(--muted);">Max crawldiepte</label>
        <input type="text" id="crawlDepth" value="3" style="margin-top:.25rem;">
      </div>
      <div>
        <label style="font-size:.74rem;color:var(--muted);">Max pagina's</label>
        <input type="text" id="crawlPages" value="30" style="margin-top:.25rem;">
      </div>
    </div>
  </div>

  <!-- CTA -->
  <button class="cta-btn" id="ctaBtn" onclick="startAnalysis()" disabled>
    ğŸš€ Analyseer fonds &amp; bereken matches
  </button>
</div><!-- /formScreen -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  PROGRESS SCREEN                                              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="progress-screen" id="progressScreen">
  <div class="card">
    <div class="card-title" style="margin-bottom:1.35rem;">âŸ³ Bezig met analyseren...</div>
    <div class="step-list">
      <div class="step" id="st1">
        <span class="step-icon">ğŸ”</span>
        <div style="flex:1;"><div>SerpAPI â€” pagina's targeten</div><div class="step-detail" id="st1d"></div></div>
        <div class="spin" id="sp1" style="display:none;"></div>
      </div>
      <div class="step" id="st2">
        <span class="step-icon">ğŸ•·</span>
        <div style="flex:1;"><div>Apify Playwright crawl starten &amp; pollen</div><div class="step-detail" id="st2d">Elke 5 seconden pollen...</div></div>
        <div class="spin" id="sp2" style="display:none;"></div>
      </div>
      <div class="step" id="st3">
        <span class="step-icon">ğŸ“¥</span>
        <div style="flex:1;"><div>Dataset ophalen &amp; filteren</div><div class="step-detail" id="st3d"></div></div>
        <div class="spin" id="sp3" style="display:none;"></div>
      </div>
      <div class="step" id="st4">
        <span class="step-icon">ğŸ¤–</span>
        <div style="flex:1;"><div>Claude â€” regelingen extraheren (nieuw schema)</div><div class="step-detail" id="st4d"></div></div>
        <div class="spin" id="sp4" style="display:none;"></div>
      </div>
      <div class="step" id="st5">
        <span class="step-icon">âš¡</span>
        <div style="flex:1;"><div>Match engine â€” uitsluitingen &amp; scores berekenen</div><div class="step-detail" id="st5d"></div></div>
        <div class="spin" id="sp5" style="display:none;"></div>
      </div>
    </div>
    <div class="log-box" id="logBox"></div>
  </div>
</div><!-- /progressScreen -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  RESULTS SCREEN                                               -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="results-screen" id="resultsScreen">

  <!-- Header row -->
  <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1.25rem;flex-wrap:wrap;">
    <div>
      <h2 style="font-family:'DM Serif Display',serif;font-size:1.25rem;color:var(--primary);">Matchresultaten</h2>
      <p style="font-size:.77rem;color:var(--muted);margin-top:.12rem;" id="resMeta"></p>
    </div>
    <div class="btn-row">
      <button class="btn-sm" onclick="copyJson()">ğŸ“‹ JSON kopiÃ«ren</button>
      <button class="btn-sm" onclick="resetAll()">â† Nieuwe analyse</button>
    </div>
  </div>

  <!-- Summary bar -->
  <div class="summary-bar" id="summaryBar"></div>

  <!-- Fonds banner -->
  <div id="fondsBanner"></div>

  <!-- Match cards -->
  <div id="matchCards"></div>

  <!-- Raw JSON -->
  <span class="raw-toggle" onclick="toggleRaw()" id="rawToggle">â–¸ Bekijk ruwe JSON</span>
  <div class="raw-json" id="rawJson"></div>

</div><!-- /resultsScreen -->

</div><!-- /main -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  JAVASCRIPT                                                   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP STATE â€” clean separation
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const appState = {
  apiKeys: { claude: '', apify: '', serp: '' },
  project: null,        // collected form data
  crawlData: null,      // raw data from Claude extraction
  matchResults: null    // array of scored regelingen
};

let websiteContext  = '';
let documentContext = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const esc   = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const sleep = ms => new Promise(r => setTimeout(r, ms));
const getV  = id => document.getElementById(id)?.value?.trim() || '';
const getSelected = id => [...document.querySelectorAll(`#${id} .tag.selected`)].map(t => t.dataset.val);

function markUncertain(s) {
  return s.replace(/ONZEKER â€“ handmatig controleren/gi,
    '<span class="uncertain">âš  ONZEKER</span>');
}

function toggleKey(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
  btn.textContent = el.type === 'password' ? 'toon' : 'verberg';
}

function checkKeys() {
  const ok = getV('claudeKey') && getV('apifyToken') && getV('serpKey');
  document.getElementById('keysOk').style.display = ok ? 'block' : 'none';
  updateCta();
}

function updateCta() {
  const hasKeys    = getV('claudeKey') && getV('apifyToken') && getV('serpKey');
  const hasUrl     = getV('fondsUrl');
  const hasProject = document.querySelectorAll('#rechtsVormTags .tag.selected').length > 0 ||
                     document.querySelectorAll('#disciplineTags .tag.selected').length > 0 ||
                     getV('projectOmschrijving');
  document.getElementById('ctaBtn').disabled = !(hasKeys && hasUrl && hasProject);
}

function log(msg, type = '') {
  const box = document.getElementById('logBox');
  if (!box) return;
  const ts  = new Date().toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const cls = {ok:'log-ok',warn:'log-warn',err:'log-err'}[type] || '';
  box.innerHTML += `<div><span class="log-ts">[${ts}]</span><span class="${cls}">${esc(msg)}</span></div>`;
  box.scrollTop  = box.scrollHeight;
}

function setStep(n, state, detail='') {
  const el = document.getElementById(`st${n}`);
  const sp = document.getElementById(`sp${n}`);
  if (!el) return;
  el.className = 'step ' + state;
  if (detail && document.getElementById(`st${n}d`)) document.getElementById(`st${n}d`).textContent = detail;
  if (sp) sp.style.display = state === 'active' ? 'block' : 'none';
  const icons = {1:'ğŸ”',2:'ğŸ•·',3:'ğŸ“¥',4:'ğŸ¤–',5:'âš¡'};
  el.querySelector('.step-icon').textContent =
    state === 'done' ? 'âœ…' : state === 'error' ? 'âŒ' : icons[n];
}

function setProgressStep(stepNum) {
  [1,2,3,4].forEach(n => {
    const el = document.getElementById(`pbStep${n}`);
    const ln = document.getElementById(`pbLine${n}`);
    if (n < stepNum) { el.className='pb-step done'; el.querySelector('.pb-dot').textContent='âœ“'; if(ln) ln.classList.add('done'); }
    else if (n === stepNum) { el.className='pb-step active'; el.querySelector('.pb-dot').textContent=String(n); }
    else { el.className='pb-step'; el.querySelector('.pb-dot').textContent=String(n); if(ln) ln.classList.remove('done'); }
  });
}

function stripHtml(html) {
  const t = document.createElement('div');
  t.innerHTML = html;
  return (t.textContent || t.innerText || '').replace(/\s+/g,' ').trim();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API CALL â€” Claude
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callClaude(messages, maxTokens=4096) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
      'x-api-key': appState.apiKeys.claude
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      messages
    })
  });
  const data = await resp.json();
  if (!resp.ok || data.error) throw new Error(data.error?.message || `Claude fout ${resp.status}`);
  return data.content?.map(c => c.text || '').join('') || '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEBSITE FETCH (portfolio)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchWebsite() {
  const url = getV('portfolioUrl');
  if (!url) return alert('Vul een URL in.');
  if (!getV('claudeKey')) return alert('Vul eerst je Claude API key in.');
  const status  = document.getElementById('urlStatus');
  const preview = document.getElementById('urlPreview');
  status.className = 'status-msg loading'; status.textContent = 'â³ Website wordt gelezen...';
  preview.classList.remove('visible');
  document.getElementById('fetchBtn').disabled = true;
  try {
    appState.apiKeys.claude = getV('claudeKey');
    const text = await callClaude([{role:'user',content:`Haal de belangrijkste informatie op van deze website voor een subsidiescan van een Nederlandse kunstenaar. URL: ${url}\n\nZoek naar: naam, discipline, vertoningsgeschiedenis, festivals, samenwerkingen, lopende projecten. Wees feitelijk en specifiek. Max 400 woorden.`}], 800);
    websiteContext = text;
    if (text.length < 50) throw new Error('Website niet bereikbaar of geen relevante content');
    status.className = 'status-msg success'; status.textContent = 'âœ“ Website gelezen â€” wordt meegenomen in de analyse.';
    preview.textContent = text.substring(0,300)+'...'; preview.classList.add('visible');
  } catch(e) {
    status.className = 'status-msg error'; status.textContent = 'âš ï¸ Fout: ' + e.message; websiteContext = '';
  }
  document.getElementById('fetchBtn').disabled = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE UPLOAD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleFileUpload(input) {
  const file = input.files[0]; if (!file) return;
  const status  = document.getElementById('fileStatus');
  const preview = document.getElementById('filePreview');
  if (file.size > 20*1024*1024) { status.className='status-msg error'; status.textContent='âš ï¸ Bestand te groot (max 20MB).'; return; }
  status.className='status-msg loading'; status.textContent=`â³ "${file.name}" wordt ingelezen...`;
  preview.classList.remove('visible');
  if (!getV('claudeKey')) { status.className='status-msg error'; status.textContent='âš ï¸ Vul eerst je Claude API key in.'; return; }
  const isPDF = file.type==='application/pdf' || file.name.toLowerCase().endsWith('.pdf');
  if (isPDF) {
    const reader = new FileReader();
    reader.onload = async e => {
      try {
        appState.apiKeys.claude = getV('claudeKey');
        const bytes = new Uint8Array(e.target.result);
        let bin = ''; for(let i=0;i<bytes.byteLength;i++) bin+=String.fromCharCode(bytes[i]);
        const b64 = btoa(bin);
        const text = await callClaude([{role:'user',content:[
          {type:'document',source:{type:'base64',media_type:'application/pdf',data:b64}},
          {type:'text',text:'Geef een uitgebreide samenvatting van alle informatie relevant voor een Nederlandse subsidieaanvraag. Beschrijf: discipline, project, vertoningsgeschiedenis, partners, lopende subsidies, budget. Max 500 woorden.'}
        ]}], 1000);
        documentContext = text;
        if (!text.trim()) throw new Error('Geen tekst gevonden in PDF');
        status.className='status-msg success'; status.textContent=`âœ“ "${file.name}" ingelezen.`;
        preview.textContent=text.substring(0,400)+'...'; preview.classList.add('visible');
      } catch(err) { status.className='status-msg error'; status.textContent=`âš ï¸ PDF fout: ${err.message}`; }
    };
    reader.readAsArrayBuffer(file);
  } else {
    const reader = new FileReader();
    reader.onload = e => {
      documentContext = e.target.result.substring(0,8000);
      status.className='status-msg success'; status.textContent=`âœ“ "${file.name}" ingelezen.`;
      preview.textContent=documentContext.substring(0,300)+'...'; preview.classList.add('visible');
    };
    reader.readAsText(file,'UTF-8');
  }
}

const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); if(e.dataTransfer.files[0]) handleFileUpload({files:e.dataTransfer.files}); });

function togglePaste() { document.getElementById('pasteArea').classList.toggle('visible'); }
function savePastedText() {
  const text = getV('pasteText'); if (!text) return;
  documentContext = text.substring(0,8000);
  const s = document.getElementById('fileStatus');
  s.className='status-msg success'; s.textContent='âœ“ Tekst opgeslagen als context.';
  const p = document.getElementById('filePreview');
  p.textContent=documentContext.substring(0,300)+(documentContext.length>300?'...':''); p.classList.add('visible');
  document.getElementById('pasteArea').classList.remove('visible');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAG GROUPS â€” init
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.tag-group').forEach(group => {
  const single = group.dataset.single === 'true';
  group.querySelectorAll('.tag').forEach(tag => {
    tag.addEventListener('click', () => {
      if (single) group.querySelectorAll('.tag.selected').forEach(t => { if(t!==tag) t.classList.remove('selected'); });
      tag.classList.toggle('selected');
      updateCta();
    });
  });
});
document.querySelectorAll('input[type="text"],input[type="url"],textarea').forEach(el => {
  el.addEventListener('input', updateCta);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA COLLECTION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function collectProject() {
  const typeProject = [...getSelected('typeArtTags'), ...getSelected('typePartTags')];
  const alleOntvangen = [
    ...getSelected('ontvangenTags'),
    ...(getV('ontvangenAndere') ? getV('ontvangenAndere').split(',').map(s=>s.trim()).filter(Boolean) : [])
  ];
  return {
    naam:               getV('naam'),
    rechtsvorm:         getSelected('rechtsVormTags'),
    disciplines:        getSelected('disciplineTags'),
    carriereFase:       getSelected('faseTags'),
    regio:              getV('regio'),
    achtergrond:        getV('achtergrond'),
    projectOmschrijving:getV('projectOmschrijving'),
    projectFase:        getSelected('faseProjTags'),
    locatie:            getSelected('locatieTags'),
    doel:               getSelected('doelTags'),
    typeProject,
    sociaal:            getSelected('sociaalTags'),
    bedrag:             getSelected('bedragTags'),
    alleOntvangen,
    websiteContext,
    documentContext
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SERP API â€” improved queries
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CRAWL_URL_PRIORITY = ['richtlijn','wie-kan-indienen','aanvraagvoorwaarden','uitsluitingscrit','projectaanvraag','individuele-maker','instelling','voorwaarden','subsidie','regeling','aanvragen','criteria','opengesteld','deadline','pdf'];

function isRelevantUrl(item) {
  const url = (item.url || '').toLowerCase();
  return CRAWL_URL_PRIORITY.some(kw => url.includes(kw));
}
function isPdf(item) {
  const url = (item.url || '').toLowerCase();
  const ct  = (item.contentType || '').toLowerCase();
  return url.includes('.pdf') || ct.includes('pdf');
}
function urlPriority(item) {
  const url = (item.url || '').toLowerCase();
  for (let i = 0; i < CRAWL_URL_PRIORITY.length; i++) {
    if (url.includes(CRAWL_URL_PRIORITY[i])) return i;
  }
  return 99;
}

async function searchWithSerp(domain) {
  const queries = [
    `site:${domain} richtlijnen`,
    `site:${domain} wie kan indienen`,
    `site:${domain} aanvraagvoorwaarden`,
    `site:${domain} uitsluitingscriteria`,
    `site:${domain} projectaanvraag`,
    `site:${domain} individuele makers`,
    `site:${domain} instellingen`
  ];
  const urls = new Map(); // url â†’ snippet
  for (const q of queries) {
    try {
      const resp = await fetch(
        `https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(q)}&api_key=${appState.apiKeys.serp}&num=8`
      );
      if (!resp.ok) continue;
      const data = await resp.json();
      (data.organic_results || []).forEach(r => {
        if (r.link && r.link.toLowerCase().includes(domain))
          urls.set(r.link, r.snippet || '');
      });
    } catch(e) { /* continue */ }
  }
  return Array.from(urls.keys()).slice(0, 20);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLAUDE PROMPT â€” improved schema
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildExtractionPrompt(bundle, sourceUrl) {
  return `Je bent een subsidie-analist gespecialiseerd in Nederlandse kunst- en cultuurfondsen.
Gebruik UITSLUITEND de aangeleverde bronnen. Verzin NIETS.
Als iets niet expliciet staat: schrijf "ONZEKER â€“ handmatig controleren".

DOEL: Extraheer ELKE individuele regeling met maximale focus op:
1. Doelgroep en toegestane aanvragers (individu? instelling? stichting? zzp?)
2. Uitsluitingscriteria (KRITIEK â€” zoek expliciet naar: "niet voor", "uitgesloten", "alleen voor", "vereist KvK", "geen individuen", "geen zzp")
3. Openstelling en deadline (zoek: "opent", "sluit", "deadline", "indienen voor", "aanvraagperiode")
4. Bedragen (zoek: â‚¬ bedragen, "maximaal", "minimum", "budget per aanvraag" â€” NIET totaalbudget fonds)
5. Projectfase (zoek: "onderzoek", "productie", "presentatie", "talentontwikkeling")

EXTRACTIEREGELS:
- toegestane_aanvragers: lijst van wie WEL kan aanvragen
- uitgesloten_aanvragers: lijst van wie NIET kan aanvragen (ALTIJD invullen als info beschikbaar)
- Als een pagina zegt "alleen voor instellingen": zet individuen in uitgesloten_aanvragers
- Als een pagina zegt "ook individuele kunstenaars": zet in toegestane_aanvragers
- Als totaalbudget zichtbaar is (bijv. "â‚¬ 650.000 budget tijdvak"): zet dit NIET als max_bedrag
- Geef elke regeling een apart object â€” geen samenvoegingen

Geef UITSLUITEND JSON â€” begin met { eindig met }.

JSON SCHEMA:
{
  "fonds_naam": "string",
  "fonds_url": "string",
  "fonds_omschrijving": "string (max 2 zinnen)",
  "regelingen": [
    {
      "naam": "string",
      "doelgroep": "string (beschrijf de primaire doelgroep kort)",
      "toegestane_aanvragers": ["string"],
      "uitgesloten_aanvragers": ["string"],
      "openstelling": "string",
      "deadline": "string",
      "min_bedrag": "string",
      "max_bedrag": "string",
      "discipline": "string",
      "projectfase": "string",
      "harde_criteria": ["string"],
      "uitsluitingscriteria": ["string"],
      "evidence": [
        { "url": "string", "quote": "string (max 20 woorden)" }
      ]
    }
  ]
}

BRONNEN (${bundle.length} tekens):
${bundle}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATCH ENGINE â€” regeling-level scoring with hard exclusions
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EXCLUSION_PATTERNS = {
  individu: [
    /niet voor individu/i, /geen individu/i, /geen zzp/i, /niet voor zzp/i,
    /alleen.*instelling/i, /uitsluitend.*instelling/i, /alleen voor.*stichting/i,
    /geen.*individuele/i, /niet.*individuele maker/i, /geen eenmanszak/i
  ],
  stichting: [
    /niet voor stichting/i, /geen stichting/i
  ],
  bv: [
    /niet voor commerci/i, /geen commerci/i, /geen bv/i, /geen nv/i
  ],
  student: [
    /geen student/i, /niet voor student/i
  ]
};

const INCLUDE_PATTERNS = {
  individu: [
    /individuele kunstenaar/i, /zzp/i, /zelfstandig/i, /individuele maker/i,
    /ook.*individu/i, /ook.*zzp/i
  ]
};

function detectExclusions(regeling, project) {
  const exclusions = [];
  const rvLower = project.rechtsvorm.map(r => r.toLowerCase());
  const isIndividu = rvLower.some(r => r.includes('individu') || r.includes('zzp') || r.includes('student'));
  const isStichting = rvLower.some(r => r.includes('stichting'));
  const isVer = rvLower.some(r => r.includes('vereniging'));
  const isBv = rvLower.some(r => r.includes('bv') || r.includes('nv') || r.includes('commerci'));

  const allText = [
    regeling.doelgroep || '',
    ...( regeling.toegestane_aanvragers || []),
    ...( regeling.uitgesloten_aanvragers || []),
    ...( regeling.uitsluitingscriteria || []),
    ...( regeling.harde_criteria || [])
  ].join(' ').toLowerCase();

  const uitgeslotenText = [
    ...( regeling.uitgesloten_aanvragers || []),
    ...( regeling.uitsluitingscriteria || [])
  ].join(' ');

  // Hard: rechtsvorm excluded
  if (isIndividu) {
    if (EXCLUSION_PATTERNS.individu.some(p => p.test(uitgeslotenText) || p.test(allText))) {
      // But check if there's an explicit include override
      const hasExplicitInclude = INCLUDE_PATTERNS.individu.some(p => p.test(regeling.doelgroep || '') || p.test((regeling.toegestane_aanvragers||[]).join(' ')));
      if (!hasExplicitInclude) {
        exclusions.push(`Aanvrager is individu/ZZP â€” regeling richt zich op instellingen of sluit individuen uit`);
      }
    }
    // Check toegestane_aanvragers: if it only mentions instellingen
    const toegestane = (regeling.toegestane_aanvragers || []).join(' ').toLowerCase();
    if (toegestane.length > 10 && !toegestane.includes('individu') && !toegestane.includes('zzp') && !toegestane.includes('zelfstandig') && !toegestane.includes('maker') &&
        (toegestane.includes('instelling') || toegestane.includes('stichting') || toegestane.includes('organisatie'))) {
      if (!exclusions.length) {
        exclusions.push(`Toegestane aanvragers zijn alleen instellingen/stichtingen â€” individuen niet vermeld`);
      }
    }
  }
  if (isStichting) {
    if (EXCLUSION_PATTERNS.stichting.some(p => p.test(uitgeslotenText))) {
      exclusions.push(`Aanvrager is stichting â€” regeling sluit stichtingen uit`);
    }
  }
  if (isBv) {
    if (EXCLUSION_PATTERNS.bv.some(p => p.test(uitgeslotenText))) {
      exclusions.push(`Aanvrager is BV/NV â€” regeling sluit commerciÃ«le organisaties uit`);
    }
  }

  // Hard: regio mismatch
  const regio = (project.regio || '').toLowerCase();
  const regioClaims = (regeling.harde_criteria || []).join(' ').toLowerCase();
  if (regio && regioClaims.length > 0) {
    const regioMatches = ['amsterdam','rotterdam','den haag','utrecht','groningen','eindhoven','arnhem','tilburg'];
    const reqRegio = regioMatches.find(r => regioClaims.includes(r));
    if (reqRegio && !regio.includes(reqRegio)) {
      exclusions.push(`Regeling vereist woonplaats in ${reqRegio} â€” project is gevestigd in ${project.regio}`);
    }
  }

  // Hard: projectfase mismatch
  const projFase = project.projectFase.join(' ').toLowerCase();
  const regelingFase = (regeling.projectfase || '').toLowerCase();
  if (projFase && regelingFase && regelingFase !== 'onzeker â€“ handmatig controleren') {
    const faseConflicts = [
      { proj: 'presentatie', noMatch: ['onderzoek', 'voorproductie'] },
      { proj: 'onderzoek',   noMatch: ['presentatie', 'productie'] }
    ];
    for (const fc of faseConflicts) {
      if (projFase.includes(fc.proj) && fc.noMatch.some(nm => regelingFase.includes(nm) && !regelingFase.includes('en'))) {
        // light exclusion only if very explicit
        if (regelingFase.includes('uitsluitend') || regelingFase.includes('alleen')) {
          exclusions.push(`Regeling ondersteunt uitsluitend ${regelingFase} â€” project is in fase ${project.projectFase.join(', ')}`);
        }
      }
    }
  }

  // Hard: bedrag out of range
  const bedragTag = project.bedrag?.[0] || '';
  const maxBedragStr = regeling.max_bedrag || '';
  if (maxBedragStr && !maxBedragStr.includes('ONZEKER') && bedragTag === 'â‚¬15.000+') {
    const maxMatch = maxBedragStr.replace(/\./g,'').match(/(\d+)/);
    if (maxMatch) {
      const maxBedrag = parseInt(maxMatch[1]);
      if (maxBedrag < 15000) {
        exclusions.push(`Gevraagd bedrag (â‚¬15.000+) overschrijdt het maximum van de regeling (${regeling.max_bedrag})`);
      }
    }
  }

  return exclusions;
}

function computeMatchScore(regeling, project) {
  let score = 50; // baseline

  // Discipline match
  const disciplineText = (regeling.discipline || '').toLowerCase();
  const projectDiscs = project.disciplines.map(d => d.toLowerCase());
  if (projectDiscs.some(d => disciplineText.includes(d))) score += 20;
  else if (disciplineText.includes('meerdere') || disciplineText.includes('breed') || disciplineText.includes('interdisciplinair')) score += 10;
  else score -= 15;

  // Doelgroep match
  const doelgroepText = (regeling.doelgroep || '').toLowerCase();
  const rechtsVorm = project.rechtsvorm.map(r => r.toLowerCase()).join(' ');
  if (doelgroepText.includes('individu') || doelgroepText.includes('zzp') || doelgroepText.includes('maker')) {
    if (rechtsVorm.includes('individu') || rechtsVorm.includes('zzp')) score += 15;
  }
  if (doelgroepText.includes('instelling') || doelgroepText.includes('stichting')) {
    if (rechtsVorm.includes('stichting') || rechtsVorm.includes('vereniging')) score += 10;
  }

  // Projectfase match
  const regelingFase = (regeling.projectfase || '').toLowerCase();
  const projFase = project.projectFase.join(' ').toLowerCase();
  if (projFase && regelingFase && !regelingFase.includes('onzeker')) {
    const faseWords = ['onderzoek','productie','presentatie','talentontwikkeling','publicatie'];
    const matchFase = faseWords.some(f => projFase.includes(f) && regelingFase.includes(f));
    if (matchFase) score += 10;
  }

  // Has deadline/open info â†’ bonus (it's current)
  const deadline = (regeling.deadline || '').toLowerCase();
  if (deadline && !deadline.includes('onzeker') && !deadline.includes('gesloten')) score += 5;
  if (deadline.toLowerCase().includes('gesloten')) score -= 20;

  // Bedrag match
  const bedragTag = project.bedrag?.[0] || '';
  const maxBedragStr = regeling.max_bedrag || '';
  if (bedragTag && maxBedragStr && !maxBedragStr.includes('ONZEKER')) {
    const maxMatch = maxBedragStr.replace(/\./g,'').match(/(\d+)/);
    if (maxMatch) {
      const maxBedrag = parseInt(maxMatch[1]);
      const bedrParsed = {'onder â‚¬1.000':500,'â‚¬1.000â€“â‚¬5.000':3000,'â‚¬5.000â€“â‚¬15.000':10000,'â‚¬15.000+':20000}[bedragTag];
      if (bedrParsed && maxBedrag >= bedrParsed) score += 5;
      else if (bedrParsed && maxBedrag < bedrParsed) score -= 10;
    }
  }

  // Sociaal match
  const sociaal = project.sociaal.join(' ').toLowerCase();
  const allRegelingText = JSON.stringify(regeling).toLowerCase();
  if (sociaal && allRegelingText.includes(sociaal.split('/')[0])) score += 10;

  // Cultural background
  if (project.achtergrond && allRegelingText.includes('culturele achtergrond')) score += 8;

  return Math.max(0, Math.min(100, Math.round(score)));
}

function runMatchEngine(regelingen, project) {
  return regelingen.map(reg => {
    const exclusions = detectExclusions(reg, project);
    const isExcluded = exclusions.length > 0;
    const score = isExcluded ? 0 : computeMatchScore(reg, project);
    const label = isExcluded ? 'UITGESLOTEN'
                : score >= 72 ? 'HOOG'
                : score >= 48 ? 'MIDDEL'
                : 'LAAG';
    return { ...reg, is_uitgesloten: isExcluded, uitsluitingsredenen: exclusions, match_score: score, match_label: label };
  }).sort((a, b) => {
    const order = {HOOG:0, MIDDEL:1, LAAG:2, UITGESLOTEN:3};
    if (order[a.match_label] !== order[b.match_label]) return order[a.match_label] - order[b.match_label];
    return b.match_score - a.match_score;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN FLOW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startAnalysis() {
  // Collect state
  appState.apiKeys = { claude: getV('claudeKey'), apify: getV('apifyToken'), serp: getV('serpKey') };
  appState.project = collectProject();
  const fondsUrl  = getV('fondsUrl');
  const maxDepth  = parseInt(getV('crawlDepth')) || 3;
  const maxPages  = parseInt(getV('crawlPages')) || 30;

  // UI transition
  document.getElementById('formScreen').style.display = 'none';
  document.getElementById('progressScreen').classList.add('active');
  setProgressStep(2);

  try {
    const domain = new URL(fondsUrl).hostname;

    /* â”€â”€ Step 1: SerpAPI â”€â”€ */
    setStep(1, 'active', 'Targeted queries uitvoeren...');
    log('SerpAPI: 7 gerichte queries starten...');
    const serpUrls = await searchWithSerp(domain);
    log(`${serpUrls.length} relevante URLs gevonden`, 'ok');
    setStep(1, 'done', `${serpUrls.length} URLs gevonden`);

    /* â”€â”€ Step 2: Apify crawl â”€â”€ */
    setStep(2, 'active', 'Apify actor starten...');
    log(`Crawl starten: ${fondsUrl}`);
    const runResp = await fetch(
      `https://api.apify.com/v2/acts/thu1710~my-actor/runs?token=${appState.apiKeys.apify}`,
      {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          startUrls: serpUrls.length > 0
            ? serpUrls.map(u => ({url:u}))
            : [{url: fondsUrl}],
          maxCrawlDepth: maxDepth,
          maxCrawledPages: maxPages
        })
      }
    );
    if (!runResp.ok) throw new Error(`Apify start mislukt (${runResp.status}): ${await runResp.text()}`);
    const runData = await runResp.json();
    const runId = runData.data?.id;
    const datasetId = runData.data?.defaultDatasetId;
    if (!runId) throw new Error('Geen run ID van Apify ontvangen');
    log(`Run gestart â€” ID: ${runId}`, 'ok');

    let status = 'RUNNING', pollCount = 0;
    while (['RUNNING','READY'].includes(status)) {
      await sleep(5000);
      pollCount++;
      const pd = await (await fetch(`https://api.apify.com/v2/actor-runs/${runId}?token=${appState.apiKeys.apify}`)).json();
      status = pd.data?.status || 'UNKNOWN';
      const pages = pd.data?.stats?.httpRequestsFinished ?? '?';
      setStep(2, 'active', `Status: ${status} â€” ${pages} pagina's (poll ${pollCount})`);
      log(`Poll ${pollCount}: ${status} â€” ${pages} pagina's`);
      if (pollCount >= 72) throw new Error('Timeout: crawl > 6 minuten');
    }
    if (status !== 'SUCCEEDED') throw new Error(`Crawl beÃ«indigd met: ${status}`);
    setStep(2, 'done', `Succesvol (${pollCount * 5}s)`);
    setProgressStep(3);

    /* â”€â”€ Step 3: Dataset â”€â”€ */
    setStep(3, 'active', 'Dataset ophalen...');
    const items = await (await fetch(`https://api.apify.com/v2/datasets/${datasetId}/items?token=${appState.apiKeys.apify}&format=json&limit=200&clean=true`)).json();
    if (!Array.isArray(items)) throw new Error('Onverwacht dataset formaat');
    log(`${items.length} items ontvangen`);

    // Priority sorting: relevant + PDF first
    const allSorted = [...items].sort((a, b) => {
      const ap = isPdf(a) ? -5 : urlPriority(a);
      const bp = isPdf(b) ? -5 : urlPriority(b);
      return ap - bp;
    });
    const priorityPages = allSorted.filter(i => !isPdf(i) && isRelevantUrl(i)).slice(0, 12);
    const pdfItems      = allSorted.filter(i => isPdf(i)).slice(0, 6);
    const otherPages    = allSorted.filter(i => !isPdf(i) && !isRelevantUrl(i)).slice(0, 4);
    const selected      = [...priorityPages, ...pdfItems, ...otherPages];
    const final         = selected.length > 0 ? selected : allSorted.slice(0, 10);

    setStep(3, 'done', `${priorityPages.length} prio-pagina's + ${pdfItems.length} PDF's + ${otherPages.length} overige`);
    log(`Gefilterd: ${priorityPages.length} prio + ${pdfItems.length} PDF + ${otherPages.length} overig`, 'ok');

    /* â”€â”€ Step 4: Claude extraction â”€â”€ */
    setStep(4, 'active', 'Prompt opbouwen...');
    setProgressStep(3);
    const MAX_CHARS = 9000;
    const bundle = final.map((item, i) => {
      const raw   = item.markdown || item.text || item.pageContent || item.html || '';
      const plain = stripHtml(raw);
      return `--- BRON ${i+1}: ${item.url} ---\n${plain.substring(0, MAX_CHARS)}`;
    }).join('\n\n');
    log(`Totale bundle: ~${Math.round(bundle.length/1000)}k tekens`);
    setStep(4, 'active', 'Claude aanroepen (verbeterd schema)...');
    const rawText = await callClaude([{role:'user', content: buildExtractionPrompt(bundle, fondsUrl)}], 4096);
    let crawlData;
    try {
      const m = rawText.match(/```json\s*([\s\S]*?)\s*```/) || rawText.match(/(\{[\s\S]*\})/);
      crawlData = JSON.parse(m ? m[1] : rawText);
    } catch(e) { throw new Error('JSON parse mislukt: ' + e.message + '\n' + rawText.substring(0,200)); }
    log(`Extractie klaar â€” ${crawlData.regelingen?.length || 0} regelingen`, 'ok');
    setStep(4, 'done', `${crawlData.regelingen?.length || 0} regelingen geÃ«xtraheerd`);
    appState.crawlData = crawlData;

    /* â”€â”€ Step 5: Match engine â”€â”€ */
    setStep(5, 'active', 'Uitsluitingen controleren & scores berekenen...');
    setProgressStep(4);
    const regelingen = crawlData.regelingen || [];
    const matched    = runMatchEngine(regelingen, appState.project);
    appState.matchResults = matched;

    const nUitg  = matched.filter(r => r.match_label === 'UITGESLOTEN').length;
    const nHoog  = matched.filter(r => r.match_label === 'HOOG').length;
    const nMiddel= matched.filter(r => r.match_label === 'MIDDEL').length;
    setStep(5, 'done', `${nHoog} HOOG, ${nMiddel} MIDDEL, ${nUitg} UITGESLOTEN`);
    log(`Match engine klaar: ${nHoog}Ã—HOOG, ${nMiddel}Ã—MIDDEL, ${nUitg}Ã—UITGESLOTEN`, 'ok');

    await sleep(350);

    // Show results
    document.getElementById('progressScreen').classList.remove('active');
    renderResults(crawlData, matched);
    document.getElementById('resultsScreen').classList.add('active');

  } catch(err) {
    log(`FOUT: ${err.message}`, 'err');
    [1,2,3,4,5].forEach(n => {
      if (document.getElementById(`st${n}`)?.classList.contains('active'))
        setStep(n, 'error', err.message.substring(0,80));
    });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDERING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResults(data, matches) {
  const now = new Date().toLocaleDateString('nl-NL',{day:'numeric',month:'long',year:'numeric'});
  const proj = appState.project;
  document.getElementById('resMeta').textContent =
    `${now} â€” ${data.fonds_naam||'Fonds'} Ã— ${proj.naam || proj.disciplines.join(', ') || 'project'} â€” ${matches.length} regelingen`;

  // Summary bar
  const nHoog   = matches.filter(r => r.match_label === 'HOOG').length;
  const nMiddel = matches.filter(r => r.match_label === 'MIDDEL').length;
  const nLaag   = matches.filter(r => r.match_label === 'LAAG').length;
  const nUitg   = matches.filter(r => r.match_label === 'UITGESLOTEN').length;
  document.getElementById('summaryBar').innerHTML = `
    <div class="sb-stat green"><div class="ss-n">${nHoog}</div><div class="ss-l">Hoog match</div></div>
    <div class="sb-stat orange"><div class="ss-n">${nMiddel}</div><div class="ss-l">Middel match</div></div>
    <div class="sb-stat"><div class="ss-n">${nLaag}</div><div class="ss-l">Laag match</div></div>
    <div class="sb-stat red"><div class="ss-n">${nUitg}</div><div class="ss-l">Uitgesloten</div></div>
    <div class="sb-stat"><div class="ss-n">${matches.length}</div><div class="ss-l">Totaal</div></div>`;

  // Fonds banner
  document.getElementById('fondsBanner').innerHTML = `
    <div class="fonds-banner">
      <div class="fb-icon">ğŸ›</div>
      <div class="fb-text">
        <h3>${esc(data.fonds_naam || 'Onbekend fonds')}</h3>
        <p>${esc(data.fonds_omschrijving || '')}</p>
      </div>
      <div class="fb-url"><a href="${esc(data.fonds_url||'')}" target="_blank" rel="noopener">${esc(data.fonds_url||'')} â†—</a></div>
    </div>`;

  // Match cards
  if (!matches.length) {
    document.getElementById('matchCards').innerHTML = `<div style="text-align:center;padding:2.5rem;color:var(--muted);">ğŸ” Geen regelingen gevonden.</div>`;
    return;
  }
  document.getElementById('matchCards').innerHTML = matches.map((r, i) => renderMatchCard(r, i)).join('');
  // Open first non-excluded card
  const firstOpen = matches.findIndex(r => r.match_label !== 'UITGESLOTEN');
  toggleCard(firstOpen >= 0 ? firstOpen : 0);

  // Raw JSON
  document.getElementById('rawJson').textContent = JSON.stringify({ crawl: appState.crawlData, matches: appState.matchResults }, null, 2);
}

function scoreClass(label) {
  return {HOOG:'s-hoog', MIDDEL:'s-middel', LAAG:'s-laag', UITGESLOTEN:'s-uitg'}[label] || 's-laag';
}

function renderMatchCard(r, i) {
  const sc = scoreClass(r.match_label);
  const fillClass = r.match_score >= 72 ? '' : r.match_score >= 48 ? 'mid' : 'low';
  const toegestane = (r.toegestane_aanvragers||[]).filter(Boolean);
  const uitgesloten = (r.uitgesloten_aanvragers||[]).filter(Boolean);

  const criteria = (r.harde_criteria||[]).map(c =>
    `<div class="ci soft"><span class="ci-dot">â†’</span><span>${markUncertain(esc(c))}</span></div>`).join('');
  const excl = (r.uitsluitingscriteria||[]).map(c =>
    `<div class="ci hard"><span class="ci-dot">âœ•</span><span>${markUncertain(esc(c))}</span></div>`).join('');
  const evidence = (r.evidence||[]).map(ev =>
    `<div class="ev-item"><a class="ev-url" href="${esc(ev.url)}" target="_blank" rel="noopener">${esc(ev.url)}</a><div class="ev-quote">"${markUncertain(esc(ev.quote||''))}"</div></div>`).join('');

  const doelgroepTags = toegestane.map(t =>
    `<span class="dt-tag dt-ok">âœ“ ${esc(t)}</span>`).join('') +
    uitgesloten.map(t =>
    `<span class="dt-tag dt-warn">âœ• ${esc(t)}</span>`).join('');

  return `
  <div class="rc">
    <div class="rc-head" id="rch${i}" onclick="toggleCard(${i})">
      <div style="flex:1;min-width:0;">
        <div class="rc-name">${esc(r.naam||'Onbekende regeling')}</div>
        ${r.doelgroep ? `<div style="font-size:.73rem;color:var(--muted);margin-top:.08rem;">${esc(r.doelgroep)}</div>` : ''}
      </div>
      <span class="score-badge ${sc}">${r.match_label}</span>
      ${r.match_label !== 'UITGESLOTEN' ? `<span style="font-size:.72rem;font-weight:700;color:var(--muted);flex-shrink:0;">${r.match_score}%</span>` : ''}
      <span class="chevron" id="rcc${i}">â–¾</span>
    </div>
    <div class="rc-body" id="rcb${i}">
      ${r.is_uitgesloten ? `
        <div class="excl-banner">
          <div class="eb-label">â›” Uitgesloten â€” redenen:</div>
          <ul>${(r.uitsluitingsredenen||[]).map(e=>`<li>${esc(e)}</li>`).join('')}</ul>
        </div>` : ''}
      <div class="dg">
        <div class="dc hl"><div class="dc-lbl">Openstelling</div><div class="dc-val">${markUncertain(esc(r.openstelling||'â€”'))}</div></div>
        <div class="dc hl"><div class="dc-lbl">Deadline</div><div class="dc-val">${markUncertain(esc(r.deadline||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Min. bedrag</div><div class="dc-val">${markUncertain(esc(r.min_bedrag||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Max. bedrag</div><div class="dc-val">${markUncertain(esc(r.max_bedrag||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Discipline</div><div class="dc-val">${markUncertain(esc(r.discipline||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Projectfase</div><div class="dc-val">${markUncertain(esc(r.projectfase||'â€”'))}</div></div>
        ${r.doelgroep ? `<div class="dc" style="grid-column:1/-1;"><div class="dc-lbl">Doelgroep</div><div class="dc-val">${markUncertain(esc(r.doelgroep))} ${doelgroepTags ? '<br>'+doelgroepTags : ''}</div></div>` : ''}
      </div>
      ${!r.is_uitgesloten ? `
        <div class="score-bar-wrap">
          <div class="sb-label"><span>Matchscore</span><strong>${r.match_score}%</strong></div>
          <div class="score-bar"><div class="score-fill ${fillClass}" style="width:${r.match_score}%;"></div></div>
        </div>` : ''}
      ${criteria ? `<div class="crit-sec" style="margin-top:.85rem;"><h4>Harde criteria</h4><div class="crit-list">${criteria}</div></div>` : ''}
      ${excl ? `<div class="crit-sec"><h4>âš ï¸ Uitsluitingscriteria</h4><div class="crit-list">${excl}</div></div>` : ''}
      ${evidence ? `<div style="margin-top:.75rem;"><div style="font-size:.7rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.4rem;">Bronnen</div>${evidence}</div>` : ''}
    </div>
  </div>`;
}

function toggleCard(i) {
  const body = document.getElementById(`rcb${i}`);
  const chev = document.getElementById(`rcc${i}`);
  const head = document.getElementById(`rch${i}`);
  if (!body) return;
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (chev) chev.classList.toggle('open', !isOpen);
  if (head) head.classList.toggle('open', !isOpen);
}

function toggleRaw() {
  const raw = document.getElementById('rawJson');
  const tog = document.getElementById('rawToggle');
  const open = raw.style.display === 'block';
  raw.style.display = open ? 'none' : 'block';
  tog.textContent = open ? 'â–¸ Bekijk ruwe JSON' : 'â–¾ Verberg ruwe JSON';
}

function copyJson() {
  if (!appState.matchResults) return;
  const data = { crawl: appState.crawlData, matches: appState.matchResults };
  navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
    const b = event.target; b.textContent = 'âœ“ Gekopieerd!';
    setTimeout(() => b.textContent = 'ğŸ“‹ JSON kopiÃ«ren', 2000);
  });
}

function resetAll() {
  appState.crawlData = appState.matchResults = appState.project = null;
  websiteContext = documentContext = '';
  document.getElementById('resultsScreen').classList.remove('active');
  document.getElementById('progressScreen').classList.remove('active');
  document.getElementById('formScreen').style.display = 'block';
  document.getElementById('logBox').innerHTML = '';
  [1,2,3,4,5].forEach(n => { const el=document.getElementById(`st${n}`); if(el){el.className='step';} });
  setProgressStep(1);
  window.scrollTo(0,0);
}

/* â”€â”€ Init â”€â”€ */
updateCta();
setProgressStep(1);
</script>
</body>
</html>
