<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsidiescan v4 ‚Äî Anh Thu Pham</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f4f8;
    --primary: #4a3fa5;
    --primary-light: #7b72d4;
    --accent: #c9a7e8;
    --accent2: #a8d8d0;
    --text: #1a1830;
    --muted: #7a7899;
    --border: #e4e2f0;
    --gradient: linear-gradient(135deg, #e8e4f8 0%, #f0e8f8 40%, #e4f0f8 100%);
    --warn: #f0e6d3;
    --warn-border: #e0c89a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg); color: var(--text); min-height: 100vh;
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(74,63,165,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(201,167,232,0.12) 0%, transparent 60%);
  }
  header {
    padding: 1.5rem 2.5rem; display: flex; align-items: center; gap: 1rem;
    border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.7);
    backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 10;
  }
  .logo-mark {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-family: 'DM Serif Display', serif; color: white; font-size: 1.1rem; flex-shrink: 0;
  }
  .header-text h1 { font-family: 'DM Serif Display', serif; font-size: 1.1rem; color: var(--primary); }
  .header-text p { font-size: 0.72rem; color: var(--muted); font-weight: 300; }
  .badge { background: var(--primary); color: white; font-size: 0.6rem; padding: 0.15rem 0.5rem; border-radius: 100px; font-weight: 600; letter-spacing: 0.05em; margin-left: 0.5rem; vertical-align: middle; }
  .main { max-width: 800px; margin: 0 auto; padding: 2.5rem 1.5rem 5rem; }
  .intro-card {
    background: var(--gradient); border: 1px solid var(--border); border-radius: 20px;
    padding: 2rem 2.5rem; margin-bottom: 2rem; position: relative; overflow: hidden;
  }
  .intro-card::after { content: '‚ú¶'; position: absolute; right: 2rem; top: 1.5rem; font-size: 2rem; color: var(--primary-light); opacity: 0.25; }
  .intro-card h2 { font-family: 'DM Serif Display', serif; font-size: 1.4rem; color: var(--primary); margin-bottom: 0.4rem; }
  .intro-card p { color: var(--muted); font-size: 0.88rem; line-height: 1.6; }
  .feature-pills { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 1rem; }
  .pill { background: white; border: 1px solid var(--border); border-radius: 100px; padding: 0.3rem 0.8rem; font-size: 0.75rem; color: var(--primary); font-weight: 500; }
  .form-card {
    background: white; border: 1px solid var(--border); border-radius: 20px;
    padding: 2rem 2.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 20px rgba(74,63,165,0.05);
  }
  .section-title {
    font-family: 'DM Serif Display', serif; font-size: 1.05rem; color: var(--primary);
    margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.6rem;
  }
  .num {
    width: 26px; height: 26px; background: var(--primary); color: white;
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
    font-size: 0.72rem; font-family: 'DM Sans', sans-serif; font-weight: 600; flex-shrink: 0;
  }
  .field { margin-bottom: 1.25rem; }
  label { display: block; font-size: 0.82rem; font-weight: 600; color: var(--text); margin-bottom: 0.4rem; }
  .sublabel { font-size: 0.74rem; color: var(--muted); font-weight: 400; margin-left: 0.2rem; }
  .field-note { font-size: 0.78rem; color: var(--muted); line-height: 1.5; margin-bottom: 0.5rem; }
  input[type="text"], textarea, select {
    width: 100%; padding: 0.75rem 1rem; border: 1.5px solid var(--border); border-radius: 12px;
    font-family: 'DM Sans', sans-serif; font-size: 0.88rem; color: var(--text);
    background: #fafafa; transition: border-color 0.2s, box-shadow 0.2s; outline: none; -webkit-appearance: none;
  }
  input:focus, textarea:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(74,63,165,0.08); background: white; }
  textarea { resize: vertical; min-height: 90px; line-height: 1.5; }
  .tag-group { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.4rem; }
  .tag {
    padding: 0.38rem 0.8rem; border: 1.5px solid var(--border); border-radius: 100px;
    font-size: 0.78rem; cursor: pointer; transition: all 0.18s; background: #fafafa;
    user-select: none; font-family: 'DM Sans', sans-serif;
  }
  .tag:hover { border-color: var(--primary-light); background: #f0eef8; }
  .tag.selected { background: var(--primary); color: white; border-color: var(--primary); }
  .regio-info {
    display: none; background: #e8f4f0; border: 1px solid #b8ddd4;
    border-radius: 12px; padding: 1rem 1.25rem; margin-top: 0.75rem; font-size: 0.82rem; color: #2a5a50;
  }
  .regio-info.visible { display: block; }
  .regio-info strong { display: block; margin-bottom: 0.3rem; font-size: 0.78rem; }

  /* Upload / document section */
  .upload-zone {
    border: 2px dashed var(--border); border-radius: 14px; padding: 1.5rem;
    text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary-light); background: #f0eef8; }
  .upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-zone .icon { font-size: 1.8rem; margin-bottom: 0.4rem; }
  .upload-zone p { font-size: 0.82rem; color: var(--muted); }
  .upload-zone strong { color: var(--primary); font-size: 0.85rem; }
  .status-msg { margin-top: 0.6rem; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 8px; display: none; }
  .status-msg.success { background: #e8f4f0; color: #2a5a50; display: block; }
  .status-msg.loading { background: #f0eef8; color: var(--primary); display: block; }
  .status-msg.error { background: #fde8e8; color: #8a2020; display: block; }
  .context-preview { background: #f5f4f8; border: 1px solid var(--border); border-radius: 10px; padding: 0.75rem 1rem; margin-top: 0.6rem; font-size: 0.78rem; color: var(--muted); max-height: 100px; overflow-y: auto; display: none; line-height: 1.5; }
  .context-preview.visible { display: block; }
  .or-divider { text-align: center; color: var(--muted); font-size: 0.78rem; margin: 0.75rem 0; position: relative; }
  .or-divider::before, .or-divider::after { content: ''; position: absolute; top: 50%; width: 42%; height: 1px; background: var(--border); }
  .or-divider::before { left: 0; } .or-divider::after { right: 0; }
  .url-row { display: flex; gap: 0.5rem; align-items: center; }
  .url-row input { flex: 1; }
  .url-fetch-btn {
    padding: 0.75rem 1rem; background: var(--primary); color: white; border: none; border-radius: 12px;
    font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0;
  }
  .url-fetch-btn:hover { background: var(--primary-light); }
  .url-fetch-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Paste doc area */
  .paste-toggle { font-size: 0.78rem; color: var(--primary); cursor: pointer; text-decoration: underline; text-underline-offset: 2px; margin-top: 0.5rem; display: inline-block; }
  .paste-area { display: none; margin-top: 0.75rem; }
  .paste-area.visible { display: block; }
  .paste-area textarea { min-height: 120px; font-size: 0.82rem; }
  .paste-save-btn {
    margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none;
    border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer;
  }

  .generate-btn {
    width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white; border: none; border-radius: 14px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
    font-weight: 600; cursor: pointer; transition: all 0.2s; letter-spacing: 0.02em;
    box-shadow: 0 4px 20px rgba(74,63,165,0.25); margin-top: 0.5rem;
  }
  .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(74,63,165,0.35); }
  .generate-btn:active { transform: translateY(0); }
  .loading { display: none; text-align: center; padding: 3rem; background: white; border-radius: 20px; border: 1px solid var(--border); }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-steps { margin-top: 1rem; }
  .loading-step { font-size: 0.8rem; color: var(--muted); padding: 0.3rem 0; transition: color 0.3s; }
  .loading-step.active { color: var(--primary); font-weight: 600; }
  .loading-step.done { color: var(--accent2); }
  .result-card { display: none; background: white; border: 1px solid var(--border); border-radius: 20px; padding: 2.5rem; box-shadow: 0 2px 20px rgba(74,63,165,0.06); }
  .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); gap: 1rem; flex-wrap: wrap; }
  .result-header h2 { font-family: 'DM Serif Display', serif; color: var(--primary); font-size: 1.3rem; }
  .result-header p { font-size: 0.78rem; color: var(--muted); margin-top: 0.2rem; }
  .btn-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .btn-secondary { padding: 0.55rem 1.1rem; border: 1.5px solid var(--border); border-radius: 10px; background: white; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; color: var(--text); transition: all 0.2s; }
  .btn-secondary:hover { border-color: var(--primary-light); background: #f5f3fc; }
  .result-content { line-height: 1.78; font-size: 0.9rem; color: var(--text); }
  .result-content p { margin-bottom: 0.7rem; color: #3a3860; }
  .fonds-card { background: var(--gradient); border: 1px solid var(--border); border-radius: 14px; padding: 1.25rem 1.5rem; margin: 1rem 0; }
  .fonds-card h3 { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--primary); margin-bottom: 0.5rem; }
  .warn-card { background: var(--warn); border: 1px solid var(--warn-border); border-radius: 14px; padding: 1.25rem 1.5rem; margin: 1rem 0; }
  .warn-card h3 { font-size: 0.9rem; color: #8a6020; margin-bottom: 0.4rem; }
  .section-header { font-family: 'DM Serif Display', serif; font-size: 1.15rem; color: var(--primary); margin: 1.5rem 0 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
  .reset-btn { margin-top: 1.5rem; padding: 0.65rem 1.4rem; border: 1.5px solid var(--border); border-radius: 12px; background: white; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; color: var(--muted); transition: all 0.2s; }
  .reset-btn:hover { color: var(--text); border-color: var(--muted); }
  @media (max-width: 600px) {
    .main { padding: 1.5rem 1rem 3rem; }
    .form-card, .result-card { padding: 1.5rem; }
    header { padding: 1rem 1.25rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo-mark">A</div>
  <div class="header-text">
    <h1>Subsidiescan Tool <span class="badge">v4</span></h1>
    <p>Anh Thu Pham ‚Äî Subsidieadviseur voor kunstenaars</p>
  </div>
</header>

<div class="main">
  <div class="intro-card">
    <h2>Subsidiescan ‚ú¶</h2>
    <p>Vul het klantprofiel in. De tool matcht op discipline, rechtsvorm, regio en sociaal thema ‚Äî en zoekt actief naar kleinere stichtingen en gemeentelijke subsidies.</p>
    <div class="feature-pills">
      <span class="pill">üèõÔ∏è Rechtsvorm-filter</span>
      <span class="pill">üìç Regio & gemeentelijk</span>
      <span class="pill">üåê Website lezen</span>
      <span class="pill">üìÑ Document plakken of uploaden</span>
      <span class="pill">üîç Kleinere fondsen</span>
    </div>
  </div>

  <div id="formSection">

    <!-- API KEY -->
    <div class="form-card" style="border-color: #c9a7e8; background: linear-gradient(135deg, #faf8ff, #f5f0ff);">
      <div class="section-title" style="margin-bottom:0.75rem;"><span class="num" style="background:var(--accent);">üîë</span> Jouw Anthropic API Key</div>
      <p class="field-note" style="margin-bottom:0.75rem;">De tool heeft een API key nodig om Claude aan te roepen. Je key wordt <strong>alleen lokaal gebruikt</strong> en nooit opgeslagen. Haal je key op via <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--primary);">console.anthropic.com</a>.</p>
      <input type="password" id="apiKey" placeholder="sk-ant-api03-..." style="font-family:monospace; font-size:0.82rem;">
    </div>

    <!-- BLOK 1: Klantprofiel -->
    <div class="form-card">
      <div class="section-title"><span class="num">1</span> Klantprofiel</div>

      <div class="field">
        <label>Naam <span class="sublabel">(optioneel)</span></label>
        <input type="text" id="naam" placeholder="bijv. naam van de kunstenaar">
      </div>

      <div class="field">
        <label>Rechtsvorm <span class="sublabel">‚Äî sommige fondsen financieren alleen individuen, andere alleen organisaties</span></label>
        <div class="tag-group" id="rechtsVormTags">
          <span class="tag" data-val="individuele kunstenaar (zzp)">Individuele kunstenaar / ZZP</span>
          <span class="tag" data-val="kunstenaarscollectief (informeel)">Kunstenaarscollectief (informeel)</span>
          <span class="tag" data-val="stichting">Stichting</span>
          <span class="tag" data-val="vereniging">Vereniging</span>
          <span class="tag" data-val="bv/nv (commercieel)">BV / NV (commercieel)</span>
          <span class="tag" data-val="student (geen kvk)">Student (geen KvK)</span>
        </div>
      </div>

      <div class="field">
        <label>Kunstdiscipline(s)</label>
        <div class="tag-group" id="disciplineTags">
          <span class="tag" data-val="beeldende kunst">Beeldende kunst</span>
          <span class="tag" data-val="muziek">Muziek</span>
          <span class="tag" data-val="theater">Theater</span>
          <span class="tag" data-val="dans">Dans</span>
          <span class="tag" data-val="film">Film</span>
          <span class="tag" data-val="design">Design</span>
          <span class="tag" data-val="architectuur">Architectuur</span>
          <span class="tag" data-val="digitale cultuur">Digitale cultuur</span>
          <span class="tag" data-val="mode/textiel">Mode / Textiel</span>
          <span class="tag" data-val="literatuur">Literatuur</span>
          <span class="tag" data-val="fotografie">Fotografie</span>
          <span class="tag" data-val="erfgoed">Erfgoed</span>
          <span class="tag" data-val="podiumkunsten">Podiumkunsten</span>
          <span class="tag" data-val="interdisciplinair">Interdisciplinair</span>
        </div>
      </div>

      <div class="field">
        <label>Carri√®refase</label>
        <div class="tag-group" id="faseTags">
          <span class="tag" data-val="startend (0-3 jaar)">Startend (0‚Äì3 jaar)</span>
          <span class="tag" data-val="gevestigd (3-10 jaar)">Gevestigd (3‚Äì10 jaar)</span>
          <span class="tag" data-val="ervaren (10+ jaar)">Ervaren (10+ jaar)</span>
          <span class="tag" data-val="student">Student</span>
        </div>
      </div>

      <div class="field">
        <label>Woonplaats / stad</label>
        <input type="text" id="regio" placeholder="bijv. Amsterdam, Den Haag, Rotterdam, Utrecht..." oninput="updateRegioInfo(this.value)">
        <div class="regio-info" id="regioInfo"></div>
      </div>

      <div class="field">
        <label>Culturele achtergrond <span class="sublabel">(optioneel ‚Äî relevant voor Prins Clausfonds, DNB Fonds)</span></label>
        <input type="text" id="achtergrond" placeholder="bijv. Vietnamese roots, Surinaamse achtergrond...">
      </div>
    </div>

    <!-- BLOK 2: Portfolio & Documenten -->
    <div class="form-card">
      <div class="section-title"><span class="num">2</span> Portfolio & Documenten <span class="sublabel" style="font-family:'DM Sans',sans-serif;font-size:0.76rem;color:var(--muted);font-weight:400;margin-left:0.2rem">‚Äî optioneel maar sterk aanbevolen</span></div>

      <div class="field">
        <label>Website of portfolio-URL</label>
        <p class="field-note">De AI leest de website en haalt zelf op: vertoningsgeschiedenis, festivals, samenwerkingen, kunstcontext ‚Äî precies wat bepaalt bij welk fonds iemand past.</p>
        <div class="url-row">
          <input type="text" id="portfolioUrl" placeholder="https://www.kunstenaarnaam.nl">
          <button class="url-fetch-btn" id="fetchBtn" onclick="fetchWebsite()">üåê Lezen</button>
        </div>
        <div class="status-msg" id="urlStatus"></div>
        <div class="context-preview" id="urlPreview"></div>
      </div>

      <div class="or-divider">of</div>

      <div class="field">
        <label>Projectplan, CV of portfolio uploaden of plakken</label>
        <p class="field-note">Upload een PDF of .txt bestand ‚Äî de AI leest de volledige inhoud inclusief afbeeldingen en opmaak. Of klik op "Tekst plakken" om tekst handmatig in te voeren.</p>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileUpload').click()">
          <div class="icon">üìÑ</div>
          <strong>Klik om PDF of .txt te uploaden</strong>
          <p>of sleep een bestand hierheen ‚Äî max 20MB</p>
        </div>
        <input type="file" id="fileUpload" accept=".pdf,.txt,.md" onchange="handleFileUpload(this)" style="display:none">
        <span class="paste-toggle" onclick="togglePaste()">‚úèÔ∏è Liever tekst plakken (bijv. uit een PDF of Word)?</span>
        <div class="paste-area" id="pasteArea">
          <textarea id="pasteText" placeholder="Plak hier de inhoud van je projectplan, CV of portfolio..."></textarea>
          <button class="paste-save-btn" onclick="savePastedText()">‚úì Opslaan als context</button>
        </div>
        <div class="status-msg" id="fileStatus"></div>
        <div class="context-preview" id="filePreview"></div>
      </div>
    </div>

    <!-- BLOK 3: Project -->
    <div class="form-card">
      <div class="section-title"><span class="num">3</span> Het project</div>

      <div class="field">
        <label>Beschrijf het project zo concreet mogelijk</label>
        <textarea id="projectOmschrijving" placeholder="bijv. Een danser ontwikkelt een nieuw solowerk over culturele identiteit. Premi√®re gepland voor voorjaar 2026 in een theater in Rotterdam..."></textarea>
      </div>

      <div class="field">
        <label>Projectfase</label>
        <div class="tag-group" id="faseProjTags">
          <span class="tag" data-val="idee/concept">Idee / concept</span>
          <span class="tag" data-val="onderzoek">Onderzoek</span>
          <span class="tag" data-val="ontwikkeling/pre-productie">Ontwikkeling / pre-productie</span>
          <span class="tag" data-val="productie">Productie</span>
          <span class="tag" data-val="post-productie">Post-productie</span>
          <span class="tag" data-val="presentatie/distributie">Presentatie / distributie</span>
        </div>
      </div>

      <div class="field">
        <label>Waar wordt het project gepresenteerd?</label>
        <div class="tag-group" id="locatieTags">
          <span class="tag" data-val="Nederland">Nederland</span>
          <span class="tag" data-val="internationaal/buitenland">Internationaal / Buitenland</span>
          <span class="tag" data-val="online">Online</span>
        </div>
      </div>

      <div class="field">
        <label>Type activiteit</label>
        <div class="tag-group" id="typeTags">
          <span class="tag" data-val="nieuw werk maken">Nieuw werk</span>
          <span class="tag" data-val="presentatie/tentoonstelling">Presentatie</span>
          <span class="tag" data-val="onderzoek">Onderzoek</span>
          <span class="tag" data-val="educatie/participatie">Educatie / Participatie</span>
          <span class="tag" data-val="internationale samenwerking">Internationaal</span>
          <span class="tag" data-val="community/sociaal">Community / Sociaal</span>
          <span class="tag" data-val="digitaal/technologie">Digitaal / Tech</span>
          <span class="tag" data-val="crowdfunding">Crowdfunding</span>
        </div>
      </div>

      <div class="field">
        <label>Maatschappelijke focus <span class="sublabel">(selecteer indien van toepassing)</span></label>
        <div class="tag-group" id="sociaalTags">
          <span class="tag" data-val="polarisatie/radicalisering">Polarisatie / radicalisering</span>
          <span class="tag" data-val="trans-Atlantisch slavernij/erfgoed">Slavernij / erfgoed</span>
          <span class="tag" data-val="klimaat/duurzaamheid">Klimaat / duurzaamheid</span>
          <span class="tag" data-val="sociaal-maatschappelijk">Sociaal-maatschappelijk</span>
          <span class="tag" data-val="inclusie/diversiteit">Inclusie / diversiteit</span>
        </div>
      </div>

      <div class="field">
        <label>Gevraagd subsidiebedrag</label>
        <div class="tag-group" id="bedragTags">
          <span class="tag" data-val="onder ‚Ç¨1.000">Onder ‚Ç¨1.000</span>
          <span class="tag" data-val="‚Ç¨1.000‚Äì‚Ç¨5.000">‚Ç¨1.000 ‚Äì ‚Ç¨5.000</span>
          <span class="tag" data-val="‚Ç¨5.000‚Äì‚Ç¨15.000">‚Ç¨5.000 ‚Äì ‚Ç¨15.000</span>
          <span class="tag" data-val="‚Ç¨15.000+">‚Ç¨15.000+</span>
          <span class="tag" data-val="onbekend">Onbekend</span>
        </div>
      </div>

      <div class="field">
        <label>Al ontvangen of aangevraagde regelingen <span class="sublabel">‚Äî de AI houdt hier rekening mee per specifieke regeling</span></label>
        <p class="field-note">Selecteer de specifieke regelingen die al zijn ontvangen, lopen of afgewezen. Andere regelingen bij hetzelfde fonds blijven gewoon in de scan ‚Äî want je kunt bij veel fondsen meerdere regelingen aanvragen.</p>
        <div class="tag-group" id="ontvangenTags" style="margin-bottom:0.5rem;">
          <span class="tag" data-val="Stimuleringsfonds ‚Äî Talentontwikkeling (‚ö†Ô∏è blokkeert alle andere Stimuleringsfonds regelingen)">Stimuleringsfonds: Talentontwikkeling ‚ö†Ô∏è</span>
          <span class="tag" data-val="Stimuleringsfonds ‚Äî Projectsubsidie Architectuur">Stimuleringsfonds: Architectuur</span>
          <span class="tag" data-val="Stimuleringsfonds ‚Äî Projectsubsidie Digitale cultuur">Stimuleringsfonds: Digitale cultuur</span>
          <span class="tag" data-val="Stimuleringsfonds ‚Äî Projectsubsidie Vormgeving">Stimuleringsfonds: Vormgeving</span>
          <span class="tag" data-val="AFK ‚Äî Projectsubsidie">AFK: Projectsubsidie</span>
          <span class="tag" data-val="AFK ‚Äî Werkbijdrage">AFK: Werkbijdrage</span>
          <span class="tag" data-val="Mondriaanfonds ‚Äî Werkbijdrage">Mondriaanfonds: Werkbijdrage</span>
          <span class="tag" data-val="Mondriaanfonds ‚Äî Projectsubsidie">Mondriaanfonds: Projectsubsidie</span>
          <span class="tag" data-val="Filmfonds ‚Äî DocLab Interactive Grant">Filmfonds: DocLab Interactive Grant</span>
          <span class="tag" data-val="Filmfonds ‚Äî Ontwikkelingssubsidie">Filmfonds: Ontwikkelingssubsidie</span>
          <span class="tag" data-val="Filmfonds ‚Äî Productiesubsidie">Filmfonds: Productiesubsidie</span>
          <span class="tag" data-val="Cultuurfonds ‚Äî Projectsubsidie">Cultuurfonds: Projectsubsidie</span>
          <span class="tag" data-val="VSBFonds ‚Äî Projectsubsidie">VSBFonds: Projectsubsidie</span>
          <span class="tag" data-val="Prins Bernhard Cultuurfonds ‚Äî Projectsubsidie">Prins Bernhard: Projectsubsidie</span>
        </div>
        <input type="text" id="ontvangenAndere" placeholder="Andere regelingen: bijv. Gemeente Amsterdam projectsubsidie, Dioraphte...">
      </div>

      <div class="field">
        <label>Extra context <span class="sublabel">(deadlines, partners, bijzonderheden etc.)</span></label>
        <textarea id="extraContext" placeholder="bijv. deadline AFK is oktober, samenwerking met Eye Filmmuseum bevestigd..." style="min-height:70px;"></textarea>
      </div>
    </div>

    <button class="generate-btn" onclick="generateScan()">‚ú¶ Subsidiescan genereren</button>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loadingSection">
    <div class="spinner"></div>
    <p style="font-weight:600;color:var(--primary);">Subsidiescan wordt gegenereerd...</p>
    <div class="loading-steps">
      <div class="loading-step active" id="ls1">‚ë† Klantprofiel & rechtsvorm analyseren</div>
      <div class="loading-step" id="ls2">‚ë° Fondsen matchen op discipline en rechtsvorm</div>
      <div class="loading-step" id="ls3">‚ë¢ Regio & gemeentelijke subsidies ophalen</div>
      <div class="loading-step" id="ls4">‚ë£ Portfolio en documenten verwerken</div>
      <div class="loading-step" id="ls5">‚ë§ Rapport samenstellen</div>
    </div>
  </div>

  <!-- RESULT -->
  <div class="result-card" id="resultSection">
    <div class="result-header">
      <div>
        <h2>Subsidiescan Resultaat</h2>
        <p id="resultMeta"></p>
      </div>
      <div class="btn-row">
        <button class="btn-secondary" onclick="copyResult()">üìã Kopi√´ren</button>
        <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Afdrukken</button>
      </div>
    </div>
    <div class="result-content" id="resultContent"></div>
    <div style="display:flex; gap:0.75rem; margin-top:1.5rem; flex-wrap:wrap;">
      <button class="reset-btn" onclick="pasAan()">‚úèÔ∏è Aanpassen</button>
      <button class="reset-btn" onclick="resetForm()" style="color:#c04040; border-color:#e8b0b0;">üóëÔ∏è Nieuwe scan (wist alles)</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Tag selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tag-group').forEach(group => {
  group.querySelectorAll('.tag').forEach(tag => {
    tag.addEventListener('click', () => tag.classList.toggle('selected'));
  });
});

function getSelected(id) {
  return [...document.querySelectorAll(`#${id} .tag.selected`)].map(t => t.dataset.val);
}

// ‚îÄ‚îÄ Offici√´le reglementskennis per fonds ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Gebaseerd op offici√´le regelingen 2025-2028
// Elke entry beschrijft uitsluitingsgronden en voorwaarden per SPECIFIEKE regeling
const REGLEMENTEN = {
  "Stimuleringsfonds Creatieve Industrie": {
    url: "https://www.stimuleringsfonds.nl",
    regelingen: [
      {
        naam: "Regeling Architectuur 2025-2028",
        url: "https://www.stimuleringsfonds.nl/subsidies/architectuur/",
        bedrag: "‚Ç¨10.000 ‚Äì ‚Ç¨50.000 (solo max ‚Ç¨25.000, met partners max ‚Ç¨50.000)",
        doelgroep: "Architecten, beschouwers, ontwerpbureaus, culturele instellingen in vakgebied architectuur",
        uitsluitingsgronden: [
          "Aanvrager ontvangt al subsidie via culturele basisinfrastructuur (BIS) 2025-2028",
          "Aanvrager heeft structurele subsidierelatie met rijksoverheid",
          "Aanvrager ontvangt al subsidie via Regeling Vierjarige instellingssubsidie of Activiteitenprogramma's Stimuleringsfonds",
          "Onderwijsinstellingen en postacademische instellingen",
          "Aanvraag al in behandeling bij andere Stimuleringsfonds regeling",
          "Project al gesubsidieerd door Stimuleringsfonds",
          "‚ö†Ô∏è BELANGRIJK: Aanvrager ontvangt al TALENTONTWIKKELING-subsidie van Stimuleringsfonds tijdens projectlooptijd (Art. 6.2.j)",
          "Al tweemaal afgewezen voor hetzelfde project bij Stimuleringsfonds",
          "Max 1 aanvraag per subsidietijdvak, max 1 toekenning per kalenderjaar"
        ],
        cofinanciering: "Minimaal 20% van totale projectkosten verplicht",
        looptijd: "Max 24 maanden"
      },
      {
        naam: "Regeling Digitale cultuur 2025-2028",
        url: "https://www.stimuleringsfonds.nl/subsidies/digitale-cultuur/",
        bedrag: "‚Ç¨10.000 ‚Äì ‚Ç¨50.000 (solo max ‚Ç¨25.000, met partners max ‚Ç¨50.000)",
        doelgroep: "Makers, beschouwers, ontwerpbureaus, culturele instellingen in vakgebied digitale cultuur (games, AV, creative coding, art-science etc.)",
        uitsluitingsgronden: [
          "Aanvrager ontvangt al subsidie via culturele basisinfrastructuur (BIS) 2025-2028",
          "Aanvrager heeft structurele subsidierelatie met rijksoverheid",
          "Aanvrager ontvangt al subsidie via Regeling Vierjarige instellingssubsidie of Activiteitenprogramma's Stimuleringsfonds",
          "Onderwijsinstellingen en postacademische instellingen",
          "Aanvraag al in behandeling bij andere Stimuleringsfonds regeling",
          "Project al gesubsidieerd door Stimuleringsfonds",
          "‚ö†Ô∏è BELANGRIJK: Aanvrager ontvangt al TALENTONTWIKKELING-subsidie van Stimuleringsfonds tijdens projectlooptijd (Art. 6.2.j)",
          "Al tweemaal afgewezen voor hetzelfde project bij Stimuleringsfonds",
          "Projecten gericht op digitalisering van collecties",
          "Oprichten van websites/platforms zonder inhoudelijk raakvlak digitale cultuur",
          "Max 1 aanvraag per subsidietijdvak, max 1 toekenning per kalenderjaar"
        ],
        cofinanciering: "Minimaal 20% van totale projectkosten verplicht",
        looptijd: "Max 24 maanden"
      },
      {
        naam: "Regeling Talentontwikkeling",
        url: "https://www.stimuleringsfonds.nl/subsidies/talentontwikkeling/",
        bedrag: "Variabel ‚Äî zie website",
        doelgroep: "Talentvolle makers vroeg in hun loopbaan ‚Äî voor ontwikkelplan",
        uitsluitingsgronden: [
          "Ontvangers van Talentontwikkeling-subsidie mogen NIET tegelijk aanvragen bij Regeling Architectuur of Digitale cultuur (en vice versa)",
          "Ontvangers zijn uitgesloten van andere projectregelingen Stimuleringsfonds tijdens looptijd ontwikkelplan"
        ],
        opmerking: "Als klant deze regeling al ontvangt: alle andere Stimuleringsfonds projectregelingen zijn geblokkeerd tot einde looptijd ontwikkelplan"
      }
    ]
  }
};

function getReglementsContext(alleOntvangen, disciplines) {
  // Build a specific warning block based on what client has received
  const warnings = [];
  const relevant = [];

  // Check if client has Talentontwikkeling ‚Äî this blocks ALL other Stimuleringsfonds regelingen
  const hasTalent = alleOntvangen.some(o => o.toLowerCase().includes('talentontwikkeling'));
  if (hasTalent) {
    warnings.push("‚ö†Ô∏è KRITIEKE UITSLUITING: Klant ontvangt Stimuleringsfonds Talentontwikkeling. Op grond van Art. 6.2.j zijn ALLE andere Stimuleringsfonds regelingen (Architectuur, Digitale cultuur, Vormgeving etc.) uitgesloten ZOLANG het ontwikkelplan loopt. Noem GEEN Stimuleringsfonds regelingen als aanbeveling.");
  }

  // Build relevant reglement info for disciplines
  const stimDiscs = ['design','architectuur','digitale cultuur','film','beeldende kunst'];
  const isStimRelevant = disciplines.some(d => stimDiscs.includes(d));

  if (isStimRelevant && !hasTalent) {
    const stim = REGLEMENTEN["Stimuleringsfonds Creatieve Industrie"];
    stim.regelingen.forEach(r => {
      relevant.push(`REGELING: ${r.naam}
URL: ${r.url}
Bedrag: ${r.bedrag}
Doelgroep: ${r.doelgroep}
Cofinanciering: ${r.cofinanciering}
Looptijd: ${r.looptijd}
Uitsluitingsgronden (officieel, Art. 6.2):
${r.uitsluitingsgronden.map(u => '  - ' + u).join('\n')}
${r.opmerking ? 'Opmerking: ' + r.opmerking : ''}`);
    });
  }

  return { warnings, relevant };
}

const REGIO_FONDSEN = {
  'amsterdam': { fondsen: ['Amsterdam Fonds voor de Kunsten (AFK)', 'TBI Klimaatterrein', 'W139'], gemeentelijk: 'Gemeente Amsterdam ‚Äî Kunst & Cultuur subsidies' },
  'den haag': { fondsen: ['Stroom Den Haag', 'Gemeentefonds Den Haag Cultuur'], gemeentelijk: 'Gemeente Den Haag ‚Äî cultuursubsidies' },
  'rotterdam': { fondsen: ['CBK Rotterdam', 'Prins Bernhard Cultuurfonds Zuid-Holland'], gemeentelijk: 'Gemeente Rotterdam ‚Äî Cultuursubsidies' },
  'utrecht': { fondsen: ['K.F. Hein Fonds', 'Prins Bernhard Cultuurfonds Utrecht'], gemeentelijk: 'Gemeente Utrecht ‚Äî Cultuursubsidies' },
  'eindhoven': { fondsen: ['Prins Bernhard Cultuurfonds Noord-Brabant'], gemeentelijk: 'Gemeente Eindhoven ‚Äî Cultuur en Erfgoed' },
  'groningen': { fondsen: ['Prins Bernhard Cultuurfonds Groningen'], gemeentelijk: 'Gemeente Groningen ‚Äî Cultuursubsidies' },
  'arnhem': { fondsen: ['Gelderse Cultuurfonds'], gemeentelijk: 'Gemeente Arnhem ‚Äî Cultuursubsidie' },
  'tilburg': { fondsen: ['Prins Bernhard Cultuurfonds Noord-Brabant'], gemeentelijk: 'Gemeente Tilburg ‚Äî Cultuursubsidies' },
};
function updateRegioInfo(val) {
  const key = Object.keys(REGIO_FONDSEN).find(k => val.toLowerCase().includes(k));
  const box = document.getElementById('regioInfo');
  if (key) {
    const r = REGIO_FONDSEN[key];
    box.innerHTML = `<strong>üìç Regionale fondsen voor ${val}:</strong>${r.fondsen.join(', ')} ‚Äî en: ${r.gemeentelijk}`;
    box.classList.add('visible');
  } else box.classList.remove('visible');
}

// ‚îÄ‚îÄ Fondsenlijst met rechtsvorm info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FONDSEN = [
  { naam: "Nederlands Filmfonds", focus: "film, documentaire, animatie, korte film", url: "https://www.filmfonds.nl", disciplines: ["film"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "bv/nv (commercieel)"] },
  { naam: "Filmcommission NL", focus: "filmproductie en financiering", url: "https://filmcommission.nl/fund-financing/", disciplines: ["film"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "bv/nv (commercieel)"] },
  { naam: "Stimuleringsfonds Creatieve Industrie", focus: "design, architectuur, digitale cultuur", url: "https://www.stimuleringsfonds.nl/subsidies", disciplines: ["design","architectuur","digitale cultuur"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "kunstenaarscollectief (informeel)"] },
  { naam: "Mondriaanfonds ‚Äî Werkbijdrage", focus: "beeldende kunst, fotografie ‚Äî individuele kunstenaars", url: "https://www.mondriaanfonds.nl", disciplines: ["beeldende kunst","fotografie"], rechtsvormen: ["individuele kunstenaar (zzp)"], note: "Let op: 'kunstenaar'-definitie is streng. Filmmaker kwalificeert alleen als werk in kunstdomein is vertoond (museum, galerie, kunstfestival) ‚Äî niet bij reguliere filmfestivalcategorie.", warn: true },
  { naam: "Cultuurfonds", focus: "breed cultureel", url: "https://www.cultuurfonds.nl", disciplines: ["beeldende kunst","muziek","theater","dans","literatuur","fotografie","erfgoed","interdisciplinair","mode/textiel"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "vereniging", "kunstenaarscollectief (informeel)"] },
  { naam: "Fonds ZOZ (Cultuurfonds)", focus: "polarisatie en radicalisering verminderen", url: "https://fondszoz.nl", disciplines: ["interdisciplinair","theater","muziek","beeldende kunst","film"], sociaal: "polarisatie/radicalisering", rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam: "DNB Fonds (Cultuurfonds)", focus: "trans-Atlantisch slavernij erfgoed", url: "https://www.cultuurfonds.nl/fondsen/dnb-fonds", disciplines: ["beeldende kunst","theater","dans","literatuur","interdisciplinair","film"], sociaal: "trans-Atlantisch slavernij/erfgoed", rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam: "VSBFonds", focus: "educatie en participatie", url: "https://www.vsbfonds.nl", disciplines: ["beeldende kunst","muziek","theater","dans","podiumkunsten"], rechtsvormen: ["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam: "Amsterdam Fonds voor de Kunsten (AFK)", focus: "Amsterdam-gebaseerde kunstenaars", url: "https://www.amsterdamsfondsvoordekunsten.nl", regio: "amsterdam", disciplines: ["beeldende kunst","muziek","theater","dans","film","literatuur","interdisciplinair","fotografie"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting","kunstenaarscollectief (informeel)"] },
  { naam: "Prins Clausfonds", focus: "kunstenaars met niet-Europese culturele achtergrond", url: "https://princeclausfund.nl", disciplines: ["interdisciplinair","beeldende kunst","dans","muziek","theater","film"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting"] },
  { naam: "Dioraphte", focus: "podiumkunsten, erfgoed, sociale initiatieven", url: "https://dioraphte.nl", disciplines: ["theater","dans","muziek","erfgoed","beeldende kunst","podiumkunsten"], rechtsvormen: ["stichting","vereniging"] },
  { naam: "Voordekunst (crowdfunding)", focus: "crowdfunding voor kunstenaars", url: "https://www.voordekunst.nl", disciplines: ["beeldende kunst","muziek","theater","dans","film","literatuur","interdisciplinair","mode/textiel"], rechtsvormen: ["individuele kunstenaar (zzp)","kunstenaarscollectief (informeel)","stichting"], type: "crowdfunding" },
  { naam: "Fonds voor Cultuurparticipatie", focus: "participatie en educatie", url: "https://cultuurparticipatie.nl", disciplines: ["educatie/participatie","muziek","dans","theater","beeldende kunst"], rechtsvormen: ["stichting","vereniging"] },
  { naam: "K.F. Hein Fonds", focus: "Utrecht regio", url: "https://kfhein.nl", regio: "utrecht", disciplines: ["beeldende kunst","muziek","theater","dans"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam: "TBI Klimaatterrein", focus: "klimaat & duurzaamheid, Amsterdam", url: "https://www.tbi-klimaattrein.nl", regio: "amsterdam", sociaal: "klimaat/duurzaamheid", disciplines: ["interdisciplinair","digitale cultuur","beeldende kunst"], rechtsvormen: ["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam: "Nationaal Digitaal Erfgoed", focus: "digitaal erfgoed", url: "https://netwerkdigitaalerfgoed.nl", disciplines: ["digitale cultuur","erfgoed"], rechtsvormen: ["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam: "Stroom Den Haag", focus: "beeldende kunst Den Haag", url: "https://stroom.nl", regio: "den haag", disciplines: ["beeldende kunst","fotografie","digitale cultuur"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting"] },
  { naam: "CBK Rotterdam", focus: "beeldende kunst Rotterdam", url: "https://cbk.nl", regio: "rotterdam", disciplines: ["beeldende kunst","fotografie","interdisciplinair"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting"] },
  { naam: "Prins Bernhard Cultuurfonds", focus: "diverse disciplines, regionaal", url: "https://www.cultuurfonds.nl/prins-bernhard-cultuurfonds", disciplines: ["beeldende kunst","muziek","theater","dans","literatuur","erfgoed","film"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging","kunstenaarscollectief (informeel)"] },
  { naam: "W139", focus: "experimentele beeldende kunst Amsterdam", url: "https://w139.nl", regio: "amsterdam", disciplines: ["beeldende kunst","interdisciplinair","film"], rechtsvormen: ["individuele kunstenaar (zzp)","kunstenaarscollectief (informeel)"] },
];

// ‚îÄ‚îÄ Context storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let websiteContext = '';
let documentContext = '';

// ‚îÄ‚îÄ Website fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWebsite() {
  const url = document.getElementById('portfolioUrl').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!url) { alert('Vul een URL in.'); return; }
  if (!apiKey) { alert('Vul eerst je API key in bovenaan de pagina.'); return; }
  const status = document.getElementById('urlStatus');
  const preview = document.getElementById('urlPreview');
  const btn = document.getElementById('fetchBtn');
  status.className = 'status-msg loading'; status.textContent = '‚è≥ Website wordt gelezen...';
  preview.classList.remove('visible'); btn.disabled = true;
  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST", headers: { "Content-Type": "application/json", "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true", "x-api-key": apiKey },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514", max_tokens: 1000,
        messages: [{ role: "user", content: `Haal de belangrijkste informatie op van deze website voor een subsidiescan van een Nederlandse kunstenaar. URL: ${url}\n\nZoek naar:\n- Naam en discipline\n- Vertoningsgeschiedenis (filmfestivals, musea, galeries, kunstfestivals)\n- Specifieke festivals of instellingen (bijv. IDFA, Eye, Stedelijk Museum)\n- Of werk in kunst- of commerci√´le context verscheen\n- Prijzen, nominaties\n- Samenwerkingen, partners\n- Lopende projecten\n\nWees feitelijk en specifiek. Als je de site niet kunt bereiken, zeg dat eerlijk.` }]
      })
    });
    const data = await response.json();
    websiteContext = data.content?.map(c => c.text || '').join('') || '';
    if (websiteContext.length < 50 || websiteContext.toLowerCase().includes('niet kunt bereiken')) {
      status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Website kon niet worden gelezen. Probeer tekst te plakken.'; websiteContext = '';
    } else {
      status.className = 'status-msg success'; status.textContent = '‚úì Website gelezen ‚Äî wordt meegenomen in de scan.';
      preview.textContent = websiteContext.substring(0, 300) + '...'; preview.classList.add('visible');
    }
  } catch(e) {
    status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Fout bij ophalen website.'; websiteContext = '';
  }
  btn.disabled = false;
}

// ‚îÄ‚îÄ File upload ‚Äî PDF + txt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleFileUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const status = document.getElementById('fileStatus');
  const preview = document.getElementById('filePreview');

  if (file.size > 20 * 1024 * 1024) {
    status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Bestand te groot (max 20MB).'; return;
  }

  status.className = 'status-msg loading'; status.textContent = `‚è≥ "${file.name}" wordt ingelezen...`;
  preview.classList.remove('visible');

  const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Vul eerst je API key in bovenaan de pagina.'; return;
  }

  if (isPDF) {
    // Read as ArrayBuffer, convert to base64 manually
    const reader = new FileReader();
    reader.onload = async function(e) {
      try {
        const arrayBuffer = e.target.result;
        const bytes = new Uint8Array(arrayBuffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        const base64 = btoa(binary);

        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "anthropic-version": "2023-06-01",
            "anthropic-dangerous-direct-browser-access": "true",
            "x-api-key": apiKey
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [{
              role: "user",
              content: [
                {
                  type: "document",
                  source: { type: "base64", media_type: "application/pdf", data: base64 }
                },
                {
                  type: "text",
                  text: "Lees dit document volledig en geef een uitgebreide samenvatting van alle informatie die relevant is voor een Nederlandse subsidieaanvraag. Beschrijf: de kunstenaar en discipline, het project en artistieke visie, de vertoningsgeschiedenis en context (kunstdomein vs. commercieel), samenwerkingspartners, al lopende subsidies of aanvragen, budget en financieringsbehoeften, eventuele LOI's of steunbetuigingen, en alle andere details die fondsen belangrijk vinden. Wees specifiek en feitelijk ‚Äî benoem namen van festivals, instellingen, bedragen."
                }
              ]
            }]
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        documentContext = data.content?.map(c => c.text || '').join('') || '';
        if (!documentContext.trim()) throw new Error('Geen tekst gevonden');

        status.className = 'status-msg success';
        status.textContent = `‚úì "${file.name}" volledig ingelezen ‚Äî AI heeft de inhoud geanalyseerd.`;
        preview.textContent = documentContext.substring(0, 400) + '...';
        preview.classList.add('visible');

      } catch(err) {
        console.error('PDF fout:', err);
        status.className = 'status-msg error';
        status.textContent = `‚ö†Ô∏è PDF kon niet worden verwerkt: ${err.message}. Probeer "Tekst plakken" als alternatief.`;
      }
    };
    reader.onerror = () => {
      status.className = 'status-msg error';
      status.textContent = '‚ö†Ô∏è Bestand kon niet worden gelezen.';
    };
    reader.readAsArrayBuffer(file); // ‚Üê key fix: ArrayBuffer instead of DataURL

  } else {
    // Plain text
    const reader = new FileReader();
    reader.onload = (e) => {
      documentContext = e.target.result.substring(0, 8000);
      status.className = 'status-msg success'; status.textContent = `‚úì "${file.name}" ingelezen.`;
      preview.textContent = documentContext.substring(0, 300) + '...'; preview.classList.add('visible');
    };
    reader.onerror = () => { status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Bestand kon niet worden gelezen.'; };
    reader.readAsText(file, 'UTF-8');
  }
}

// ‚îÄ‚îÄ Paste text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePaste() {
  document.getElementById('pasteArea').classList.toggle('visible');
}
function savePastedText() {
  const text = document.getElementById('pasteText').value.trim();
  if (!text) return;
  documentContext = text.substring(0, 8000);
  const status = document.getElementById('fileStatus');
  const preview = document.getElementById('filePreview');
  status.className = 'status-msg success'; status.textContent = '‚úì Tekst opgeslagen als context voor de scan.';
  preview.textContent = documentContext.substring(0, 300) + (documentContext.length > 300 ? '...' : ''); preview.classList.add('visible');
  document.getElementById('pasteArea').classList.remove('visible');
}

// ‚îÄ‚îÄ Drag & drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const zone = document.getElementById('uploadZone');
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
zone.addEventListener('drop', e => {
  e.preventDefault(); zone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) handleFileUpload({ files: e.dataTransfer.files });
});

// ‚îÄ‚îÄ Loading animation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function animateLoading() {
  let i = 0;
  const iv = setInterval(() => {
    if (i > 0) { document.getElementById(`ls${i}`).classList.remove('active'); document.getElementById(`ls${i}`).classList.add('done'); }
    i++;
    if (i <= 5) document.getElementById(`ls${i}`).classList.add('active');
    else clearInterval(iv);
  }, 900);
}

// ‚îÄ‚îÄ Generate scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateScan() {
  const naam = document.getElementById('naam').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { alert('Vul eerst je API key in bovenaan de pagina.'); return; }

  const regio = document.getElementById('regio').value.trim();
  const achtergrond = document.getElementById('achtergrond').value.trim();
  const projectOmschrijving = document.getElementById('projectOmschrijving').value.trim();
  const extraContext = document.getElementById('extraContext').value.trim();
  const ontvangenAndere = document.getElementById('ontvangenAndere').value.trim();

  const rechtsvorm = getSelected('rechtsVormTags');
  const disciplines = getSelected('disciplineTags');
  const fase = getSelected('faseTags');
  const faseProj = getSelected('faseProjTags');
  const typeProject = getSelected('typeTags');
  const locatie = getSelected('locatieTags');
  const sociaal = getSelected('sociaalTags');
  const bedrag = getSelected('bedragTags');
  const ontvangenFondsen = getSelected('ontvangenTags');
  const alleOntvangen = [...ontvangenFondsen, ...(ontvangenAndere ? ontvangenAndere.split(',').map(s => s.trim()) : [])].filter(Boolean);
  if (!projectOmschrijving && disciplines.length === 0) { alert('Vul minimaal een projectomschrijving of discipline in.'); return; }

  document.getElementById('formSection').style.display = 'none';
  document.getElementById('loadingSection').style.display = 'block';
  animateLoading();

  const regioLower = regio.toLowerCase();
  const disciplineSet = new Set(disciplines);
  const rechtsSet = new Set(rechtsvorm);
  const ontvangenSet = new Set(alleOntvangen.map(s => s.toLowerCase()));

  const scored = FONDSEN.map(f => {
    // Skip fondsen already received/applied for
    if (ontvangenSet.size > 0 && alleOntvangen.some(o => f.naam.toLowerCase().includes(o.toLowerCase()) || o.toLowerCase().includes(f.naam.toLowerCase().split(' ')[0]))) {
      return { ...f, score: -99, uitgesloten: true };
    }
    let score = 0;
    score += f.disciplines.filter(d => disciplineSet.has(d)).length * 3;
    if (f.regio && regioLower.includes(f.regio)) score += 5;
    if (f.sociaal && sociaal.includes(f.sociaal)) score += 6;
    if (typeProject.includes('crowdfunding') && f.type === 'crowdfunding') score += 6;
    if (achtergrond && f.naam.includes('Prins Clausfonds')) score += 4;
    if (rechtsvorm.length > 0) {
      const compatible = f.rechtsvormen?.some(r => rechtsSet.has(r));
      if (compatible) score += 3;
      else score -= 5;
    }
    return { ...f, score };
  }).filter(f => f.score > 0).sort((a,b) => b.score - a.score);

  const topFondsen = scored.slice(0, 6);
  const fondsInfo = topFondsen.map((f,i) => `${i+1}. ${f.naam} ‚Äî ${f.focus} ‚Äî ${f.url}${f.note ? '\n   ‚ö†Ô∏è Let op: ' + f.note : ''}\n   Geschikt voor: ${f.rechtsvormen?.join(', ')}`).join('\n\n');

  const regioKey = Object.keys(REGIO_FONDSEN).find(k => regioLower.includes(k));
  const regioExtra = regioKey ? `Regionale fondsen voor ${regio}: ${REGIO_FONDSEN[regioKey].fondsen.join(', ')} ‚Äî en: ${REGIO_FONDSEN[regioKey].gemeentelijk}` : '';

  // Get official reglement knowledge and warnings
  const { warnings: regWarnings, relevant: regRelevant } = getReglementsContext(alleOntvangen, disciplines);

  const prompt = `Je bent een gespecialiseerde subsidieadviseur voor kunstenaars in Nederland. Schrijf een professionele, grondige subsidiescan in het Nederlands.

KLANTPROFIEL:
- Naam: ${naam || 'niet opgegeven'}
- Rechtsvorm: ${rechtsvorm.join(', ') || 'niet opgegeven'}
- Discipline(s): ${disciplines.join(', ') || 'niet opgegeven'}
- Carri√®refase: ${fase.join(', ') || 'niet opgegeven'}
- Woonplaats: ${regio || 'niet opgegeven'}
- Culturele achtergrond: ${achtergrond || 'niet opgegeven'}
- Projectomschrijving: ${projectOmschrijving || 'niet opgegeven'}
- Projectfase: ${faseProj.join(', ') || 'niet opgegeven'}
- Type activiteit: ${typeProject.join(', ') || 'niet opgegeven'}
- Presentatielocatie: ${locatie.join(', ') || 'niet opgegeven'}
- Maatschappelijke focus: ${sociaal.join(', ') || 'geen'}
- Gevraagd bedrag: ${bedrag.join(', ') || 'onbekend'}
- Extra context: ${extraContext || 'geen'}
${alleOntvangen.length > 0 ? `\nAL ONTVANGEN / AANGEVRAAGD / AFGEWEZEN (specifieke regelingen):\n${alleOntvangen.join('\n')}` : ''}

${regWarnings.length > 0 ? `\n‚ö†Ô∏è KRITIEKE REGLEMENTSCONTROLE ‚Äî VERPLICHT MEENEMEN:\n${regWarnings.join('\n')}\n` : ''}

${websiteContext ? `WEBSITE/PORTFOLIO ANALYSE:\n${websiteContext}\n` : ''}
${documentContext ? `PROJECTPLAN / DOCUMENT:\n${documentContext}\n` : ''}

VOORGESELECTEERDE FONDSEN (gematcht op discipline, rechtsvorm en regio):
${fondsInfo}

REGIONALE AANVULLINGEN:
${regioExtra || 'Geen specifieke regiofondsen gevonden ‚Äî adviseer de klant om bij de gemeente te informeren naar cultuursubsidies.'}

${regRelevant.length > 0 ? `\nOFFICI√ãLE REGLEMENTSKENNIS (gebaseerd op offici√´le regelingen 2025-2028 ‚Äî gebruik deze exacte informatie bij het bespreken van deze fondsen):\n\n${regRelevant.join('\n\n---\n\n')}` : ''}

OPDRACHT:
Schrijf een complete subsidiescan met de volgende structuur. Gebruik voor elke URL het formaat: [naam](url) zodat links klikbaar zijn.

1. PROFIEL SAMENVATTING
Beschrijf wie de klant is, wat het project inhoudt, en wat je hebt opgemaakt uit het document of de website (indien aanwezig).

2. AANBEVOLEN FONDSEN
Voor elk fonds:
- Naam + directe URL
- Welke SPECIFIEKE REGELING of subsidieprogramma het meest passend is (niet alleen de naam van het fonds, maar de exacte regeling, bijv. "Mondriaanfonds ‚Äî Projectsubsidie" of "AFK ‚Äî Projectsubsidie Podiumkunsten"). Als je de exacte regeling niet zeker weet, zeg dat dan.
- Waarom dit fonds/deze regeling past bij dit profiel en project
- De voornaamste criteria en voorwaarden van die specifieke regeling
- Een concrete, op maat gemaakte aanvraagtip

3. KLEINERE STICHTINGEN & LOKALE FONDSEN
Noem minimaal 3 kleinere of minder bekende fondsen of stichtingen die relevant kunnen zijn voor dit profiel ‚Äî ook buiten de vaste lijst. Denk aan fondsjes voor specifieke disciplines, gemeentelijke regelingen, of regionale stichtingen. Wees concreet en realistisch. Vermeld ook hier de specifieke regeling en URL indien bekend.

4. AANDACHTSPUNTEN & DEFINITIEKWESTIES
Bespreek valkuilen, definitiekwesties, of fondsen die misschien niet passen vanwege rechtsvorm of andere criteria.

5. VOLGENDE STAPPEN
Concrete prioritering: wat moet de klant als eerste aanvragen, welke deadlines zijn relevant, welke informatie moet nog worden verzameld.

Toon: professioneel maar toegankelijk. Eerlijk over kansen en risico's.

VERPLICHTE OPMAAKREGELS ‚Äî volg deze EXACT:
- Gebruik GEEN ##, **, *, of andere markdown-symbolen
- Gebruik GEEN HTML-tags
- Gebruik voor links ALLEEN dit formaat: [naam fonds](https://url.nl) ‚Äî NIETS anders eromheen
- Kopjes schrijf je in HOOFDLETTERS gevolgd door een witregel
- Fondsnamen schrijf je op een eigen regel als: Naam Fonds ‚Äî Specifieke Regeling
- Daarna de URL op een eigen regel als: Website: [naam](url)
${locatie.length > 0 && !locatie.includes('internationaal/buitenland') ? '- Het project is ALLEEN bedoeld voor Nederland. Sluit fondsen/regelingen specifiek voor internationaal werk of presentaties in het buitenland (zoals Mondriaanfonds Presentatie in het Buitenland) UIT.' : ''}
- Maak de scan VOLLEDIG af ‚Äî stop niet halverwege`;

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true",
        "x-api-key": apiKey
      },
      body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 4000, messages: [{ role: "user", content: prompt }] })
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    const text = data.content?.map(c => c.text || '').join('') || 'Er is iets misgegaan.';
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'block';
    const now = new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' });
    document.getElementById('resultMeta').textContent = `Gegenereerd op ${now}${naam ? ' ¬∑ ' + naam : ''}`;
    document.getElementById('resultContent').innerHTML = formatResult(text);
  } catch(err) {
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    alert(`Er is een fout opgetreden: ${err.message}`);
  }
}

function formatResult(text) {
  // Strip markdown symbols the AI might output despite instructions
  function stripMarkdown(line) {
    line = line.replace(/^#{1,3}\s*/g, '');        // ## headers
    line = line.replace(/\*\*([^*]+)\*\*/g, '$1'); // **bold**
    line = line.replace(/\*([^*]+)\*/g, '$1');     // *italic*
    line = line.replace(/^[-*]\s+/, '');           // leading - or *
    // Remove leaked HTML attribute fragments like: " target="_blank" rel="noopener" style="...">text
    line = line.replace(/["']?\s*target=["']_blank["']\s*rel=["']noopener["'][^>]*>[^<]*/g, '');
    line = line.replace(/["']?\s*rel=["']noopener["'][^>]*>[^<]*/g, '');
    return line.trim();
  }

  // Make URLs clickable ‚Äî only real URLs, nothing else
  function renderLinks(line) {
    // If the AI already output an <a> tag, strip it and extract just the URL and text
    // Pattern: <a href="URL"...>text</a> ‚Äî extract URL and text cleanly
    line = line.replace(/<a\s+href="(https?:\/\/[^"]+)"[^>]*>([^<]*)<\/a>/g, 
      '<a href="$1" target="_blank" rel="noopener" style="color:var(--primary);font-weight:600;text-decoration:underline;text-underline-offset:2px;">$2 ‚Üó</a>');
    // Also handle unclosed tags: <a href="URL"...>text  (no closing tag, AI truncated)
    line = line.replace(/<a\s+href="(https?:\/\/[^"]+)"[^>]*>([^<"]+)$/g,
      '<a href="$1" target="_blank" rel="noopener" style="color:var(--primary);font-weight:600;text-decoration:underline;text-underline-offset:2px;">$2 ‚Üó</a>');
    // Remove any leftover raw HTML attribute junk (target=, rel=, style=) that appears as plain text
    line = line.replace(/"\s*target="_blank"\s*rel="noopener"\s*style="[^"]*">[^<\n]*/g, '');
    // Match [text](url) ‚Äî only if no <a> tag already present
    if (!line.includes('<a ')) {
      line = line.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener" style="color:var(--primary);font-weight:600;text-decoration:underline;text-underline-offset:2px;">$1 ‚Üó</a>');
      // Match bare URLs
      line = line.replace(/(https?:\/\/[^\s<>")\]]+)/g,
        '<a href="$1" target="_blank" rel="noopener" style="color:var(--primary);font-weight:600;text-decoration:underline;text-underline-offset:2px;">$1 ‚Üó</a>');
    }
    return line;
  }

  const SECTION_HEADERS = ['1. PROFIEL', '2. AANBEVOLEN', '3. KLEINERE', '4. AANDACHT', '5. VOLGENDE',
    'PROFIEL SAMENVATTING', 'AANBEVOLEN FONDSEN', 'KLEINERE STICHTINGEN', 'AANDACHTSPUNTEN', 'VOLGENDE STAPPEN'];

  let html = '';
  let inFondsCard = false;

  for (let rawLine of text.split('\n')) {
    let line = stripMarkdown(rawLine);
    if (!line) {
      if (inFondsCard) { html += '</div>'; inFondsCard = false; }
      html += '<br>';
      continue;
    }

    // Section headers
    const isHeader = SECTION_HEADERS.some(h => line.toUpperCase().includes(h.toUpperCase())) && line.length < 80;
    if (isHeader) {
      if (inFondsCard) { html += '</div>'; inFondsCard = false; }
      html += `<div class="section-header">${line}</div>`;
      continue;
    }

    // Fonds name lines (bold fonds names the AI writes, e.g. "AFK ‚Äî Projectsubsidie")
    const isFondsTitle = /^[A-Z].{5,60}(‚Äî|--)/.test(line) && line.length < 100 && !line.includes('http');
    if (isFondsTitle) {
      if (inFondsCard) { html += '</div>'; inFondsCard = false; }
      html += `<div class="fonds-card"><h3>${renderLinks(line)}</h3>`;
      inFondsCard = true;
      continue;
    }

    // Warning lines
    if (line.includes('‚ö†Ô∏è') || (line.toLowerCase().includes('let op') && line.length < 120)) {
      if (inFondsCard) { html += '</div>'; inFondsCard = false; }
      html += `<div class="warn-card"><p>‚ö†Ô∏è ${renderLinks(line.replace('‚ö†Ô∏è','').trim())}</p></div>`;
      continue;
    }

    // Website/URL lines ‚Äî show as distinct link line
    if (line.toLowerCase().startsWith('website:') || line.toLowerCase().startsWith('url:') || line.toLowerCase().startsWith('link:')) {
      html += `<p style="margin:0.25rem 0 0.75rem 0;">${renderLinks(line)}</p>`;
      continue;
    }

    // Bullet-like lines
    if (rawLine.trim().startsWith('- ') || rawLine.trim().startsWith('‚Ä¢ ')) {
      html += `<p style="padding-left:1.25rem;margin:0.2rem 0;">‚Üí ${renderLinks(line)}</p>`;
      continue;
    }

    // Normal paragraph
    html += `<p style="margin:0.4rem 0;">${renderLinks(line)}</p>`;
  }

  if (inFondsCard) html += '</div>';
  return html;
}

function copyResult() {
  navigator.clipboard.writeText(document.getElementById('resultContent').innerText).then(() => {
    const b = event.target; b.textContent = '‚úì Gekopieerd!'; setTimeout(() => b.textContent = 'üìã Kopi√´ren', 2000);
  });
}
function pasAan() {
  document.getElementById('resultSection').style.display = 'none';
  document.getElementById('formSection').style.display = 'block';
  window.scrollTo(0, 0);
}

function resetForm() {
  // Clear all text inputs
  document.querySelectorAll('input[type="text"], input[type="password"], textarea').forEach(el => {
    if (el.id !== 'apiKey') el.value = ''; // keep API key
  });
  // Deselect all tags
  document.querySelectorAll('.tag.selected').forEach(t => t.classList.remove('selected'));
  // Clear context
  websiteContext = ''; documentContext = '';
  // Reset upload status messages
  ['urlStatus','urlPreview','fileStatus','filePreview'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.className = el.className.includes('preview') ? 'context-preview' : 'status-msg'; }
  });
  document.getElementById('resultSection').style.display = 'none';
  document.getElementById('formSection').style.display = 'block';
  window.scrollTo(0, 0);
}
</script>
</body>
</html>
