<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsidietool â€” Anh Thu Pham</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Variables & Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg: #f5f4f8;
  --primary: #4a3fa5;
  --primary-light: #7b72d4;
  --accent: #c9a7e8;
  --accent2: #a8d8d0;
  --text: #1a1830;
  --muted: #7a7899;
  --border: #e4e2f0;
  --gradient: linear-gradient(135deg, #e8e4f8 0%, #f0e8f8 40%, #e4f0f8 100%);
  --warn: #f0e6d3;
  --warn-border: #e0c89a;
  --ok: #e6f4ed;
  --ok-border: #9ecfb5;
  --danger: #fde8e8;
  --danger-border: #f0b0b0;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg); color: var(--text); min-height: 100vh;
  background-image:
    radial-gradient(ellipse at 20% 20%, rgba(74,63,165,0.08) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 80%, rgba(201,167,232,0.12) 0%, transparent 60%);
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header {
  padding: 1rem 2rem; display: flex; align-items: center; gap: 1rem;
  border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.75);
  backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 20;
  flex-wrap: wrap; gap: 0.75rem;
}
.logo-mark {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  border-radius: 11px; display: flex; align-items: center; justify-content: center;
  font-family: 'DM Serif Display', serif; color: white; font-size: 1rem; flex-shrink: 0;
}
.header-text h1 { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--primary); }
.header-text p  { font-size: 0.7rem; color: var(--muted); font-weight: 300; }
.badge { background: var(--primary); color: white; font-size: 0.58rem; padding: 0.12rem 0.45rem; border-radius: 100px; font-weight: 600; letter-spacing: 0.05em; margin-left: 0.4rem; vertical-align: middle; }

/* â”€â”€ Pipeline progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pipeline-bar {
  padding: 0.7rem 2rem; background: rgba(255,255,255,0.6); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 0; font-size: 0.76rem; color: var(--muted);
  overflow-x: auto;
}
.pipe-step { display: flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.75rem; border-radius: 100px; transition: all 0.3s; white-space: nowrap; }
.pipe-step.active { background: #f0eef8; color: var(--primary); font-weight: 600; }
.pipe-step.done { color: #2a6048; font-weight: 600; }
.pipe-step .pipe-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); flex-shrink: 0; transition: background 0.3s; }
.pipe-step.active .pipe-dot { background: var(--primary-light); }
.pipe-step.done .pipe-dot { background: #5ec888; }
.pipe-arrow { color: var(--border); margin: 0 0.15rem; font-size: 0.7rem; }

/* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { max-width: 860px; margin: 0 auto; padding: 2rem 1.5rem 5rem; }
.flow-section { display: none; }
.flow-section.active { display: block; }

/* â”€â”€ Shared API Keys card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.keys-card {
  background: linear-gradient(135deg, #faf8ff, #f5f0ff);
  border: 1px solid var(--accent); border-radius: 18px;
  padding: 1.25rem 1.75rem; margin-bottom: 1.75rem;
}
.keys-card summary {
  cursor: pointer; font-family: 'DM Serif Display', serif; font-size: 0.95rem;
  color: var(--primary); list-style: none; display: flex; align-items: center; gap: 0.5rem;
}
.keys-card summary::after { content: 'â–¾'; margin-left: auto; color: var(--muted); }
details[open] summary::after { content: 'â–´'; }
.keys-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1rem; }
@media(max-width:600px) { .keys-grid { grid-template-columns: 1fr; } }
.key-field label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--muted); margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.05em; }

/* â”€â”€ Intro card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.intro-card {
  background: var(--gradient); border: 1px solid var(--border); border-radius: 20px;
  padding: 1.75rem 2rem; margin-bottom: 1.75rem; position: relative; overflow: hidden;
}
.intro-card::after { position: absolute; right: 1.75rem; top: 1.25rem; font-size: 2rem; color: var(--primary-light); opacity: 0.2; content: 'âœ¦'; }
.intro-card h2 { font-family: 'DM Serif Display', serif; font-size: 1.3rem; color: var(--primary); margin-bottom: 0.35rem; }
.intro-card p { color: var(--muted); font-size: 0.86rem; line-height: 1.6; }
.feature-pills { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.85rem; }
.pill { background: white; border: 1px solid var(--border); border-radius: 100px; padding: 0.25rem 0.7rem; font-size: 0.73rem; color: var(--primary); font-weight: 500; }

/* â”€â”€ Form card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-card {
  background: white; border: 1px solid var(--border); border-radius: 18px;
  padding: 1.75rem 2rem; margin-bottom: 1.25rem; box-shadow: 0 2px 18px rgba(74,63,165,0.05);
}
.section-title {
  font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--primary);
  margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.55rem;
}
.num {
  width: 24px; height: 24px; background: var(--primary); color: white;
  border-radius: 7px; display: flex; align-items: center; justify-content: center;
  font-size: 0.68rem; font-family: 'DM Sans', sans-serif; font-weight: 600; flex-shrink: 0;
}
.field { margin-bottom: 1.1rem; }
label { display: block; font-size: 0.81rem; font-weight: 600; color: var(--text); margin-bottom: 0.35rem; }
.sublabel { font-size: 0.72rem; color: var(--muted); font-weight: 400; margin-left: 0.15rem; }
.field-note { font-size: 0.76rem; color: var(--muted); line-height: 1.5; margin-bottom: 0.4rem; }
input[type="text"], input[type="password"], input[type="url"], textarea, select {
  width: 100%; padding: 0.7rem 0.95rem; border: 1.5px solid var(--border); border-radius: 11px;
  font-family: 'DM Sans', sans-serif; font-size: 0.86rem; color: var(--text);
  background: #fafafa; transition: border-color 0.2s, box-shadow 0.2s; outline: none; -webkit-appearance: none;
}
input:focus, textarea:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(74,63,165,0.08); background: white; }
textarea { resize: vertical; min-height: 88px; line-height: 1.5; }

/* Key row */
.key-row { position: relative; }
.key-row input { padding-right: 3rem; font-family: monospace; font-size: 0.78rem; }
.key-toggle {
  position: absolute; right: 0.7rem; top: 50%; transform: translateY(-50%);
  background: none; border: none; cursor: pointer; color: var(--muted); font-size: 0.72rem; padding: 0.2rem 0.35rem;
}

/* Tags */
.tag-group { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.35rem; }
.tag {
  padding: 0.34rem 0.75rem; border: 1.5px solid var(--border); border-radius: 100px;
  font-size: 0.76rem; cursor: pointer; transition: all 0.15s; background: #fafafa;
  user-select: none; font-family: 'DM Sans', sans-serif;
}
.tag:hover { border-color: var(--primary-light); background: #f0eef8; }
.tag.selected { background: var(--primary); color: white; border-color: var(--primary); }

/* Upload zone */
.upload-zone {
  border: 2px dashed var(--border); border-radius: 13px; padding: 1.25rem;
  text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; position: relative;
}
.upload-zone:hover, .upload-zone.dragover { border-color: var(--primary-light); background: #f0eef8; }
.upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
.upload-zone .icon { font-size: 1.6rem; margin-bottom: 0.3rem; }
.upload-zone p { font-size: 0.8rem; color: var(--muted); }
.upload-zone strong { color: var(--primary); font-size: 0.82rem; }
.status-msg { margin-top: 0.55rem; font-size: 0.78rem; padding: 0.45rem 0.75rem; border-radius: 8px; display: none; }
.status-msg.success { background: var(--ok); color: #2a5a50; display: block; }
.status-msg.loading { background: #f0eef8; color: var(--primary); display: block; }
.status-msg.error { background: var(--danger); color: #8a2020; display: block; }
.context-preview { background: #f5f4f8; border: 1px solid var(--border); border-radius: 9px; padding: 0.65rem 0.9rem; margin-top: 0.55rem; font-size: 0.76rem; color: var(--muted); max-height: 90px; overflow-y: auto; display: none; line-height: 1.5; }
.context-preview.visible { display: block; }
.or-divider { text-align: center; color: var(--muted); font-size: 0.76rem; margin: 0.65rem 0; position: relative; }
.or-divider::before, .or-divider::after { content: ''; position: absolute; top: 50%; width: 42%; height: 1px; background: var(--border); }
.or-divider::before { left: 0; } .or-divider::after { right: 0; }
.url-row { display: flex; gap: 0.45rem; align-items: center; }
.url-row input { flex: 1; }
.url-fetch-btn {
  padding: 0.7rem 0.95rem; background: var(--primary); color: white; border: none; border-radius: 11px;
  font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0;
}
.url-fetch-btn:hover { background: var(--primary-light); }
.url-fetch-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.paste-toggle { font-size: 0.76rem; color: var(--primary); cursor: pointer; text-decoration: underline; text-underline-offset: 2px; margin-top: 0.45rem; display: inline-block; }
.paste-area { display: none; margin-top: 0.65rem; }
.paste-area.visible { display: block; }
.paste-save-btn {
  margin-top: 0.45rem; padding: 0.45rem 0.9rem; background: var(--primary); color: white; border: none;
  border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: 0.78rem; font-weight: 600; cursor: pointer;
}
.regio-info {
  display: none; background: #e8f4f0; border: 1px solid #b8ddd4;
  border-radius: 11px; padding: 0.85rem 1.1rem; margin-top: 0.6rem; font-size: 0.8rem; color: #2a5a50;
}
.regio-info.visible { display: block; }
.regio-info strong { display: block; margin-bottom: 0.25rem; font-size: 0.75rem; }

/* â”€â”€ CTA Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cta-btn {
  width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white; border: none; border-radius: 14px; font-family: 'DM Serif Display', serif;
  font-size: 1rem; cursor: pointer; transition: all 0.22s; box-shadow: 0 4px 18px rgba(74,63,165,0.25);
  margin-top: 0.5rem; letter-spacing: 0.01em;
}
.cta-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 26px rgba(74,63,165,0.32); }
.cta-btn:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }
.btn-secondary {
  padding: 0.48rem 0.95rem; border: 1.5px solid var(--border); border-radius: 9px;
  background: white; color: var(--text); font-family: 'DM Sans', sans-serif;
  font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
}
.btn-secondary:hover { border-color: var(--primary-light); color: var(--primary); }
.reset-btn {
  padding: 0.55rem 1.1rem; border: 1.5px solid var(--border); border-radius: 10px;
  background: white; color: var(--muted); font-family: 'DM Sans', sans-serif;
  font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
}
.reset-btn:hover { border-color: var(--primary-light); color: var(--primary); }
.btn-row { display: flex; gap: 0.45rem; flex-wrap: wrap; }

/* â”€â”€ Progress steps (crawl) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress-card { background: white; border: 1px solid var(--border); border-radius: 18px; padding: 1.75rem 2rem; margin-bottom: 1.25rem; }
.progress-title { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--primary); margin-bottom: 1.25rem; }
.step-list { display: flex; flex-direction: column; gap: 0.65rem; }
.step {
  display: flex; align-items: center; gap: 0.8rem; padding: 0.65rem 0.9rem;
  border-radius: 11px; border: 1px solid var(--border); background: #fafafa;
  font-size: 0.83rem; color: var(--muted); transition: all 0.3s;
}
.step.active { border-color: var(--primary-light); background: #f0eef8; color: var(--primary); font-weight: 600; }
.step.done  { border-color: var(--ok-border); background: var(--ok); color: #2a6048; }
.step.error { border-color: var(--danger-border); background: var(--danger); color: #8a2020; }
.step-icon { font-size: 1rem; width: 1.3rem; text-align: center; flex-shrink: 0; }
.step-text { flex: 1; }
.step-detail { font-size: 0.72rem; opacity: 0.8; margin-top: 0.08rem; }
.spinner-sm { width: 15px; height: 15px; border: 2px solid rgba(74,63,165,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
@keyframes spin { to { transform: rotate(360deg); } }
.log-box {
  background: #1a1830; color: #b8d4b0; font-family: monospace; font-size: 0.73rem;
  border-radius: 11px; padding: 0.9rem 1.1rem; max-height: 200px; overflow-y: auto;
  margin-top: 0.9rem; line-height: 1.7;
}
.log-box .log-ts { color: #5a5878; margin-right: 0.45rem; }
.log-box .log-ok  { color: #7ec89a; }
.log-box .log-warn{ color: #e8c870; }
.log-box .log-err { color: #e87070; }

/* â”€â”€ Result cards & scores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-card { display: none; background: white; border: 1px solid var(--border); border-radius: 18px; padding: 2rem 2.25rem; box-shadow: 0 2px 18px rgba(74,63,165,0.06); margin-bottom: 1.25rem; }
.result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem; padding-bottom: 1.25rem; border-bottom: 1px solid var(--border); gap: 0.9rem; flex-wrap: wrap; }
.result-header h2 { font-family: 'DM Serif Display', serif; color: var(--primary); font-size: 1.2rem; }
.result-header p { font-size: 0.76rem; color: var(--muted); margin-top: 0.18rem; }
.fonds-banner { background: var(--gradient); border: 1px solid var(--border); border-radius: 15px; padding: 1.1rem 1.5rem; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.9rem; flex-wrap: wrap; }
.fonds-banner-icon { font-size: 1.75rem; }
.fonds-banner-text h3 { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--primary); }
.fonds-banner-text p { font-size: 0.77rem; color: var(--muted); margin-top: 0.12rem; }
.fonds-banner-url { margin-left: auto; font-size: 0.75rem; }
.fonds-banner-url a { color: var(--primary); font-weight: 600; text-decoration: underline; text-underline-offset: 2px; }
.fonds-score-banner { background: linear-gradient(135deg, #f0eef8, #e8e4f8); border: 1.5px solid var(--primary-light); border-radius: 14px; padding: 1rem 1.5rem; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
.fonds-score-num { font-family: 'DM Serif Display', serif; font-size: 2rem; color: var(--primary); line-height: 1; }
.fonds-score-label { font-size: 0.82rem; color: var(--muted); }
.fonds-score-label strong { color: var(--text); display: block; font-size: 0.9rem; }

/* Score badges (0-100) */
.score-badge { padding: 0.22rem 0.65rem; border-radius: 100px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.03em; white-space: nowrap; flex-shrink: 0; }
.score-high { background: #d4f0e2; color: #1a6040; }
.score-mid  { background: #fef0d6; color: #7a4a00; }
.score-low  { background: #fde4e4; color: #7a1010; }
.score-excluded { background: #3a1010; color: #fff; font-weight: 800; letter-spacing: 0.05em; }
.score-unk  { background: #ebebf5; color: var(--muted); }

/* Score bar */
.score-bar-wrap { margin-top: 0.25rem; }
.score-bar { height: 8px; background: #e8e6f0; border-radius: 6px; overflow: hidden; }
.score-fill { height: 100%; background: linear-gradient(90deg, #4a3fa5, #7b72d4); border-radius: 6px; transition: width 0.6s ease; }
.score-fill.mid { background: linear-gradient(90deg, #c88a00, #e8b855); }
.score-fill.low { background: linear-gradient(90deg, #c04040, #e87070); }

/* Exclusion banner on regeling */
.exclusion-banner { background: var(--danger); border: 1.5px solid var(--danger-border); border-radius: 10px; padding: 0.75rem 1rem; margin-bottom: 0.85rem; display: flex; align-items: flex-start; gap: 0.6rem; }
.exclusion-banner .excl-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 0.05rem; }
.exclusion-banner .excl-text { font-size: 0.82rem; color: #7a1010; line-height: 1.5; }
.exclusion-banner .excl-text strong { display: block; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.15rem; }

/* Regeling cards */
.regeling-card { background: white; border: 1px solid var(--border); border-radius: 14px; margin-bottom: 0.85rem; overflow: hidden; box-shadow: 0 2px 10px rgba(74,63,165,0.04); transition: box-shadow 0.2s; }
.regeling-card:hover { box-shadow: 0 4px 18px rgba(74,63,165,0.1); }
.regeling-card.excluded { border-color: var(--danger-border); opacity: 0.85; }
.regeling-header { padding: 1rem 1.35rem; display: flex; align-items: center; gap: 0.9rem; cursor: pointer; border-bottom: 1px solid transparent; transition: border-color 0.2s; }
.regeling-header:hover { border-bottom-color: var(--border); }
.regeling-header.open { border-bottom-color: var(--border); }
.regeling-name { font-weight: 700; font-size: 0.92rem; flex: 1; }
.chevron { color: var(--muted); font-size: 0.78rem; transition: transform 0.2s; flex-shrink: 0; }
.chevron.open { transform: rotate(180deg); }
.regeling-body { display: none; padding: 1.1rem 1.35rem 1.35rem; }
.regeling-body.open { display: block; }
.data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.65rem; margin-bottom: 0.85rem; }
@media(max-width:600px) { .data-grid { grid-template-columns: 1fr; } }
.data-cell { background: #fafafa; border: 1px solid var(--border); border-radius: 9px; padding: 0.58rem 0.8rem; }
.data-cell.highlight { border-color: var(--primary-light); background: #f3f1fc; }
.data-cell .dc-label { font-size: 0.65rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.2rem; }
.data-cell .dc-value { font-size: 0.82rem; color: var(--text); line-height: 1.4; }
.criteria-section { margin-bottom: 0.75rem; }
.criteria-section h4 { font-size: 0.72rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.35rem; }
.criteria-list { display: flex; flex-direction: column; gap: 0.25rem; }
.criteria-item { display: flex; align-items: flex-start; gap: 0.45rem; font-size: 0.8rem; line-height: 1.4; padding: 0.3rem 0.55rem; border-radius: 7px; }
.criteria-item.hard { background: #fafafa; border: 1px solid var(--border); }
.criteria-item.excl { background: var(--danger); border: 1px solid var(--danger-border); color: #7a1010; }
.ci-dot { flex-shrink: 0; margin-top: 0.08rem; }
.evidence-section { margin-top: 0.75rem; }
.evidence-section h4 { font-size: 0.72rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.45rem; }
.evidence-item { border: 1px solid var(--border); border-radius: 9px; padding: 0.58rem 0.8rem; margin-bottom: 0.35rem; }
.evidence-url { font-size: 0.7rem; color: var(--primary); font-weight: 600; display: block; margin-bottom: 0.2rem; word-break: break-all; text-decoration: underline; text-underline-offset: 2px; }
.evidence-quote { font-size: 0.77rem; color: var(--muted); font-style: italic; line-height: 1.5; }
.uncertain { color: #9a6a00; background: #fef8e6; border: 1px solid #f0d870; border-radius: 5px; padding: 0.08rem 0.35rem; font-size: 0.72rem; font-weight: 600; }
.raw-toggle { font-size: 0.73rem; color: var(--muted); cursor: pointer; text-decoration: underline; margin-top: 0.85rem; display: inline-block; }
.raw-json { display: none; background: #1a1830; color: #a8d4f0; font-family: monospace; font-size: 0.7rem; border-radius: 11px; padding: 0.9rem; margin-top: 0.45rem; max-height: 280px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; line-height: 1.6; }
.empty-state { text-align: center; padding: 2.5rem 1rem; color: var(--muted); }
.empty-state .es-icon { font-size: 2.5rem; margin-bottom: 0.85rem; }
.empty-state h3 { font-family: 'DM Serif Display', serif; color: var(--text); margin-bottom: 0.4rem; }

/* Match motivation / kansen / blokkades */
.match-motivation { font-size: 0.85rem; color: var(--text); line-height: 1.65; margin-bottom: 0.75rem; }
.match-blockers { background: var(--danger); border: 1px solid var(--danger-border); border-radius: 9px; padding: 0.75rem 1rem; margin-top: 0.6rem; font-size: 0.82rem; color: #7a1010; }
.match-blockers h5 { font-weight: 700; margin-bottom: 0.3rem; font-size: 0.75rem; text-transform: uppercase; }

/* Section divider in results */
.results-divider { font-family: 'DM Serif Display', serif; font-size: 0.92rem; color: var(--muted); margin: 1.5rem 0 0.85rem; padding-bottom: 0.45rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem; }

/* Validation error */
.validation-errors { background: var(--danger); border: 1px solid var(--danger-border); border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.25rem; }
.validation-errors h4 { font-size: 0.82rem; color: #7a1010; margin-bottom: 0.45rem; font-weight: 700; }
.validation-errors ul { padding-left: 1.2rem; font-size: 0.8rem; color: #7a1010; line-height: 1.6; }

@media(max-width:600px) {
  .main { padding: 1.25rem 0.85rem 3rem; }
  .form-card, .progress-card, .result-card { padding: 1.35rem; }
  header { padding: 0.85rem 1rem; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  HEADER                                                        -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo-mark">A</div>
  <div class="header-text">
    <h1>Subsidietool <span class="badge">v6</span></h1>
    <p>Anh Thu Pham â€” fondsenanalyse & subsidiescan</p>
  </div>
</header>

<!-- Pipeline progress bar -->
<div class="pipeline-bar" id="pipelineBar">
  <div class="pipe-step active" id="pipeProject"><div class="pipe-dot"></div> Project invoeren</div>
  <span class="pipe-arrow">â†’</span>
  <div class="pipe-step" id="pipeScan"><div class="pipe-dot"></div> Subsidiescan</div>
  <span class="pipe-arrow">â†’</span>
  <div class="pipe-step" id="pipeResults"><div class="pipe-dot"></div> Resultaten</div>
</div>

<div class="main">

<!-- Hidden API key inputs (auto-loaded from .env via /api/keys) -->
<input type="hidden" id="claudeApiKey">
<input type="hidden" id="apifyToken">
<input type="hidden" id="serpApiKey">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  STEP 1 â€” PROJECT INVOEREN                                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flow-section active" id="sectionProject">

  <div class="intro-card">
    <h2>Subsidiescan</h2>
    <p>Vul je klantprofiel in en start de scan. De tool doorzoekt automatisch 25+ fondsen, filtert op rechtsvorm en discipline, en geeft de 8 best passende fondsen met een score van 0â€“100.</p>
    <div class="feature-pills">
      <span class="pill">ğŸ›ï¸ Rechtsvorm-filter</span>
      <span class="pill">ğŸ” 25+ fondsen database</span>
      <span class="pill">ğŸ¤– Claude diepte-analyse</span>
      <span class="pill">ğŸš« Uitsluitingscheck</span>
      <span class="pill">âœ¦ Top 8 resultaten</span>
    </div>
  </div>

  <div id="projectFormSection">

    <!-- Klantprofiel -->
    <div class="form-card">
      <div class="section-title"><span class="num">1</span> Klantprofiel</div>

      <div class="field">
        <label>Naam <span class="sublabel">(optioneel)</span></label>
        <input type="text" id="naam" placeholder="bijv. naam van de kunstenaar">
      </div>

      <div class="field">
        <label>Rechtsvorm</label>
        <div class="tag-group" id="rechtsVormTags">
          <span class="tag" data-val="individuele kunstenaar (zzp)">Individuele kunstenaar / ZZP</span>
          <span class="tag" data-val="kunstenaarscollectief (informeel)">Kunstenaarscollectief (informeel)</span>
          <span class="tag" data-val="stichting">Stichting</span>
          <span class="tag" data-val="vereniging">Vereniging</span>
          <span class="tag" data-val="bv/nv (commercieel)">BV / NV (commercieel)</span>
          <span class="tag" data-val="student (geen kvk)">Student (geen KvK)</span>
        </div>
      </div>

      <div class="field">
        <label>Kunstdiscipline(s)</label>
        <div class="tag-group" id="disciplineTags">
          <span class="tag" data-val="beeldende kunst">Beeldende kunst</span>
          <span class="tag" data-val="muziek">Muziek</span>
          <span class="tag" data-val="theater">Theater</span>
          <span class="tag" data-val="dans">Dans</span>
          <span class="tag" data-val="film">Film</span>
          <span class="tag" data-val="design">Design</span>
          <span class="tag" data-val="architectuur">Architectuur</span>
          <span class="tag" data-val="digitale cultuur">Digitale cultuur</span>
          <span class="tag" data-val="mode/textiel">Mode / Textiel</span>
          <span class="tag" data-val="literatuur">Literatuur</span>
          <span class="tag" data-val="fotografie">Fotografie</span>
          <span class="tag" data-val="erfgoed">Erfgoed</span>
          <span class="tag" data-val="podiumkunsten">Podiumkunsten</span>
          <span class="tag" data-val="interdisciplinair">Interdisciplinair</span>
        </div>
      </div>

      <div class="field">
        <label>Carrierefase</label>
        <div class="tag-group" id="faseTags">
          <span class="tag" data-val="startend (0-3 jaar)">Startend (0-3 jaar)</span>
          <span class="tag" data-val="gevestigd (3-10 jaar)">Gevestigd (3-10 jaar)</span>
          <span class="tag" data-val="ervaren (10+ jaar)">Ervaren (10+ jaar)</span>
          <span class="tag" data-val="student">Student</span>
        </div>
      </div>

      <div class="field">
        <label>Woonplaats / stad</label>
        <input type="text" id="regio" placeholder="bijv. Amsterdam, Den Haag, Rotterdam, Utrecht..." oninput="updateRegioInfo(this.value)">
        <div class="regio-info" id="regioInfo"></div>
      </div>

      <div class="field">
        <label>Culturele achtergrond <span class="sublabel">(optioneel)</span></label>
        <input type="text" id="achtergrond" placeholder="bijv. Vietnamese roots, Surinaamse achtergrond...">
      </div>
    </div>

    <!-- Portfolio & Documenten -->
    <div class="form-card">
      <div class="section-title"><span class="num">2</span> Portfolio & Documenten <span class="sublabel" style="font-family:'DM Sans',sans-serif;font-size:0.73rem;color:var(--muted);font-weight:400;">â€” optioneel maar aanbevolen</span></div>

      <div class="field">
        <label>Website of portfolio-URL</label>
        <p class="field-note">AI leest de website en haalt vertoningsgeschiedenis, festivals en samenwerkingen op.</p>
        <div class="url-row">
          <input type="text" id="portfolioUrl" placeholder="https://www.kunstenaarnaam.nl">
          <button class="url-fetch-btn" id="fetchBtn" onclick="fetchWebsite()">ğŸŒ Lezen</button>
        </div>
        <div class="status-msg" id="urlStatus"></div>
        <div class="context-preview" id="urlPreview"></div>
      </div>

      <div class="or-divider">of</div>

      <div class="field">
        <label>Projectplan, CV of portfolio uploaden of plakken</label>
        <p class="field-note">Upload een PDF of .txt bestand, of plak tekst handmatig.</p>
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileUpload').click()">
          <div class="icon">ğŸ“„</div>
          <strong>Klik om PDF of .txt te uploaden</strong>
          <p>of sleep een bestand hierheen â€” max 20MB</p>
        </div>
        <input type="file" id="fileUpload" accept=".pdf,.txt,.md" onchange="handleFileUpload(this)" style="display:none">
        <span class="paste-toggle" onclick="togglePaste()">âœï¸ Liever tekst plakken?</span>
        <div class="paste-area" id="pasteArea">
          <textarea id="pasteText" placeholder="Plak hier de inhoud van je projectplan, CV of portfolio..."></textarea>
          <button class="paste-save-btn" onclick="savePastedText()">âœ“ Opslaan als context</button>
        </div>
        <div class="status-msg" id="fileStatus"></div>
        <div class="context-preview" id="filePreview"></div>
      </div>
    </div>

    <!-- Het project -->
    <div class="form-card">
      <div class="section-title"><span class="num">3</span> Het project</div>

      <div class="field">
        <label>Beschrijf het project zo concreet mogelijk</label>
        <textarea id="projectOmschrijving" placeholder="bijv. Een danser ontwikkelt een nieuw solowerk over culturele identiteit. Premiere gepland voor voorjaar 2026 in een theater in Rotterdam..."></textarea>
      </div>

      <div class="field">
        <label>Projectfase</label>
        <div class="tag-group" id="faseProjTags">
          <span class="tag" data-val="onderzoek/ontwikkeling">Onderzoek / ontwikkeling</span>
          <span class="tag" data-val="voorproductie">Voorproductie</span>
          <span class="tag" data-val="productie">Productie</span>
          <span class="tag" data-val="presentatie">Presentatie</span>
          <span class="tag" data-val="publicatie">Publicatie</span>
          <span class="tag" data-val="talentontwikkeling">Talentontwikkeling</span>
          <span class="tag" data-val="doorontwikkeling bestaand werk">Doorontwikkeling bestaand werk</span>
        </div>
      </div>

      <div class="field">
        <label>Waar wordt het project gepresenteerd?</label>
        <div class="tag-group" id="locatieTags">
          <span class="tag" data-val="Nederland">Nederland</span>
          <span class="tag" data-val="internationaal/buitenland">Internationaal / Buitenland</span>
          <span class="tag" data-val="online">Online</span>
        </div>
      </div>

      <div class="field">
        <label>Primair doel van het project</label>
        <div class="tag-group" id="doelTags">
          <span class="tag" data-val="artistieke ontwikkeling">Artistieke ontwikkeling</span>
          <span class="tag" data-val="publieksbereik">Publieksbereik</span>
          <span class="tag" data-val="onderzoek">Onderzoek</span>
          <span class="tag" data-val="educatie">Educatie</span>
          <span class="tag" data-val="participatie">Participatie</span>
          <span class="tag" data-val="internationale samenwerking">Internationale samenwerking</span>
          <span class="tag" data-val="talentontwikkeling">Talentontwikkeling</span>
        </div>
      </div>

      <div class="field">
        <label>Type activiteit</label>
        <p class="field-note" style="margin-bottom:0.5rem;">Artistiek</p>
        <div class="tag-group" id="typeArtistiekTags" style="margin-bottom:0.65rem;">
          <span class="tag" data-val="tentoonstelling">Tentoonstelling</span>
          <span class="tag" data-val="performance">Performance</span>
          <span class="tag" data-val="installatie">Installatie</span>
          <span class="tag" data-val="filmproductie">Filmproductie</span>
          <span class="tag" data-val="publicatie/boek">Publicatie / boek</span>
          <span class="tag" data-val="digitale productie">Digitale productie</span>
          <span class="tag" data-val="architectonisch ontwerp">Architectonisch ontwerp</span>
          <span class="tag" data-val="prototype">Prototype</span>
        </div>
        <p class="field-note" style="margin-bottom:0.5rem;">Participatief</p>
        <div class="tag-group" id="typeParticipatTags" style="margin-bottom:0.65rem;">
          <span class="tag" data-val="workshop">Workshop</span>
          <span class="tag" data-val="educatief programma">Educatief programma</span>
          <span class="tag" data-val="community project">Community project</span>
          <span class="tag" data-val="publiek participatie traject">Publiek participatie traject</span>
        </div>
        <p class="field-note" style="margin-bottom:0.5rem;">Onderzoek</p>
        <div class="tag-group" id="typeOnderzoekTags">
          <span class="tag" data-val="artistiek onderzoek">Artistiek onderzoek</span>
          <span class="tag" data-val="stedelijk onderzoek">Stedelijk onderzoek</span>
          <span class="tag" data-val="materiaalonderzoek">Materiaalonderzoek</span>
          <span class="tag" data-val="archiefonderzoek">Archiefonderzoek</span>
        </div>
      </div>

      <div class="field">
        <label>Maatschappelijke focus <span class="sublabel">(selecteer indien van toepassing)</span></label>
        <div class="tag-group" id="sociaalTags">
          <span class="tag" data-val="polarisatie/radicalisering">Polarisatie / radicalisering</span>
          <span class="tag" data-val="trans-Atlantisch slavernij/erfgoed">Slavernij / erfgoed</span>
          <span class="tag" data-val="klimaat/duurzaamheid">Klimaat / duurzaamheid</span>
          <span class="tag" data-val="sociaal-maatschappelijk">Sociaal-maatschappelijk</span>
          <span class="tag" data-val="inclusie/diversiteit">Inclusie / diversiteit</span>
        </div>
      </div>

      <div class="field">
        <label>Gevraagd subsidiebedrag</label>
        <div class="tag-group" id="bedragTags">
          <span class="tag" data-val="onder â‚¬1.000">Onder â‚¬1.000</span>
          <span class="tag" data-val="â‚¬1.000â€“â‚¬5.000">â‚¬1.000 â€“ â‚¬5.000</span>
          <span class="tag" data-val="â‚¬5.000â€“â‚¬15.000">â‚¬5.000 â€“ â‚¬15.000</span>
          <span class="tag" data-val="â‚¬15.000+">â‚¬15.000+</span>
          <span class="tag" data-val="onbekend">Onbekend</span>
        </div>
      </div>

      <div class="field">
        <label>Eerder subsidie ontvangen van: <span class="sublabel">â€” selecteer alles wat van toepassing is</span></label>
        <div class="tag-group" id="ontvangenTags" style="margin-bottom:0.6rem;">
          <span class="tag" data-val="Stimuleringsfonds" data-fonds="Stimuleringsfonds">Stimuleringsfonds</span>
          <span class="tag" data-val="Mondriaanfonds" data-fonds="Mondriaanfonds">Mondriaanfonds</span>
          <span class="tag" data-val="Fonds Podiumkunsten" data-fonds="Fonds Podiumkunsten">Fonds Podiumkunsten</span>
          <span class="tag" data-val="Filmfonds" data-fonds="Filmfonds">Nederlands Filmfonds</span>
          <span class="tag" data-val="Nederlands Letterenfonds" data-fonds="Nederlands Letterenfonds">Nederlands Letterenfonds</span>
          <span class="tag" data-val="Fonds voor Cultuurparticipatie" data-fonds="Fonds voor Cultuurparticipatie">Fonds voor Cultuurparticipatie</span>
          <span class="tag" data-val="geen eerdere subsidies" data-fonds="">Nee</span>
        </div>
        <div id="regelingInputs" style="display:flex;flex-direction:column;gap:0.35rem;margin-bottom:0.45rem;"></div>
        <input type="text" id="ontvangenAndere" placeholder="Anders: bijv. AFK, VSBFonds, Cultuurfonds...">
      </div>

      <div class="field">
        <label>Extra context <span class="sublabel">(deadlines, partners, bijzonderheden etc.)</span></label>
        <textarea id="extraContext" placeholder="bijv. deadline AFK is oktober, samenwerking met Eye Filmmuseum bevestigd..." style="min-height:65px;"></textarea>
      </div>
    </div>

    <!-- Validation errors placeholder -->
    <div class="validation-errors" id="validationErrors" style="display:none;">
      <h4>Ontbrekende velden</h4>
      <ul id="validationList"></ul>
    </div>

    <button class="cta-btn" onclick="runFullPipeline()">ğŸš€ Start subsidiescan</button>
  </div>

</div><!-- /sectionProject -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  STEP 2 â€” CRAWL + MATCH PROGRESS                              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flow-section" id="sectionProgress">
  <div class="progress-card">
    <div class="progress-title">âŸ³ Bezig met analyseren...</div>
    <div class="step-list">
      <div class="step" id="step1"><span class="step-icon">ğŸ›</span><div class="step-text"><div>Klantprofiel & rechtsvorm analyseren</div><div class="step-detail" id="step1detail"></div></div><div class="spinner-sm" id="spin1" style="display:none;"></div></div>
      <div class="step" id="step2"><span class="step-icon">ğŸ”</span><div class="step-text"><div>Fondsen matchen op discipline en rechtsvorm</div><div class="step-detail" id="step2detail"></div></div><div class="spinner-sm" id="spin2" style="display:none;"></div></div>
      <div class="step" id="step3"><span class="step-icon">ğŸ¤–</span><div class="step-text"><div>Claude â€” diepte-analyse top fondsen</div><div class="step-detail" id="step3detail"></div></div><div class="spinner-sm" id="spin3" style="display:none;"></div></div>
      <div class="step" id="step4"><span class="step-icon">âœ¦</span><div class="step-text"><div>Resultaten samenstellen</div><div class="step-detail" id="step4detail"></div></div></div>
    </div>
    <div class="log-box" id="logBox"></div>
  </div>
</div><!-- /sectionProgress -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  STEP 3 â€” RESULTS                                              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="flow-section" id="sectionResults">

  <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;margin-bottom:1.25rem;flex-wrap:wrap;">
    <div>
      <h2 style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--primary);">Subsidiescan Resultaat</h2>
      <p style="font-size:0.78rem;color:var(--muted);margin-top:0.15rem;" id="resultMeta"></p>
    </div>
    <div class="btn-row">
      <button class="btn-secondary" onclick="copyScanResult()">ğŸ“‹ Kopieren</button>
      <button class="btn-secondary" onclick="window.print()">ğŸ–¨ï¸ Afdrukken</button>
    </div>
  </div>

  <!-- Scan result fondsen cards -->
  <div id="scanResultCards"></div>

  <div style="margin-top:1.25rem;display:flex;gap:0.65rem;flex-wrap:wrap;">
    <button class="reset-btn" onclick="editProject()">âœï¸ Project aanpassen</button>
    <button class="reset-btn" style="color:#c04040;border-color:#e8b0b0;" onclick="resetAll()">ğŸ—‘ï¸ Opnieuw beginnen</button>
  </div>

</div><!-- /sectionResults -->

</div><!-- /main -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  JAVASCRIPT                                                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GLOBAL STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const appState = {
  fondsData:   null,   // crawl result
  projectData: null,   // collected project form
  matchResult: null    // match engine output
};

let websiteContext  = '';
let documentContext = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function stripHtml(html) {
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

function toggleKey(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type === 'password' ? 'text' : 'password';
  btn.textContent = el.type === 'password' ? 'toon' : 'verberg';
}

function getKey(id) { return document.getElementById(id)?.value?.trim() || ''; }

function getSelected(id) {
  return [...document.querySelectorAll(`#${id} .tag.selected`)].map(t => t.dataset.val);
}

function markUncertain(str) {
  return str.replace(/ONZEKER â€“ handmatig controleren/g,
    '<span class="uncertain">âš  ONZEKER â€“ controleer</span>');
}

function toggleRaw(jsonId, toggleId) {
  const raw = document.getElementById(jsonId);
  const tog = document.getElementById(toggleId);
  const isOpen = raw.style.display === 'block';
  raw.style.display = isOpen ? 'none' : 'block';
  tog.textContent = isOpen ? 'â–¸ Bekijk ruwe JSON' : 'â–¾ Verberg ruwe JSON';
}

async function callClaude(claudeKey, messages, maxTokens = 4000) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
      'x-api-key': claudeKey
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      messages
    })
  });
  const data = await resp.json();
  if (!resp.ok || data.error) throw new Error(data.error?.message || `Claude fout ${resp.status}`);
  return data.content?.map(c => c.text || '').join('') || '';
}

function parseJsonResponse(text) {
  // Try: ```json ... ```
  let m = text.match(/```json\s*([\s\S]*?)\s*```/);
  if (m) try { return JSON.parse(m[1]); } catch {}
  // Try: ``` ... ```
  m = text.match(/```\s*([\s\S]*?)\s*```/);
  if (m) try { return JSON.parse(m[1]); } catch {}
  // Try: outermost [ ... ]
  m = text.match(/(\[[\s\S]*\])/);
  if (m) try { return JSON.parse(m[1]); } catch {}
  // Try: outermost { ... }
  m = text.match(/(\{[\s\S]*\})/);
  if (m) try { return JSON.parse(m[1]); } catch {}
  // Last resort: raw text
  return JSON.parse(text);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION â€” LINEAR FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSection(sectionId) {
  document.querySelectorAll('.flow-section').forEach(s => s.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
  window.scrollTo(0, 0);
}

function updatePipeline(activeStep) {
  const steps = ['pipeProject','pipeScan','pipeResults'];
  const order = { project: 0, scan: 1, results: 2 };
  const activeIdx = order[activeStep] ?? 0;
  steps.forEach((id, i) => {
    const el = document.getElementById(id);
    el.className = 'pipe-step' + (i < activeIdx ? ' done' : i === activeIdx ? ' active' : '');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGGING & PROGRESS STEPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function log(msg, type = '') {
  const box = document.getElementById('logBox');
  if (!box) return;
  const ts = new Date().toLocaleTimeString('nl-NL', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const cls = { ok:'log-ok', warn:'log-warn', err:'log-err' }[type] || '';
  box.innerHTML += `<div><span class="log-ts">[${ts}]</span><span class="${cls}">${escHtml(msg)}</span></div>`;
  box.scrollTop = box.scrollHeight;
}

const STEP_ICONS = { 1:'ğŸ›', 2:'ğŸ”', 3:'ğŸ¤–', 4:'âœ¦' };
function setStep(n, state, detail = '') {
  const step = document.getElementById(`step${n}`);
  const spin = document.getElementById(`spin${n}`);
  if (!step) return;
  step.className = 'step ' + state;
  if (detail) document.getElementById(`step${n}detail`).textContent = detail;
  if (spin) spin.style.display = state === 'active' ? 'block' : 'none';
  step.querySelector('.step-icon').textContent =
    state === 'done' ? 'âœ…' : state === 'error' ? 'âŒ' : STEP_ICONS[n];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VALIDATION (requirement 6)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function validateProjectData(pd) {
  const errors = [];
  if (!pd.projectOmschrijving && pd.disciplines.length === 0)
    errors.push('Vul minimaal een projectomschrijving of discipline in.');
  if (pd.rechtsvorm.length === 0)
    errors.push('Selecteer een rechtsvorm (nodig voor uitsluitingscheck).');
  return errors;
}

function validateFondsData(fd) {
  const errors = [];
  if (!fd) { errors.push('Geen fondsdata beschikbaar.'); return errors; }
  if (!fd.fonds_naam) errors.push('Fonds naam ontbreekt in crawlresultaat.');
  if (!fd.regelingen || fd.regelingen.length === 0) errors.push('Geen regelingen gevonden in fondsdata.');
  return errors;
}

function validateKeys() {
  const errors = [];
  if (!getKey('claudeApiKey')) errors.push('Claude API key ontbreekt.');
  if (!getKey('apifyToken')) errors.push('Apify API token ontbreekt.');
  if (!getKey('serpApiKey')) errors.push('SerpAPI key ontbreekt.');
  return errors;
}

function showValidationErrors(errors) {
  const container = document.getElementById('validationErrors');
  const list = document.getElementById('validationList');
  if (errors.length === 0) { container.style.display = 'none'; return false; }
  list.innerHTML = errors.map(e => `<li>${escHtml(e)}</li>`).join('');
  container.style.display = 'block';
  container.scrollIntoView({ behavior: 'smooth', block: 'center' });
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FONDSEN DATABASE â€” static list of Dutch art/culture funds
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FONDSEN_DB = [
  { naam:"Stimuleringsfonds Creatieve Industrie", focus:"design, architectuur, digitale cultuur, vormgeving", url:"https://www.stimuleringsfonds.nl/subsidies", disciplines:["design","architectuur","digitale cultuur"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","kunstenaarscollectief (informeel)"] },
  { naam:"Mondriaanfonds", focus:"beeldende kunst, fotografie, internationale presentatie", url:"https://www.mondriaanfonds.nl", disciplines:["beeldende kunst","fotografie"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"] },
  { naam:"Nederlands Filmfonds", focus:"film, documentaire, animatie, korte film", url:"https://www.filmfonds.nl", disciplines:["film"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","bv/nv (commercieel)"] },
  { naam:"Cultuurfonds", focus:"project over meerdere disciplines", url:"https://www.cultuurfonds.nl", disciplines:["beeldende kunst","muziek","theater","dans","literatuur","fotografie","erfgoed","interdisciplinair","mode/textiel"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging","kunstenaarscollectief (informeel)"] },
  { naam:"Fonds voor Cultuurparticipatie", focus:"participatie, educatie, amateurkunst", url:"https://cultuurparticipatie.nl", disciplines:["educatie","podiumkunsten","muziek","dans","theater","beeldende kunst"], rechtsvormen:["stichting","vereniging"] },
  { naam:"Fonds ZOZ", focus:"polarisatie en radicalisering verminderen in NL", url:"https://fondszoz.nl", disciplines:["interdisciplinair","theater","muziek","beeldende kunst","film"], sociaal:"polarisatie/radicalisering", rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam:"DNB Fonds", focus:"trans-Atlantisch slavernij erfgoed, Caribisch NL", url:"https://www.cultuurfonds.nl/fondsen/dnb-fonds", disciplines:["beeldende kunst","theater","dans","literatuur","interdisciplinair","film"], sociaal:"trans-Atlantisch slavernij/erfgoed", rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam:"VSBFonds", focus:"educatie, participatie, cultuur", url:"https://www.vsbfonds.nl", disciplines:["beeldende kunst","muziek","theater","dans","podiumkunsten"], rechtsvormen:["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam:"Amsterdam Fonds voor de Kunsten", focus:"Amsterdam-gebaseerde kunstenaars", url:"https://www.amsterdamsfondsvoordekunsten.nl", disciplines:["beeldende kunst","muziek","theater","dans","film","literatuur","interdisciplinair","fotografie"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","kunstenaarscollectief (informeel)"], regio:"amsterdam" },
  { naam:"Prins Clausfonds", focus:"kunstenaars met niet-Europese culturele achtergrond", url:"https://princeclausfund.nl", disciplines:["interdisciplinair","beeldende kunst","dans","muziek","theater","film"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"] },
  { naam:"Dioraphte", focus:"podiumkunsten, erfgoed, sociale initiatieven Afrika/NL", url:"https://dioraphte.nl", disciplines:["theater","dans","muziek","erfgoed","beeldende kunst","podiumkunsten"], rechtsvormen:["stichting","vereniging"] },
  { naam:"Stichting DOEN", focus:"sociale en culturele vernieuwing, klimaat", url:"https://www.doen.nl", disciplines:["interdisciplinair","theater","beeldende kunst","muziek","dans"], sociaal:"sociaal-maatschappelijk", rechtsvormen:["stichting","vereniging"] },
  { naam:"Stichting Stokroos", focus:"beeldend kunstenaars/vormgevers 3-8 jaar actief", url:"https://stokroos.nl/home", disciplines:["beeldende kunst","design","mode/textiel"], rechtsvormen:["individuele kunstenaar (zzp)"] },
  { naam:"K.F. Hein Fonds", focus:"kunstenaars en ontwerpers, Utrecht regio", url:"https://kfhein.nl", disciplines:["beeldende kunst","muziek","theater","dans","design"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging"], regio:"utrecht" },
  { naam:"Amarte Fonds", focus:"muziek, film, theater, beeldende kunst, literatuur", url:"https://www.amarte.nl/nl", disciplines:["muziek","film","theater","beeldende kunst","literatuur","interdisciplinair"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"] },
  { naam:"Stichting Niemeijer Fonds", focus:"begin van carriÃ¨re of nieuwe ontwikkeling", url:"https://www.stichtingniemeijerfonds.nl", disciplines:["beeldende kunst","fotografie","interdisciplinair","muziek","theater"], rechtsvormen:["individuele kunstenaar (zzp)"] },
  { naam:"Gieskes-Strijbis Fonds", focus:"natuur/milieu, kunst en cultuur, democratie", url:"https://www.gieskesstrijbisfonds.nl", disciplines:["beeldende kunst","theater","interdisciplinair","erfgoed"], rechtsvormen:["stichting","vereniging"] },
  { naam:"NPO Fonds", focus:"video, audio, talentontwikkeling", url:"https://npo.nl/npofonds", disciplines:["film","digitale cultuur","muziek"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","bv/nv (commercieel)"] },
  { naam:"Ammodo Art", focus:"internationaal toonaangevende beeldende kunst en podiumkunst", url:"https://www.ammodo-art.org", disciplines:["beeldende kunst","dans","theater","muziek","podiumkunsten"], rechtsvormen:["stichting","vereniging"] },
  { naam:"Stroom Den Haag", focus:"beeldende kunst Den Haag", url:"https://stroom.nl", disciplines:["beeldende kunst","fotografie","digitale cultuur"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"], regio:"den haag" },
  { naam:"CBK Rotterdam", focus:"beeldende kunst Rotterdam", url:"https://cbk.nl", disciplines:["beeldende kunst","fotografie","interdisciplinair"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"], regio:"rotterdam" },
  { naam:"Filmcommission NL", focus:"feature film, animatie, documentaire", url:"https://filmcommission.nl/fund-financing/", disciplines:["film"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","bv/nv (commercieel)"] },
  { naam:"Cultuurfonds â€” Prins Bernhard", focus:"diverse disciplines, regionaal fonds", url:"https://www.cultuurfonds.nl/prins-bernhard-cultuurfonds", disciplines:["beeldende kunst","muziek","theater","dans","literatuur","erfgoed","film"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging","kunstenaarscollectief (informeel)"] },
  { naam:"Fondskwadraat", focus:"rentevrije leningen onder â‚¬8.000", url:"https://www.fondskwadraat.nl", disciplines:["beeldende kunst","muziek","theater","dans","interdisciplinair","design"], rechtsvormen:["individuele kunstenaar (zzp)","kunstenaarscollectief (informeel)"] },
  { naam:"Fonds Podiumkunsten", focus:"theater, dans, muziek, muziektheater", url:"https://fondspodiumkunsten.nl", disciplines:["theater","dans","muziek","podiumkunsten"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","bv/nv (commercieel)"] },
  { naam:"Nederlands Letterenfonds", focus:"literatuur, vertaling, graphic novels", url:"https://www.letterenfonds.nl", disciplines:["literatuur"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"] },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRE-SCORING â€” match fondsen against project profile
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function preScoreFondsen(project) {
  const discSet   = new Set(project.disciplines.map(d => d.toLowerCase()));
  const rvSet     = new Set(project.rechtsvorm.map(r => r.toLowerCase()));
  const regioLow  = (project.regio || '').toLowerCase();
  const sociaal   = (project.sociaal || []).join(' ').toLowerCase();
  const prevNames = new Set((project.alleOntvangen || []).map(p => p.toLowerCase()));

  return FONDSEN_DB.map(f => {
    // Skip funds already received
    if (prevNames.size > 0 && Array.from(prevNames).some(p =>
      f.naam.toLowerCase().includes(p) || p.includes(f.naam.toLowerCase().split(' ')[0])
    )) return { ...f, _score: -99 };

    let score = 0;

    // Discipline match (primary signal)
    score += f.disciplines.filter(d => discSet.has(d)).length * 4;
    // Broad disciplines get a base
    if (f.disciplines.some(d => ['interdisciplinair','breed'].includes(d))) score += 1;
    // Regio bonus
    if (f.regio && regioLow.includes(f.regio)) score += 6;
    // Sociaal match
    if (f.sociaal && sociaal.includes(f.sociaal.split('/')[0])) score += 8;
    // Rechtsvorm compatibility (priority 1 â€” uitsluitingscriterium)
    if (rvSet.size > 0) {
      const rvMatch = f.rechtsvormen?.some(r => rvSet.has(r.toLowerCase()));
      score += rvMatch ? 3 : -20; // hard penalty for rechtsvorm mismatch
    }
    // Cultural background â†’ Prins Clausfonds bonus
    if (project.achtergrond && f.naam.toLowerCase().includes('prins claus')) score += 6;

    return { ...f, _score: score };
  })
  .filter(f => f._score > 0)
  .sort((a, b) => b._score - a._score);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FULL PIPELINE â€” database scan + Claude analysis
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runFullPipeline() {
  // Collect & validate
  const pd = collectProjectData();

  const keyErrors = validateKeys();
  const projErrors = validateProjectData(pd);
  const allErrors = [...keyErrors, ...projErrors];
  if (showValidationErrors(allErrors)) return;

  document.getElementById('validationErrors').style.display = 'none';
  appState.projectData = pd;

  // Switch to progress view
  showSection('sectionProgress');
  updatePipeline('scan');
  document.getElementById('logBox').innerHTML = '';

  try {
    // Step 1 â€” Profile analysis
    setStep(1, 'active', 'Profiel analyseren...');
    log('Klantprofiel geladen: ' + (pd.naam || 'kunstenaar'));
    log(`Disciplines: ${pd.disciplines.join(', ') || 'niet opgegeven'}`);
    log(`Rechtsvorm: ${pd.rechtsvorm.join(', ') || 'niet opgegeven'}`);
    log(`Regio: ${pd.regio || 'niet opgegeven'}`);
    await sleep(300);
    setStep(1, 'done', 'Profiel geanalyseerd');

    // Step 2 â€” Pre-score fondsen from database
    setStep(2, 'active', 'Fondsen matchen...');
    log(`Database: ${FONDSEN_DB.length} fondsen beschikbaar`);
    const ranked = preScoreFondsen(pd);
    const topFondsen = ranked.slice(0, 10); // take top 10 candidates for Claude
    log(`${ranked.length} fondsen matchen op profiel â€” top ${topFondsen.length} geselecteerd`, 'ok');
    topFondsen.forEach((f, i) => log(`  ${i+1}. ${f.naam} (prescore ${f._score})`));
    setStep(2, 'done', `${topFondsen.length} fondsen geselecteerd`);

    if (topFondsen.length === 0) {
      throw new Error('Geen passende fondsen gevonden. Controleer je disciplines en rechtsvorm.');
    }

    // Step 3 â€” Claude deep analysis
    setStep(3, 'active', 'Claude analyseert top fondsen...');
    log('Claude API aanroepen voor diepte-analyse...');

    const fondsListJson = JSON.stringify(topFondsen.map(f => ({
      naam: f.naam,
      focus: f.focus,
      url: f.url,
      disciplines: f.disciplines,
      rechtsvormen: f.rechtsvormen,
      regio: f.regio || null,
      sociaal: f.sociaal || null
    })), null, 2);

    const scanPrompt = `Je bent een subsidie-analist voor Nederlandse kunst- en cultuurfondsen.

PROJECT:
- Naam: ${pd.naam || 'niet opgegeven'}
- Rechtsvorm: ${pd.rechtsvorm?.join(', ') || 'niet opgegeven'}
- Disciplines: ${pd.disciplines?.join(', ') || 'niet opgegeven'}
- Carrierefase: ${pd.fase?.join(', ') || 'niet opgegeven'}
- Woonplaats: ${pd.regio || 'niet opgegeven'}
- Culturele achtergrond: ${pd.achtergrond || 'niet opgegeven'}
- Projectomschrijving: ${pd.projectOmschrijving || 'niet opgegeven'}
- Primair doel: ${pd.doel?.join(', ') || 'niet opgegeven'}
- Projectfase: ${pd.faseProj?.join(', ') || 'niet opgegeven'}
- Type activiteit: ${pd.typeProject?.join(', ') || 'niet opgegeven'}
- Maatschappelijke focus: ${pd.sociaal?.join(', ') || 'geen'}
- Gevraagd bedrag: ${pd.bedrag?.join(', ') || 'onbekend'}
- Extra context: ${pd.extraContext || 'geen'}
${pd.alleOntvangen?.length > 0 ? '- Eerder ontvangen: ' + pd.alleOntvangen.join(', ') : ''}
${pd.websiteContext ? '\nPORTFOLIO/WEBSITE:\n' + pd.websiteContext.substring(0, 1200) : ''}
${pd.documentContext ? '\nDOCUMENT CONTEXT:\n' + pd.documentContext.substring(0, 800) : ''}

FONDSEN (voorgefilterd op discipline en rechtsvorm):
${fondsListJson}

OPDRACHT:
Analyseer elk fonds en geef een match_score van 0-100 per fonds.
Focus op:
1. UITSLUITINGSCRITERIA (priority 1): Is de rechtsvorm van de aanvrager compatibel?
2. Discipline match: Past het project bij het fonds?
3. Fase/profiel match: Past de carrierefase en het type project?
4. Regio: Regionale fondsen alleen relevant als aanvrager in dat gebied zit
5. Sociaal/thematisch: Sluit het thema aan?

Scorebereik:
- 80-100: Uitstekende match
- 60-79: Goede match, kleine risico's
- 40-59: Matige match
- 20-39: Zwakke match
- 0: Uitgesloten (rechtsvorm niet compatibel)

Geef de TOP 8 best matchende fondsen. Geef uitsluitend JSON output.
Begin met [ en eindig met ].

[
  {
    "fonds_naam": "string",
    "fonds_url": "string",
    "match_score": number (0-100),
    "disciplines_match": "string (welke disciplines matchen)",
    "regeling_suggestie": "string (meest geschikte regeling of type)",
    "deadline_info": "string (als bekend, anders 'Controleer website')",
    "bedrag_info": "string (als bekend, anders 'Zie website')",
    "fase_match": "string (welke fase past)",
    "risico_factoren": ["string (max 3 risico's/aandachtspunten)"],
    "match_motivatie": "string (2-3 zinnen waarom dit fonds past)",
    "aanbeveling": "string (1 concrete actie/tip)"
  }
]`;

    const claudeKey = getKey('claudeApiKey');
    const rawText = await callClaude(claudeKey, [{ role: 'user', content: scanPrompt }], 4000);
    let scanResults;
    try {
      scanResults = parseJsonResponse(rawText);
    } catch(e) {
      log('Claude raw output: ' + rawText.substring(0, 500), 'warn');
      throw new Error('Claude JSON parse mislukt: ' + e.message);
    }
    if (!Array.isArray(scanResults)) {
      // If Claude returned an object with a key containing the array
      const arr = scanResults.fondsen || scanResults.results || scanResults.matches || scanResults.data;
      if (Array.isArray(arr)) { scanResults = arr; }
      else { throw new Error('Claude gaf geen array terug. Probeer opnieuw.'); }
    }

    // Normalize scores
    scanResults = scanResults.map(r => ({
      ...r,
      match_score: typeof r.match_score === 'number' ? Math.max(0, Math.min(100, r.match_score)) : 0
    })).sort((a, b) => b.match_score - a.match_score).slice(0, 8);

    appState.matchResult = scanResults;
    log(`Claude analyse klaar â€” ${scanResults.length} fondsen gescoord`, 'ok');
    setStep(3, 'done', `${scanResults.length} fondsen geanalyseerd`);

    // Step 4 â€” Render results
    setStep(4, 'active', 'Resultaten samenstellen...');
    renderScanResults(scanResults, pd);
    setStep(4, 'done', 'Gereed');

    await sleep(400);
    showSection('sectionResults');
    updatePipeline('results');

  } catch(err) {
    log(`FOUT: ${err.message}`, 'err');
    [1,2,3,4].forEach(n => {
      if (document.getElementById(`step${n}`)?.classList.contains('active'))
        setStep(n, 'error', err.message);
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERING â€” SCAN RESULTS (card-based layout)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderScanResults(results, project) {
  const now = new Date().toLocaleDateString('nl-NL', { day:'numeric', month:'long', year:'numeric' });
  document.getElementById('resultMeta').textContent =
    `${now} â€” ${project.naam || project.disciplines?.join(', ') || 'project'} â€” ${results.length} fondsen geanalyseerd`;

  let html = '';
  results.forEach((r, i) => {
    html += renderFondsCard(r, i);
  });

  if (results.length === 0) {
    html = '<div style="text-align:center;padding:3rem;color:var(--muted);"><div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ”</div><h3>Geen passende fondsen gevonden</h3><p>Probeer je disciplines of rechtsvorm aan te passen.</p></div>';
  }

  document.getElementById('scanResultCards').innerHTML = html;

  // Open first card
  if (results.length > 0) toggleResultCard(0);
}

function renderFondsCard(r, i) {
  const score = r.match_score || 0;
  const sc = score >= 70 ? 'score-high' : score >= 40 ? 'score-mid' : score > 0 ? 'score-low' : 'score-excluded';
  const sl = score >= 70 ? `${score} â€” HOOG` : score >= 40 ? `${score} â€” MIDDEL` : score > 0 ? `${score} â€” LAAG` : 'UITGESLOTEN';
  const fillClass = score >= 70 ? '' : score >= 40 ? 'mid' : 'low';

  const risicos = (r.risico_factoren || []).map(rf =>
    `<li style="margin:0.15rem 0;font-size:0.82rem;">${escHtml(rf)}</li>`).join('');

  return `
  <div class="regeling-card">
    <div class="regeling-header" onclick="toggleResultCard(${i})" id="rchdr${i}">
      <div style="flex:1;min-width:0;">
        <div class="regeling-name">${escHtml(r.fonds_naam || 'Onbekend fonds')}</div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:0.1rem;">${escHtml(r.regeling_suggestie || '')}</div>
      </div>
      <span class="score-badge ${sc}">${sl}</span>
      <span class="chevron" id="rcchev${i}">â–¾</span>
    </div>
    <div class="regeling-body" id="rcbody${i}">
      <p class="match-motivation">${escHtml(r.match_motivatie || '')}</p>

      <div class="score-bar-wrap" style="margin-bottom:0.85rem;">
        <div style="display:flex;justify-content:space-between;font-size:0.76rem;margin-bottom:0.25rem;"><span>Matchscore</span><strong>${score}%</strong></div>
        <div class="score-bar"><div class="score-fill ${fillClass}" style="width:${score}%;"></div></div>
      </div>

      <div class="data-grid">
        <div class="data-cell"><div class="dc-label">Website</div><div class="dc-value"><a href="${escHtml(r.fonds_url || '#')}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none;">${escHtml(r.fonds_url || 'â€”')} â†—</a></div></div>
        <div class="data-cell"><div class="dc-label">Disciplines</div><div class="dc-value">${escHtml(r.disciplines_match || 'â€”')}</div></div>
        <div class="data-cell highlight"><div class="dc-label">Regeling</div><div class="dc-value">${escHtml(r.regeling_suggestie || 'â€”')}</div></div>
        <div class="data-cell highlight"><div class="dc-label">Deadline</div><div class="dc-value">${escHtml(r.deadline_info || 'Controleer website')}</div></div>
        <div class="data-cell"><div class="dc-label">Fase</div><div class="dc-value">${escHtml(r.fase_match || 'â€”')}</div></div>
        <div class="data-cell"><div class="dc-label">Bedrag</div><div class="dc-value">${escHtml(r.bedrag_info || 'Zie website')}</div></div>
      </div>

      ${risicos ? `<div style="margin-top:0.75rem;"><div style="font-size:0.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.35rem;">âš ï¸ Risico's / aandachtspunten</div><ul style="padding-left:1.1rem;">${risicos}</ul></div>` : ''}

      ${r.aanbeveling ? `<div style="margin-top:0.75rem;padding:0.65rem 0.9rem;background:#f3f1fc;border-radius:9px;font-size:0.82rem;color:var(--primary);font-weight:600;">ğŸ’¡ ${escHtml(r.aanbeveling)}</div>` : ''}
    </div>
  </div>`;
}

function toggleResultCard(i) {
  const body = document.getElementById(`rcbody${i}`);
  const chev = document.getElementById(`rcchev${i}`);
  const hdr  = document.getElementById(`rchdr${i}`);
  if (!body) return;
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  if (chev) chev.classList.toggle('open', !isOpen);
  if (hdr)  hdr.classList.toggle('open', !isOpen);
}

function copyScanResult() {
  if (!appState.matchResult) return;
  navigator.clipboard.writeText(JSON.stringify(appState.matchResult, null, 2)).then(() => {
    const b = event.target; b.textContent = 'âœ“ Gekopieerd!';
    setTimeout(() => b.textContent = 'ğŸ“‹ Kopieren', 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROJECT FORM LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tag-group').forEach(group => {
  group.querySelectorAll('.tag').forEach(tag => {
    tag.addEventListener('click', () => tag.classList.toggle('selected'));
  });
});
document.querySelectorAll('#ontvangenTags .tag').forEach(tag => {
  tag.addEventListener('click', updateRegelingInputs);
});

function updateRegelingInputs() {
  const container = document.getElementById('regelingInputs');
  container.innerHTML = '';
  document.querySelectorAll('#ontvangenTags .tag.selected').forEach(tag => {
    const fonds = tag.dataset.fonds;
    if (!fonds) return;
    const wrap = document.createElement('div');
    wrap.style.cssText = 'display:flex;align-items:center;gap:0.45rem;';
    const lbl = document.createElement('span');
    lbl.textContent = fonds + ':';
    lbl.style.cssText = 'font-size:0.76rem;font-weight:600;color:var(--primary);white-space:nowrap;min-width:155px;';
    const inp = document.createElement('input');
    inp.type = 'text'; inp.placeholder = 'Welke regeling? bijv. Talentontwikkeling...';
    inp.dataset.fonds = fonds; inp.id = 'regeling_' + fonds.replace(/\s/g,'_');
    inp.style.cssText = 'flex:1;padding:0.4rem 0.7rem;font-size:0.8rem;';
    wrap.appendChild(lbl); wrap.appendChild(inp);
    container.appendChild(wrap);
  });
}

const REGIO_FONDSEN = {
  'amsterdam': { fondsen: ['Amsterdam Fonds voor de Kunsten (AFK)','W139','Stichting Elise Mathilde Fonds'], gemeentelijk: 'Gemeente Amsterdam â€” Kunst & Cultuur subsidies' },
  'den haag':  { fondsen: ['Stroom Den Haag','Gemeente Den Haag Cultuursubsidie'], gemeentelijk: 'Gemeente Den Haag â€” cultuursubsidies' },
  'rotterdam': { fondsen: ['CBK Rotterdam','Cultuurfonds Regio Rotterdam'], gemeentelijk: 'Gemeente Rotterdam â€” Cultuursubsidies' },
  'utrecht':   { fondsen: ['K.F. Hein Fonds','Cultuurfonds Regio Utrecht'], gemeentelijk: 'Gemeente Utrecht â€” Cultuursubsidies' },
  'eindhoven': { fondsen: ['Cultuurfonds Regio Noord-Brabant','Jan Naaijkens Fonds'], gemeentelijk: 'Gemeente Eindhoven â€” Cultuur en Erfgoed' },
  'groningen': { fondsen: ['Cultuurfonds Regio Groningen','Noorderpoort Fonds'], gemeentelijk: 'Gemeente Groningen â€” Cultuursubsidies' },
  'arnhem':    { fondsen: ['Cultuurfonds Regio Gelderland'], gemeentelijk: 'Gemeente Arnhem â€” Cultuursubsidie' },
  'tilburg':   { fondsen: ['Cultuurfonds Regio Noord-Brabant'], gemeentelijk: 'Gemeente Tilburg â€” Cultuursubsidies' },
};

function updateRegioInfo(val) {
  const key = Object.keys(REGIO_FONDSEN).find(k => val.toLowerCase().includes(k));
  const box = document.getElementById('regioInfo');
  if (key) {
    const r = REGIO_FONDSEN[key];
    box.innerHTML = `<strong>ğŸ“ Regionale fondsen voor ${val}:</strong>${r.fondsen.join(', ')} â€” en: ${r.gemeentelijk}`;
    box.classList.add('visible');
  } else {
    box.classList.remove('visible');
  }
}

async function fetchWebsite() {
  const url = document.getElementById('portfolioUrl').value.trim();
  const claudeKey = getKey('claudeApiKey');
  if (!url) return alert('Vul een URL in.');
  if (!claudeKey) return alert('Vul eerst je Claude API key in bovenaan.');
  const status = document.getElementById('urlStatus');
  const preview = document.getElementById('urlPreview');
  const btn = document.getElementById('fetchBtn');
  status.className = 'status-msg loading'; status.textContent = 'â³ Website wordt gelezen...';
  preview.classList.remove('visible'); btn.disabled = true;
  try {
    const text = await callClaude(claudeKey, [{ role:'user', content:`Haal de belangrijkste informatie op van deze website voor een subsidiescan van een Nederlandse kunstenaar. URL: ${url}\n\nZoek naar: naam, discipline, vertoningsgeschiedenis, festivals, instellingen, prijzen, samenwerkingen, lopende projecten. Wees feitelijk en specifiek.` }], 1000);
    websiteContext = text;
    if (text.length < 50 || text.toLowerCase().includes('niet kunt bereiken')) {
      status.className = 'status-msg error'; status.textContent = 'âš ï¸ Website kon niet worden gelezen.'; websiteContext = '';
    } else {
      status.className = 'status-msg success'; status.textContent = 'âœ“ Website gelezen â€” wordt meegenomen in de scan.';
      preview.textContent = text.substring(0,300)+'...'; preview.classList.add('visible');
    }
  } catch(e) {
    status.className = 'status-msg error'; status.textContent = 'âš ï¸ Fout bij ophalen: ' + e.message; websiteContext = '';
  }
  btn.disabled = false;
}

function handleFileUpload(input) {
  const file = input.files[0]; if (!file) return;
  const status = document.getElementById('fileStatus');
  const preview = document.getElementById('filePreview');
  if (file.size > 20*1024*1024) { status.className='status-msg error'; status.textContent='âš ï¸ Bestand te groot (max 20MB).'; return; }
  status.className='status-msg loading'; status.textContent=`â³ "${file.name}" wordt ingelezen...`;
  preview.classList.remove('visible');
  const claudeKey = getKey('claudeApiKey');
  if (!claudeKey) { status.className='status-msg error'; status.textContent='âš ï¸ Vul eerst je Claude API key in.'; return; }
  const isPDF = file.type==='application/pdf' || file.name.toLowerCase().endsWith('.pdf');
  if (isPDF) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const bytes = new Uint8Array(e.target.result);
        let binary = ''; for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);
        const base64 = btoa(binary);
        const text = await callClaude(claudeKey, [{role:'user',content:[
          {type:'document',source:{type:'base64',media_type:'application/pdf',data:base64}},
          {type:'text',text:'Lees dit document volledig en geef een uitgebreide samenvatting van alle informatie relevant voor een Nederlandse subsidieaanvraag. Beschrijf: discipline, project, vertoningsgeschiedenis, partners, lopende subsidies, budget, LOI\'s. Wees specifiek.'}
        ]}], 1000);
        documentContext = text;
        if (!text.trim()) throw new Error('Geen tekst gevonden');
        status.className='status-msg success'; status.textContent=`âœ“ "${file.name}" ingelezen.`;
        preview.textContent=text.substring(0,400)+'...'; preview.classList.add('visible');
      } catch(err) {
        status.className='status-msg error'; status.textContent=`âš ï¸ PDF fout: ${err.message}`;
      }
    };
    reader.readAsArrayBuffer(file);
  } else {
    const reader = new FileReader();
    reader.onload = (e) => {
      documentContext = e.target.result.substring(0,8000);
      status.className='status-msg success'; status.textContent=`âœ“ "${file.name}" ingelezen.`;
      preview.textContent=documentContext.substring(0,300)+'...'; preview.classList.add('visible');
    };
    reader.readAsText(file,'UTF-8');
  }
}

function togglePaste() { document.getElementById('pasteArea').classList.toggle('visible'); }
function savePastedText() {
  const text = document.getElementById('pasteText').value.trim(); if (!text) return;
  documentContext = text.substring(0,8000);
  document.getElementById('fileStatus').className='status-msg success'; document.getElementById('fileStatus').textContent='âœ“ Tekst opgeslagen als context.';
  const preview=document.getElementById('filePreview'); preview.textContent=documentContext.substring(0,300)+(documentContext.length>300?'...':''); preview.classList.add('visible');
  document.getElementById('pasteArea').classList.remove('visible');
}

const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragover'); if(e.dataTransfer.files[0]) handleFileUpload({files:e.dataTransfer.files}); });

function collectProjectData() {
  const typeProject = [...getSelected('typeArtistiekTags'), ...getSelected('typeParticipatTags'), ...getSelected('typeOnderzoekTags')];
  const ontvangenFondsen = getSelected('ontvangenTags');
  const regelingPerFonds = [];
  document.querySelectorAll('#regelingInputs input').forEach(inp => {
    const fonds = inp.dataset.fonds;
    const reg = inp.value.trim();
    regelingPerFonds.push(fonds + (reg ? ` â€” ${reg}` : ''));
  });
  const ontvangenAndere = document.getElementById('ontvangenAndere').value.trim();
  const alleOntvangen = [...regelingPerFonds, ...(ontvangenAndere ? ontvangenAndere.split(',').map(s=>s.trim()) : [])].filter(Boolean);
  return {
    naam: document.getElementById('naam').value.trim(),
    regio: document.getElementById('regio').value.trim(),
    achtergrond: document.getElementById('achtergrond').value.trim(),
    projectOmschrijving: document.getElementById('projectOmschrijving').value.trim(),
    extraContext: document.getElementById('extraContext').value.trim(),
    rechtsvorm: getSelected('rechtsVormTags'),
    disciplines: getSelected('disciplineTags'),
    fase: getSelected('faseTags'),
    faseProj: getSelected('faseProjTags'),
    doel: getSelected('doelTags'),
    typeProject,
    locatie: getSelected('locatieTags'),
    sociaal: getSelected('sociaalTags'),
    bedrag: getSelected('bedragTags'),
    ontvangenFondsen,
    alleOntvangen,
    websiteContext,
    documentContext
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIONS â€” EDIT / RESET / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editProject() {
  showSection('sectionProject');
  updatePipeline('project');
}

function resetAll() {
  appState.fondsData = null; appState.projectData = null; appState.matchResult = null;
  websiteContext = ''; documentContext = '';
  document.querySelectorAll('#sectionProject input[type="text"], #sectionProject input[type="url"], #sectionProject textarea').forEach(el => {
    if (!['claudeApiKey','apifyToken','serpApiKey'].includes(el.id)) el.value = '';
  });
  document.querySelectorAll('#sectionProject .tag.selected').forEach(t => t.classList.remove('selected'));
  document.getElementById('regelingInputs').innerHTML = '';
  ['urlStatus','urlPreview','fileStatus','filePreview'].forEach(id => {
    const el = document.getElementById(id);
    if(el){ el.className = el.className.includes('preview') ? 'context-preview' : 'status-msg'; }
  });
  document.getElementById('logBox').innerHTML = '';
  document.getElementById('scanResultCards').innerHTML = '';
  [1,2,3,4].forEach(n => {
    setStep(n, '', '');
    const d = document.getElementById(`step${n}detail`);
    if(d) d.textContent = '';
  });
  document.getElementById('validationErrors').style.display = 'none';
  showSection('sectionProject');
  updatePipeline('project');
}

function copyResultJson() {
  if (!appState.matchResult) return;
  const fullData = { fonds: appState.fondsData, matches: appState.matchResult };
  navigator.clipboard.writeText(JSON.stringify(fullData, null, 2)).then(() => {
    const b = event.target; b.textContent = 'âœ“ Gekopieerd!';
    setTimeout(() => b.textContent = 'ğŸ“‹ JSON kopieren', 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT â€” auto-load API keys from .env via server
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updatePipeline('project');

/**
 * Key loading priority:
 * 1. .env via /api/keys (localhost dev server)
 * 2. localStorage (GitHub Pages â€” saved from previous session)
 * 3. One-time setup dialog (first visit on GitHub Pages)
 */
(async function loadKeys() {
  // Try 1: .env via local server
  try {
    const resp = await fetch('/api/keys');
    if (resp.ok) {
      const keys = await resp.json();
      if (keys.claudeApiKey && keys.apifyToken && keys.serpApiKey) {
        document.getElementById('claudeApiKey').value = keys.claudeApiKey;
        document.getElementById('apifyToken').value   = keys.apifyToken;
        document.getElementById('serpApiKey').value    = keys.serpApiKey;
        console.log('API keys geladen uit .env');
        return;
      }
    }
  } catch { /* not on localhost â€” continue */ }

  // Try 2: localStorage
  const saved = localStorage.getItem('subsidietool_keys');
  if (saved) {
    try {
      const keys = JSON.parse(saved);
      if (keys.claudeApiKey && keys.apifyToken && keys.serpApiKey) {
        document.getElementById('claudeApiKey').value = keys.claudeApiKey;
        document.getElementById('apifyToken').value   = keys.apifyToken;
        document.getElementById('serpApiKey').value    = keys.serpApiKey;
        console.log('API keys geladen uit localStorage');
        return;
      }
    } catch { /* corrupt data â€” continue */ }
  }

  // Try 3: Show setup dialog
  showKeySetupDialog();
})();

function showKeySetupDialog() {
  const overlay = document.createElement('div');
  overlay.id = 'keySetupOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(26,24,48,0.6);backdrop-filter:blur(6px);z-index:100;display:flex;align-items:center;justify-content:center;padding:1.5rem;';

  overlay.innerHTML = `
    <div style="background:white;border-radius:20px;padding:2rem 2.25rem;max-width:460px;width:100%;box-shadow:0 12px 40px rgba(74,63,165,0.2);">
      <div style="font-family:'DM Serif Display',serif;font-size:1.15rem;color:var(--primary);margin-bottom:0.35rem;">ğŸ”‘ API Keys instellen</div>
      <p style="font-size:0.8rem;color:var(--muted);margin-bottom:1.25rem;line-height:1.5;">
        Eenmalige setup â€” je keys worden veilig opgeslagen in je browser en worden niet gedeeld.
      </p>
      <div style="display:flex;flex-direction:column;gap:0.85rem;">
        <div>
          <label style="font-size:0.73rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;">Claude API Key</label>
          <input type="password" id="setupClaudeKey" placeholder="sk-ant-api03-..." style="width:100%;padding:0.6rem 0.85rem;border:1.5px solid var(--border);border-radius:10px;font-family:monospace;font-size:0.78rem;margin-top:0.25rem;">
        </div>
        <div>
          <label style="font-size:0.73rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;">Apify API Token</label>
          <input type="password" id="setupApifyToken" placeholder="apify_api_..." style="width:100%;padding:0.6rem 0.85rem;border:1.5px solid var(--border);border-radius:10px;font-family:monospace;font-size:0.78rem;margin-top:0.25rem;">
        </div>
        <div>
          <label style="font-size:0.73rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;">SerpAPI Key</label>
          <input type="password" id="setupSerpKey" placeholder="serpapi_key_..." style="width:100%;padding:0.6rem 0.85rem;border:1.5px solid var(--border);border-radius:10px;font-family:monospace;font-size:0.78rem;margin-top:0.25rem;">
        </div>
      </div>
      <button onclick="saveKeySetup()" style="width:100%;padding:0.85rem;margin-top:1.25rem;background:linear-gradient(135deg,var(--primary),var(--primary-light));color:white;border:none;border-radius:12px;font-family:'DM Serif Display',serif;font-size:0.95rem;cursor:pointer;box-shadow:0 4px 14px rgba(74,63,165,0.25);">âœ“ Opslaan & doorgaan</button>
      <p style="font-size:0.68rem;color:var(--muted);text-align:center;margin-top:0.75rem;line-height:1.4;">
        Keys worden opgeslagen in localStorage van je browser.<br>Ze verlaten nooit je apparaat.
      </p>
    </div>`;
  document.body.appendChild(overlay);
}

function saveKeySetup() {
  const claudeKey = document.getElementById('setupClaudeKey').value.trim();
  const apifyToken = document.getElementById('setupApifyToken').value.trim();
  const serpKey = document.getElementById('setupSerpKey').value.trim();

  if (!claudeKey || !apifyToken || !serpKey) {
    alert('Vul alle drie de keys in.');
    return;
  }

  // Save to localStorage
  localStorage.setItem('subsidietool_keys', JSON.stringify({
    claudeApiKey: claudeKey,
    apifyToken: apifyToken,
    serpApiKey: serpKey
  }));

  // Set in hidden inputs
  document.getElementById('claudeApiKey').value = claudeKey;
  document.getElementById('apifyToken').value   = apifyToken;
  document.getElementById('serpApiKey').value    = serpKey;

  // Remove dialog
  document.getElementById('keySetupOverlay').remove();
  console.log('API keys opgeslagen in localStorage');
}
</script>
</body>
</html>
