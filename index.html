<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsidietool v7 â€” Anh Thu Pham</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:              #f4f3f8;
  --primary:         #4a3fa5;
  --primary-light:   #7b72d4;
  --primary-xlight:  #e8e4f8;
  --accent:          #c9a7e8;
  --text:            #1a1830;
  --muted:           #7a7899;
  --border:          #e2e0ef;
  --card:            #ffffff;
  --gradient:        linear-gradient(135deg,#eee9fb 0%,#f5eefb 45%,#e8f3fb 100%);
  --ok:              #e8f6ee;  --ok-border:   #9ecfb5;  --ok-text:    #1a5c38;
  --warn:            #fef4e4;  --warn-border: #f0d070;  --warn-text:  #7a4a00;
  --danger:          #fde8e8;  --danger-border:#f0aaaa; --danger-text:#7a1010;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg); color: var(--text); min-height: 100vh;
  background-image:
    radial-gradient(ellipse 70% 40% at 8% 4%, rgba(74,63,165,.07) 0%, transparent 70%),
    radial-gradient(ellipse 50% 50% at 92% 92%, rgba(201,167,232,.1) 0%, transparent 70%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  padding: .85rem 2rem; display: flex; align-items: center; gap: .9rem;
  background: rgba(255,255,255,.85); backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 40;
}
.logo {
  width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex; align-items: center; justify-content: center;
  font-family: 'DM Serif Display', serif; color: #fff; font-size: .95rem;
}
.hd-copy h1 { font-family: 'DM Serif Display', serif; font-size: .95rem; color: var(--primary); line-height: 1.2; }
.hd-copy p  { font-size: .66rem; color: var(--muted); font-weight: 300; }
.badge { background: var(--primary); color: #fff; font-size: .52rem; padding: .1rem .38rem; border-radius: 100px; font-weight: 700; letter-spacing: .06em; margin-left: .3rem; vertical-align: middle; }

/* Phase indicator */
.phase-indicator { margin-left: auto; display: flex; align-items: center; gap: .5rem; }
.ph {
  display: flex; align-items: center; gap: .3rem;
  font-size: .7rem; color: var(--muted); font-weight: 500; transition: color .25s;
}
.ph.active { color: var(--primary); font-weight: 700; }
.ph.done   { color: var(--ok-text); }
.ph-dot {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2px solid var(--border); background: #fff;
  display: flex; align-items: center; justify-content: center;
  font-size: .58rem; font-weight: 800; color: var(--muted); flex-shrink: 0; transition: all .25s;
}
.ph.active .ph-dot { border-color: var(--primary); background: var(--primary); color: #fff; }
.ph.done   .ph-dot { border-color: var(--ok-border); background: var(--ok); color: var(--ok-text); }
.ph-line { width: 22px; height: 2px; background: var(--border); border-radius: 2px; transition: background .25s; }
.ph-line.done { background: var(--ok-border); }
@media(max-width:600px){ .ph span { display: none; } .ph-line { width: 10px; } header { padding: .7rem 1rem; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem 6rem; }
.screen { display: none; }
.screen.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--card); border: 1px solid var(--border); border-radius: 18px;
  padding: 1.65rem 1.9rem; margin-bottom: 1.2rem;
  box-shadow: 0 2px 18px rgba(74,63,165,.05);
}
.card-title {
  font-family: 'DM Serif Display', serif; font-size: .98rem; color: var(--primary);
  margin-bottom: 1.2rem; display: flex; align-items: center; gap: .5rem;
}
.num {
  width: 23px; height: 23px; border-radius: 7px; background: var(--primary); color: #fff;
  font-size: .63rem; font-weight: 800; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.hero-card {
  background: var(--gradient); border: 1px solid var(--border); border-radius: 20px;
  padding: 1.65rem 1.9rem; margin-bottom: 1.65rem;
}
.hero-card h2 { font-family: 'DM Serif Display', serif; font-size: 1.25rem; color: var(--primary); margin-bottom: .3rem; }
.hero-card p  { color: var(--muted); font-size: .84rem; line-height: 1.65; max-width: 520px; }
.pills { display: flex; flex-wrap: wrap; gap: .3rem; margin-top: .7rem; }
.pill { background: #fff; border: 1px solid var(--border); border-radius: 100px; padding: .2rem .6rem; font-size: .69rem; color: var(--primary); font-weight: 500; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API KEYS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.keys-wrap {
  background: linear-gradient(135deg,#faf8ff,#f5f0ff);
  border: 1px solid var(--accent); border-radius: 18px;
  padding: 1.2rem 1.7rem; margin-bottom: 1.4rem;
}
.keys-wrap summary {
  cursor: pointer; font-family: 'DM Serif Display', serif; font-size: .92rem; color: var(--primary);
  list-style: none; display: flex; align-items: center; gap: .5rem;
}
.keys-wrap summary::after { content: 'â–¾'; margin-left: auto; color: var(--muted); }
details[open].keys-wrap summary::after { content: 'â–´'; }
.keys-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .7rem; margin-top: .9rem; }
@media(max-width:540px){ .keys-grid { grid-template-columns: 1fr; } }
.kf label { display: block; font-size: .7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; margin-bottom: .28rem; }
.key-row { position: relative; }
.key-row input { padding-right: 3.2rem !important; font-family: monospace; font-size: .76rem; }
.key-toggle { position: absolute; right: .65rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--muted); font-size: .7rem; padding: .15rem .3rem; }
.keys-status { font-size: .7rem; margin-top: .35rem; color: var(--muted); }
.keys-status.ok { color: var(--ok-text); font-weight: 600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM FIELDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field { margin-bottom: 1rem; }
label { display: block; font-size: .8rem; font-weight: 600; color: var(--text); margin-bottom: .32rem; }
.sublabel { font-size: .68rem; color: var(--muted); font-weight: 400; margin-left: .15rem; }
.field-note { font-size: .73rem; color: var(--muted); line-height: 1.55; margin-bottom: .42rem; }
input[type="text"], input[type="password"], textarea, select {
  width: 100%; padding: .65rem .9rem; border: 1.5px solid var(--border); border-radius: 11px;
  font-family: 'DM Sans', sans-serif; font-size: .84rem; color: var(--text);
  background: #fafafa; outline: none; transition: border-color .2s, box-shadow .2s; -webkit-appearance: none;
}
input:focus, textarea:focus {
  border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(74,63,165,.08); background: #fff;
}
textarea { resize: vertical; min-height: 84px; line-height: 1.55; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAG GROUPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tag-group { display: flex; flex-wrap: wrap; gap: .3rem; margin-top: .32rem; }
.tag {
  padding: .3rem .68rem; border: 1.5px solid var(--border); border-radius: 100px;
  font-size: .74rem; cursor: pointer; transition: all .15s; background: #fafafa;
  user-select: none; font-family: 'DM Sans', sans-serif; white-space: nowrap;
}
.tag:hover { border-color: var(--primary-light); background: #f0eef8; }
.tag.selected { background: var(--primary); color: #fff; border-color: var(--primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIOUS SUBSIDIES â€” state-driven
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prev-subsidies-container { margin-top: .32rem; }
.ps-chips { display: flex; flex-wrap: wrap; gap: .3rem; margin-bottom: .5rem; }
.ps-chip {
  padding: .3rem .68rem; border: 1.5px solid var(--border); border-radius: 100px;
  font-size: .74rem; cursor: pointer; transition: all .15s; background: #fafafa;
  user-select: none; font-family: 'DM Sans', sans-serif; white-space: nowrap;
}
.ps-chip:hover { border-color: var(--primary-light); background: #f0eef8; }
.ps-chip.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
.ps-regeling-list { display: flex; flex-direction: column; gap: .35rem; }
.ps-regeling-row {
  display: flex; align-items: center; gap: .55rem;
  padding: .55rem .75rem; background: var(--primary-xlight);
  border: 1px solid #ccc8e8; border-radius: 10px; transition: all .2s;
}
.ps-regeling-row .ps-fonds-lbl {
  font-size: .73rem; font-weight: 700; color: var(--primary);
  min-width: 130px; flex-shrink: 0;
}
.ps-regeling-row input {
  flex: 1; padding: .38rem .65rem; font-size: .78rem; border-radius: 8px;
  background: #fff; border: 1px solid var(--border); min-width: 0;
}
.ps-regeling-row input:focus { border-color: var(--primary-light); box-shadow: none; background: #fff; }
.ps-andere { margin-top: .5rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPLOAD ZONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.upload-zone {
  border: 2px dashed var(--border); border-radius: 12px; padding: 1rem;
  text-align: center; cursor: pointer; transition: all .2s; background: #fafafa; position: relative;
}
.upload-zone:hover, .upload-zone.dragover { border-color: var(--primary-light); background: var(--primary-xlight); }
.uz-icon { font-size: 1.35rem; margin-bottom: .18rem; }
.upload-zone p    { font-size: .76rem; color: var(--muted); }
.upload-zone strong { color: var(--primary); font-size: .78rem; }
.status-msg { margin-top: .45rem; font-size: .75rem; padding: .38rem .65rem; border-radius: 8px; display: none; }
.status-msg.success { background: var(--ok); color: var(--ok-text); display: block; }
.status-msg.loading { background: var(--primary-xlight); color: var(--primary); display: block; }
.status-msg.error   { background: var(--danger); color: var(--danger-text); display: block; }
.ctx-preview { background: #f5f3fb; border: 1px solid var(--border); border-radius: 9px; padding: .55rem .8rem; margin-top: .45rem; font-size: .73rem; color: var(--muted); max-height: 75px; overflow-y: auto; display: none; line-height: 1.5; }
.ctx-preview.visible { display: block; }
.or-div { text-align: center; color: var(--muted); font-size: .73rem; margin: .55rem 0; position: relative; }
.or-div::before, .or-div::after { content: ''; position: absolute; top: 50%; width: 44%; height: 1px; background: var(--border); }
.or-div::before { left: 0; } .or-div::after { right: 0; }
.url-row { display: flex; gap: .4rem; }
.url-row input { flex: 1; }
.fetch-btn {
  padding: .65rem .95rem; background: var(--primary); color: #fff; border: none; border-radius: 11px;
  font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 600; cursor: pointer;
  transition: background .2s; flex-shrink: 0; white-space: nowrap;
}
.fetch-btn:hover { background: var(--primary-light); }
.fetch-btn:disabled { opacity: .5; cursor: not-allowed; }
.paste-toggle { font-size: .73rem; color: var(--primary); cursor: pointer; text-decoration: underline; text-underline-offset: 2px; margin-top: .38rem; display: inline-block; }
.paste-area { display: none; margin-top: .55rem; }
.paste-area.visible { display: block; }
.paste-save { margin-top: .38rem; padding: .4rem .8rem; background: var(--primary); color: #fff; border: none; border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: .75rem; font-weight: 600; cursor: pointer; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CTA BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cta-btn {
  width: 100%; padding: 1rem; margin-top: .5rem;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: #fff; border: none; border-radius: 14px;
  font-family: 'DM Serif Display', serif; font-size: 1.05rem; letter-spacing: .01em;
  cursor: pointer; box-shadow: 0 5px 22px rgba(74,63,165,.28); transition: all .22s;
}
.cta-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 9px 28px rgba(74,63,165,.35); }
.cta-btn:disabled { opacity: .42; cursor: not-allowed; transform: none; }
.btn-sm { padding: .44rem .88rem; border: 1.5px solid var(--border); border-radius: 9px; background: #fff; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: .76rem; font-weight: 600; cursor: pointer; transition: all .15s; }
.btn-sm:hover { border-color: var(--primary-light); color: var(--primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.prog-title { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--primary); margin-bottom: 1.2rem; }

/* Fonds progress blocks */
.fonds-prog-list { display: flex; flex-direction: column; gap: .55rem; margin-bottom: .9rem; }
.fonds-prog-item {
  border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #fafafa;
  transition: all .25s;
}
.fonds-prog-item.active  { border-color: var(--primary-light); background: var(--primary-xlight); }
.fonds-prog-item.done    { border-color: var(--ok-border);     background: var(--ok); }
.fonds-prog-item.error   { border-color: var(--danger-border); background: var(--danger); }
.fonds-prog-header {
  padding: .6rem .95rem; display: flex; align-items: center; gap: .75rem;
}
.fonds-prog-icon { font-size: .95rem; flex-shrink: 0; }
.fonds-prog-name { font-size: .83rem; font-weight: 600; flex: 1; color: var(--text); }
.fonds-prog-item.active .fonds-prog-name { color: var(--primary); }
.fonds-prog-item.done   .fonds-prog-name { color: var(--ok-text); }
.fonds-prog-item.error  .fonds-prog-name { color: var(--danger-text); }
.fonds-prog-status { font-size: .7rem; color: var(--muted); }
.fonds-prog-steps {
  padding: 0 .95rem .75rem;
  display: none;
}
.fonds-prog-item.active .fonds-prog-steps { display: flex; flex-direction: column; gap: .28rem; }
.mini-step { display: flex; align-items: center; gap: .55rem; font-size: .76rem; color: var(--muted); padding: .2rem 0; }
.mini-step.active { color: var(--primary); font-weight: 600; }
.mini-step.done   { color: var(--ok-text); }
.mini-step-icon { width: 1.1rem; text-align: center; flex-shrink: 0; }
.spin-sm { width: 12px; height: 12px; border: 2px solid rgba(74,63,165,.2); border-top-color: var(--primary); border-radius: 50%; animation: spin .75s linear infinite; flex-shrink: 0; }
.spin-lg { width: 34px; height: 34px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin .8s linear infinite; margin: 0 auto .8rem; }
@keyframes spin { to { transform: rotate(360deg); } }

.log-box { background: #1a1830; color: #b8d4b0; font-family: monospace; font-size: .7rem; border-radius: 11px; padding: .8rem 1rem; max-height: 130px; overflow-y: auto; margin-top: .8rem; line-height: 1.7; }
.log-ts   { color: #5a5878; margin-right: .4rem; }
.log-ok   { color: #7ec89a; }
.log-warn { color: #e8c870; }
.log-err  { color: #e87070; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.results-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.2rem; }
.results-header h2 { font-family: 'DM Serif Display', serif; font-size: 1.2rem; color: var(--primary); }
.results-header p { font-size: .75rem; color: var(--muted); margin-top: .1rem; }

/* Summary stat bar */
.stat-bar { display: flex; gap: .65rem; flex-wrap: wrap; margin-bottom: 1.2rem; padding: .9rem 1.25rem; background: #fff; border: 1px solid var(--border); border-radius: 14px; }
.stat { text-align: center; flex: 1; min-width: 52px; }
.stat-n { font-family: 'DM Serif Display', serif; font-size: 1.75rem; line-height: 1; }
.stat-l { font-size: .67rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .04em; margin-top: .15rem; }
.stat.green .stat-n  { color: #1a5c38; }
.stat.orange .stat-n { color: #b06a00; }
.stat.red .stat-n    { color: #b04040; }
.stat.blue .stat-n   { color: var(--primary); }

/* Fonds section header */
.fonds-section-hd {
  display: flex; align-items: center; gap: .75rem;
  padding: .85rem 1.25rem; background: var(--gradient);
  border: 1px solid var(--border); border-radius: 14px; margin-bottom: .6rem; margin-top: 1.35rem; flex-wrap: wrap;
}
.fonds-section-hd:first-of-type { margin-top: 0; }
.fsh-icon { font-size: 1.4rem; }
.fsh-text h3 { font-family: 'DM Serif Display', serif; font-size: .95rem; color: var(--primary); }
.fsh-text p  { font-size: .72rem; color: var(--muted); margin-top: .06rem; }
.fsh-url { margin-left: auto; font-size: .71rem; }
.fsh-url a { color: var(--primary); font-weight: 700; text-decoration: underline; text-underline-offset: 2px; }
.fsh-counts { display: flex; gap: .4rem; flex-shrink: 0; }
.count-badge { padding: .16rem .5rem; border-radius: 100px; font-size: .67rem; font-weight: 800; }
.cb-hoog   { background: #d4f0e2; color: #1a5c38; }
.cb-middel { background: #fef0d6; color: #7a4a00; }
.cb-laag   { background: #fde4e4; color: #7a1010; }
.cb-uitg   { background: #e8e4f8; color: var(--primary); }

/* Match result card */
.rc { background: #fff; border: 1px solid var(--border); border-radius: 13px; margin-bottom: .7rem; overflow: hidden; box-shadow: 0 2px 10px rgba(74,63,165,.04); transition: box-shadow .2s; }
.rc:hover { box-shadow: 0 4px 18px rgba(74,63,165,.1); }
.rc-head { padding: .85rem 1.25rem; display: flex; align-items: center; gap: .8rem; cursor: pointer; border-bottom: 1px solid transparent; transition: border-color .2s; }
.rc-head.open { border-bottom-color: var(--border); }
.rc-name { font-weight: 700; font-size: .88rem; flex: 1; min-width: 0; }
.rc-sub  { font-size: .7rem; color: var(--muted); margin-top: .05rem; }
.score-badge { padding: .2rem .6rem; border-radius: 100px; font-size: .67rem; font-weight: 800; letter-spacing: .04em; white-space: nowrap; flex-shrink: 0; }
.s-hoog   { background: #d4f0e2; color: #1a5c38; }
.s-middel { background: #fef0d6; color: #7a4a00; }
.s-laag   { background: #fde4e4; color: #7a1010; }
.s-uitg   { background: #1a1830; color: #e8e4f8; }
.chevron  { color: var(--muted); font-size: .75rem; transition: transform .2s; flex-shrink: 0; }
.chevron.open { transform: rotate(180deg); }

.rc-body { display: none; padding: 1rem 1.25rem 1.25rem; }
.rc-body.open { display: block; }

/* Exclusion banner */
.excl-ban { background: var(--primary-xlight); border: 1px solid #c0b8e8; border-radius: 10px; padding: .72rem 1rem; margin-bottom: .8rem; }
.excl-ban-lbl { font-size: .7rem; font-weight: 800; color: var(--primary); text-transform: uppercase; letter-spacing: .07em; margin-bottom: .32rem; }
.excl-ban ul { padding-left: 1.1rem; }
.excl-ban li { font-size: .8rem; color: var(--primary); line-height: 1.55; margin: .1rem 0; }

/* Data grid */
.dg { display: grid; grid-template-columns: 1fr 1fr; gap: .55rem; margin-bottom: .8rem; }
@media(max-width:480px){ .dg { grid-template-columns: 1fr; } }
.dc { background: #fafafa; border: 1px solid var(--border); border-radius: 9px; padding: .5rem .75rem; }
.dc.hl { border-color: #c8c0e8; background: #f5f3fc; }
.dc-lbl { font-size: .61rem; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; margin-bottom: .16rem; }
.dc-val { font-size: .8rem; color: var(--text); line-height: 1.4; }

/* Criteria */
.crit-sec { margin-bottom: .65rem; }
.crit-sec h4 { font-size: .68rem; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; margin-bottom: .28rem; }
.crit-list { display: flex; flex-direction: column; gap: .2rem; }
.ci { display: flex; align-items: flex-start; gap: .38rem; font-size: .78rem; padding: .26rem .48rem; border-radius: 7px; line-height: 1.4; }
.ci.soft { background: #fafafa; border: 1px solid var(--border); }
.ci.hard { background: var(--danger); border: 1px solid var(--danger-border); color: var(--danger-text); }
.ci-dot  { flex-shrink: 0; margin-top: .04rem; }

/* Score bar */
.score-bar-wrap { margin: .75rem 0; }
.sb-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: .3rem; }
.sb-row span { font-size: .69rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
.sb-row strong { font-size: .88rem; color: var(--primary); }
.score-bar { height: 7px; background: var(--border); border-radius: 100px; overflow: hidden; }
.score-fill { height: 100%; border-radius: 100px; transition: width .7s cubic-bezier(.4,0,.2,1); background: linear-gradient(90deg, var(--primary-light), var(--primary)); }
.score-fill.mid  { background: linear-gradient(90deg, #f0d470, #e0a820); }
.score-fill.low  { background: linear-gradient(90deg, #f0b0b0, #e07070); }

/* Doelgroep tags */
.dt-tags { display: flex; flex-wrap: wrap; gap: .22rem; margin-top: .35rem; }
.dt-ok   { background: var(--ok);     color: var(--ok-text);   border: 1px solid var(--ok-border);   font-size: .7rem; font-weight: 600; padding: .14rem .48rem; border-radius: 6px; }
.dt-warn { background: var(--danger); color: var(--danger-text); border: 1px solid var(--danger-border); font-size: .7rem; font-weight: 600; padding: .14rem .48rem; border-radius: 6px; }

/* Evidence */
.ev-item { border: 1px solid var(--border); border-radius: 9px; padding: .5rem .75rem; margin-bottom: .3rem; }
.ev-url  { font-size: .67rem; color: var(--primary); font-weight: 700; display: block; margin-bottom: .16rem; word-break: break-all; text-decoration: underline; }
.ev-quote { font-size: .75rem; color: var(--muted); font-style: italic; line-height: 1.5; }

/* Uncertain */
.unc { color: #9a6a00; background: #fef8e6; border: 1px solid #f0d870; border-radius: 4px; padding: .05rem .28rem; font-size: .68rem; font-weight: 700; }

/* Raw JSON */
.raw-toggle { font-size: .7rem; color: var(--muted); cursor: pointer; text-decoration: underline; text-underline-offset: 2px; margin-top: .8rem; display: inline-block; }
.raw-json { display: none; background: #1a1830; color: #a8d4f0; font-family: monospace; font-size: .68rem; border-radius: 11px; padding: .8rem; margin-top: .38rem; max-height: 240px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; line-height: 1.6; }

@media(max-width:520px){ .main { padding: 1.2rem .85rem 4rem; } .card { padding: 1.3rem; } }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo">A</div>
  <div class="hd-copy">
    <h1>Subsidietool <span class="badge">v7</span></h1>
    <p>Anh Thu Pham â€” auto-discovery &amp; regelinganalyse</p>
  </div>
  <div class="phase-indicator" id="phaseIndicator">
    <div class="ph active" id="ph1"><div class="ph-dot">1</div><span>Project</span></div>
    <div class="ph-line" id="phl1"></div>
    <div class="ph active" id="ph2"><div class="ph-dot">2</div><span>Discovery</span></div>
    <div class="ph-line" id="phl2"></div>
    <div class="ph" id="ph3"><div class="ph-dot">3</div><span>Resultaten</span></div>
  </div>
</header>

<div class="main">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORM SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screenForm">

  <div class="hero-card">
    <h2>Subsidie-analyse op regelingsniveau</h2>
    <p>Vul het klantprofiel in. De tool selecteert automatisch relevante fondsen, crawlt hun websites en berekent per regeling een matchscore â€” inclusief harde uitsluitingschecks op rechtsvorm en doelgroep.</p>
    <div class="pills">
      <span class="pill">ğŸ¤– Auto-fonds discovery</span>
      <span class="pill">âš¡ Regelingsniveau scoring</span>
      <span class="pill">ğŸš« Harde uitsluitingslogica</span>
      <span class="pill">ğŸ“„ PDF-extractie</span>
    </div>
  </div>

  <!-- API Keys -->
  <details class="keys-wrap" id="keysDetails" open>
    <summary>ğŸ”‘ API Sleutels</summary>
    <div class="keys-grid">
      <div class="kf">
        <label>Claude API Key</label>
        <div class="key-row">
          <input type="password" id="claudeKey" placeholder="sk-ant-api03-..." oninput="syncKeys()">
          <button class="key-toggle" onclick="toggleKey('claudeKey',this)">toon</button>
        </div>
      </div>
      <div class="kf">
        <label>Apify API Token</label>
        <div class="key-row">
          <input type="password" id="apifyToken" placeholder="apify_api_..." oninput="syncKeys()">
          <button class="key-toggle" onclick="toggleKey('apifyToken',this)">toon</button>
        </div>
      </div>
      <div class="kf">
        <label>SerpAPI Key</label>
        <div class="key-row">
          <input type="password" id="serpKey" placeholder="serpapi_key_..." oninput="syncKeys()">
          <button class="key-toggle" onclick="toggleKey('serpKey',this)">toon</button>
        </div>
      </div>
      <div class="kf" style="display:flex;align-items:flex-end;">
        <p class="keys-status" id="keysStatus">Vul alle drie sleutels in om te beginnen.</p>
      </div>
    </div>
  </details>

  <!-- â”€â”€ Sectie 1: Klantprofiel â”€â”€ -->
  <div class="card">
    <div class="card-title"><span class="num">1</span> Klantprofiel</div>

    <div class="field">
      <label>Naam <span class="sublabel">(optioneel)</span></label>
      <input type="text" id="naam" placeholder="bijv. naam van de kunstenaar">
    </div>

    <div class="field">
      <label>Rechtsvorm</label>
      <div class="tag-group" id="rechtsVormTags" data-single="true">
        <span class="tag" data-val="individuele kunstenaar (zzp)">Individuele kunstenaar / ZZP</span>
        <span class="tag" data-val="kunstenaarscollectief (informeel)">Collectief (informeel)</span>
        <span class="tag" data-val="stichting">Stichting</span>
        <span class="tag" data-val="vereniging">Vereniging</span>
        <span class="tag" data-val="bv/nv (commercieel)">BV / NV</span>
        <span class="tag" data-val="student (geen kvk)">Student</span>
      </div>
    </div>

    <div class="field">
      <label>Kunstdiscipline(s)</label>
      <div class="tag-group" id="disciplineTags">
        <span class="tag" data-val="beeldende kunst">Beeldende kunst</span>
        <span class="tag" data-val="muziek">Muziek</span>
        <span class="tag" data-val="theater">Theater</span>
        <span class="tag" data-val="dans">Dans</span>
        <span class="tag" data-val="film">Film</span>
        <span class="tag" data-val="design">Design</span>
        <span class="tag" data-val="architectuur">Architectuur</span>
        <span class="tag" data-val="digitale cultuur">Digitale cultuur</span>
        <span class="tag" data-val="mode/textiel">Mode / Textiel</span>
        <span class="tag" data-val="literatuur">Literatuur</span>
        <span class="tag" data-val="fotografie">Fotografie</span>
        <span class="tag" data-val="erfgoed">Erfgoed</span>
        <span class="tag" data-val="podiumkunsten">Podiumkunsten</span>
        <span class="tag" data-val="interdisciplinair">Interdisciplinair</span>
      </div>
    </div>

    <div class="field">
      <label>CarriÃ¨refase</label>
      <div class="tag-group" id="faseTags" data-single="true">
        <span class="tag" data-val="startend (0-3 jaar)">Startend (0â€“3 jr)</span>
        <span class="tag" data-val="gevestigd (3-10 jaar)">Gevestigd (3â€“10 jr)</span>
        <span class="tag" data-val="ervaren (10+ jaar)">Ervaren (10+ jr)</span>
        <span class="tag" data-val="student">Student</span>
      </div>
    </div>

    <div class="field">
      <label>Woonplaats / stad</label>
      <input type="text" id="regio" placeholder="bijv. Amsterdam, Den Haag, Rotterdam...">
    </div>

    <div class="field">
      <label>Culturele achtergrond <span class="sublabel">(optioneel)</span></label>
      <input type="text" id="achtergrond" placeholder="bijv. Vietnamese roots, Surinaamse achtergrond...">
    </div>

    <div class="field">
      <label>Caribisch Nederland <span class="sublabel">(achtergrond of thema)</span></label>
      <p class="field-note">Selecteer als je afkomstig bent van de Caribische eilanden (Bonaire, Sint Eustatius, Saba, Aruba, CuraÃ§ao, Sint Maarten) of als je project een Caribisch thema heeft.</p>
      <div class="tag-group" id="caribischTags" data-single="true">
        <span class="tag" data-val="caribische achtergrond">Caribische achtergrond</span>
        <span class="tag" data-val="caribisch thema">Caribisch thema</span>
        <span class="tag" data-val="beide">Beide</span>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Sectie 2: Portfolio & Documenten â”€â”€ -->
  <div class="card">
    <div class="card-title"><span class="num">2</span> Portfolio &amp; Documenten <span class="sublabel" style="font-weight:400;font-family:'DM Sans',sans-serif;">â€” optioneel</span></div>

    <div class="field">
      <label>Website of portfolio-URL</label>
      <div class="url-row">
        <input type="text" id="portfolioUrl" placeholder="https://www.kunstenaarnaam.nl">
        <button class="fetch-btn" id="fetchBtn" onclick="fetchWebsite()">ğŸŒ Lezen</button>
      </div>
      <div class="status-msg" id="urlStatus"></div>
      <div class="ctx-preview" id="urlPreview"></div>
    </div>

    <div class="or-div">of</div>

    <div class="field">
      <label>Projectplan, CV of portfolio uploaden of plakken</label>
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileUpload').click()">
        <div class="uz-icon">ğŸ“„</div>
        <strong>Klik om PDF of .txt te uploaden</strong>
        <p>of sleep een bestand hierheen â€” max 20MB</p>
      </div>
      <input type="file" id="fileUpload" accept=".pdf,.txt,.md" onchange="handleFileUpload(this)" style="display:none">
      <span class="paste-toggle" onclick="togglePaste()">âœï¸ Liever tekst plakken?</span>
      <div class="paste-area" id="pasteArea">
        <textarea id="pasteText" placeholder="Plak hier de inhoud van je projectplan, CV of portfolio..."></textarea>
        <button class="paste-save" onclick="savePastedText()">âœ“ Opslaan als context</button>
      </div>
      <div class="status-msg" id="fileStatus"></div>
      <div class="ctx-preview" id="filePreview"></div>
    </div>
  </div>

  <!-- â”€â”€ Sectie 3: Het project â”€â”€ -->
  <div class="card">
    <div class="card-title"><span class="num">3</span> Het project</div>

    <div class="field">
      <label>Beschrijf het project zo concreet mogelijk</label>
      <textarea id="projectOmschrijving" placeholder="bijv. Een danser ontwikkelt een nieuw solowerk over culturele identiteit. PremiÃ¨re gepland voor voorjaar 2026 in een theater in Rotterdam..."></textarea>
    </div>

    <div class="field">
      <label>Projectfase</label>
      <div class="tag-group" id="faseProjTags">
        <span class="tag" data-val="onderzoek/ontwikkeling">Onderzoek / ontwikkeling</span>
        <span class="tag" data-val="voorproductie">Voorproductie</span>
        <span class="tag" data-val="productie">Productie</span>
        <span class="tag" data-val="presentatie">Presentatie</span>
        <span class="tag" data-val="publicatie">Publicatie</span>
        <span class="tag" data-val="talentontwikkeling">Talentontwikkeling</span>
        <span class="tag" data-val="doorontwikkeling">Doorontwikkeling</span>
      </div>
    </div>

    <div class="field">
      <label>Presentatielocatie</label>
      <div class="tag-group" id="locatieTags">
        <span class="tag" data-val="Nederland">Nederland</span>
        <span class="tag" data-val="internationaal/buitenland">Internationaal</span>
        <span class="tag" data-val="online">Online</span>
      </div>
    </div>

    <div class="field">
      <label>Primair doel</label>
      <div class="tag-group" id="doelTags">
        <span class="tag" data-val="artistieke ontwikkeling">Artistieke ontwikkeling</span>
        <span class="tag" data-val="publieksbereik">Publieksbereik</span>
        <span class="tag" data-val="onderzoek">Onderzoek</span>
        <span class="tag" data-val="educatie">Educatie</span>
        <span class="tag" data-val="participatie">Participatie</span>
        <span class="tag" data-val="internationale samenwerking">Int. samenwerking</span>
        <span class="tag" data-val="talentontwikkeling">Talentontwikkeling</span>
      </div>
    </div>

    <div class="field">
      <label>Type activiteit</label>
      <p class="field-note">Artistiek</p>
      <div class="tag-group" id="typeArtTags" style="margin-bottom:.55rem;">
        <span class="tag" data-val="tentoonstelling">Tentoonstelling</span>
        <span class="tag" data-val="performance">Performance</span>
        <span class="tag" data-val="installatie">Installatie</span>
        <span class="tag" data-val="filmproductie">Filmproductie</span>
        <span class="tag" data-val="publicatie/boek">Publicatie / boek</span>
        <span class="tag" data-val="digitale productie">Digitale productie</span>
        <span class="tag" data-val="prototype">Prototype</span>
      </div>
      <p class="field-note">Participatief / Onderzoek</p>
      <div class="tag-group" id="typePartTags">
        <span class="tag" data-val="workshop">Workshop</span>
        <span class="tag" data-val="educatief programma">Educatief programma</span>
        <span class="tag" data-val="community project">Community project</span>
        <span class="tag" data-val="artistiek onderzoek">Artistiek onderzoek</span>
        <span class="tag" data-val="archiefonderzoek">Archiefonderzoek</span>
      </div>
    </div>

    <div class="field">
      <label>Maatschappelijke focus <span class="sublabel">(indien van toepassing)</span></label>
      <div class="tag-group" id="sociaalTags">
        <span class="tag" data-val="polarisatie/radicalisering">Polarisatie / radicalisering</span>
        <span class="tag" data-val="trans-Atlantisch slavernij/erfgoed">Slavernij / erfgoed</span>
        <span class="tag" data-val="klimaat/duurzaamheid">Klimaat / duurzaamheid</span>
        <span class="tag" data-val="sociaal-maatschappelijk">Sociaal-maatschappelijk</span>
        <span class="tag" data-val="inclusie/diversiteit">Inclusie / diversiteit</span>
      </div>
    </div>

    <div class="field">
      <label>Gevraagd subsidiebedrag</label>
      <div class="tag-group" id="bedragTags" data-single="true">
        <span class="tag" data-val="onder â‚¬1.000">Onder â‚¬1.000</span>
        <span class="tag" data-val="â‚¬1.000â€“â‚¬5.000">â‚¬1.000 â€“ â‚¬5.000</span>
        <span class="tag" data-val="â‚¬5.000â€“â‚¬15.000">â‚¬5.000 â€“ â‚¬15.000</span>
        <span class="tag" data-val="â‚¬15.000+">â‚¬15.000+</span>
        <span class="tag" data-val="onbekend">Onbekend</span>
      </div>
    </div>

    <!-- â”€â”€ Eerder ontvangen subsidies â€” state-driven â”€â”€ -->
    <div class="field">
      <label>Eerder subsidie ontvangen van</label>
      <p class="field-note">Selecteer fondsen â€” er verschijnt direct een invoerveld voor de regeling.</p>
      <div class="prev-subsidies-container">
        <div class="ps-chips" id="psChips"></div>
        <div class="ps-regeling-list" id="psRegelingList"></div>
        <div class="ps-andere">
          <input type="text" id="psAndere" placeholder="Andere fondsen: bijv. AFK, VSBFonds, Cultuurfonds...">
        </div>
      </div>
    </div>

    <div class="field">
      <label>Extra context <span class="sublabel">(deadlines, partners, bijzonderheden)</span></label>
      <textarea id="extraContext" placeholder="bijv. deadline AFK is oktober, samenwerking met Eye Filmmuseum bevestigd..." style="min-height:58px;"></textarea>
    </div>
  </div>

  <!-- CTA -->
  <button class="cta-btn" id="ctaBtn" onclick="startDiscovery()" disabled>
    ğŸš€ Subsidies ontdekken &amp; analyseren
  </button>

</div><!-- /screenForm -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PROGRESS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenProgress">
  <div class="card">
    <div class="prog-title">Fondsen worden geanalyseerd...</div>
    <div class="fonds-prog-list" id="fondsProg"></div>
    <div class="log-box" id="logBox"></div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESULTS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screenResults">

  <div class="results-header">
    <div>
      <h2>Matchresultaten</h2>
      <p id="resMeta"></p>
    </div>
    <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
      <button class="btn-sm" onclick="copyResultsJson()">ğŸ“‹ JSON</button>
      <button class="btn-sm" onclick="resetAll()">â† Nieuwe analyse</button>
    </div>
  </div>

  <div class="stat-bar" id="statBar"></div>
  <div id="resultsBody"></div>

  <span class="raw-toggle" id="rawToggle" onclick="toggleRaw()">â–¸ Bekijk ruwe JSON</span>
  <div class="raw-json" id="rawJson"></div>

</div><!-- /screenResults -->

</div><!-- /main -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const appState = {
  apiKeys: { claude: '', apify: '', serp: '' },
  project: null,              // collected from form
  previousSubsidies: [],      // [{ fonds: string, regeling: string }]
  crawlResults: [],           // [{ fondsInfo, regelingen[] }] per fonds
  matchResults: [],           // flat scored regelingen[]
};

let websiteContext  = '';
let documentContext = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FONDSENDATABASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FONDSEN_DB = [
  { naam:"Stimuleringsfonds Creatieve Industrie", focus:"design, architectuur, digitale cultuur, vormgeving", url:"https://www.stimuleringsfonds.nl/subsidies", disciplines:["design","architectuur","digitale cultuur"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","kunstenaarscollectief (informeel)"] },
  { naam:"Mondriaanfonds", focus:"beeldende kunst, fotografie, internationale presentatie", url:"https://www.mondriaanfonds.nl", disciplines:["beeldende kunst","fotografie"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"] },
  { naam:"Nederlands Filmfonds", focus:"film, documentaire, animatie, korte film", url:"https://www.filmfonds.nl", disciplines:["film"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","bv/nv (commercieel)"] },
  { naam:"Cultuurfonds", focus:"project over meerdere disciplines", url:"https://www.cultuurfonds.nl", disciplines:["beeldende kunst","muziek","theater","dans","literatuur","fotografie","erfgoed","interdisciplinair","mode/textiel"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging","kunstenaarscollectief (informeel)"] },
  { naam:"Fonds voor Cultuurparticipatie", focus:"participatie, educatie, amateurkunst", url:"https://cultuurparticipatie.nl", disciplines:["educatie","podiumkunsten","muziek","dans","theater","beeldende kunst"], rechtsvormen:["stichting","vereniging"] },
  { naam:"Fonds ZOZ", focus:"polarisatie en radicalisering verminderen in NL", url:"https://fondszoz.nl", disciplines:["interdisciplinair","theater","muziek","beeldende kunst","film"], sociaal:"polarisatie/radicalisering", rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam:"DNB Fonds", focus:"trans-Atlantisch slavernij erfgoed, Caribisch NL", url:"https://www.cultuurfonds.nl/fondsen/dnb-fonds", disciplines:["beeldende kunst","theater","dans","literatuur","interdisciplinair","film"], sociaal:"trans-Atlantisch slavernij/erfgoed", caribisch:true, rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam:"VSBFonds", focus:"educatie, participatie, cultuur", url:"https://www.vsbfonds.nl", disciplines:["beeldende kunst","muziek","theater","dans","podiumkunsten"], rechtsvormen:["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam:"Amsterdam Fonds voor de Kunsten", focus:"Amsterdam-gebaseerde kunstenaars", url:"https://www.amsterdamsfondsvoordekunst.nl", disciplines:["beeldende kunst","muziek","theater","dans","film","literatuur","interdisciplinair","fotografie"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","kunstenaarscollectief (informeel)"], regio:"amsterdam" },
  { naam:"Prins Clausfonds", focus:"kunstenaars met niet-Europese culturele achtergrond", url:"https://princeclausfund.nl", disciplines:["interdisciplinair","beeldende kunst","dans","muziek","theater","film"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"] },
  { naam:"Dioraphte", focus:"podiumkunsten, erfgoed, sociale initiatieven Afrika/NL", url:"https://dioraphte.nl", disciplines:["theater","dans","muziek","erfgoed","beeldende kunst","podiumkunsten"], rechtsvormen:["stichting","vereniging"] },
  { naam:"Stichting DOEN", focus:"sociale en culturele vernieuwing, klimaat", url:"https://www.doen.nl", disciplines:["interdisciplinair","theater","beeldende kunst","muziek","dans"], sociaal:"sociaal-maatschappelijk", rechtsvormen:["stichting","vereniging"] },
  { naam:"Stichting Stokroos", focus:"beeldend kunstenaars/vormgevers 3-8 jaar actief", url:"https://stokroos.nl/home", disciplines:["beeldende kunst","design","mode/textiel"], rechtsvormen:["individuele kunstenaar (zzp)"] },
  { naam:"K.F. Hein Fonds", focus:"kunstenaars en ontwerpers, Utrecht regio", url:"https://kfhein.nl", disciplines:["beeldende kunst","muziek","theater","dans","design"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","vereniging"], regio:"utrecht" },
  { naam:"Amarte Fonds", focus:"muziek, film, theater, beeldende kunst, literatuur", url:"https://www.amarte.nl/nl", disciplines:["muziek","film","theater","beeldende kunst","literatuur","interdisciplinair"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"] },
  { naam:"Stichting Niemeijer Fonds", focus:"begin van carriÃ¨re of nieuwe ontwikkeling", url:"https://www.stichtingniemeijerfonds.nl", disciplines:["beeldende kunst","fotografie","interdisciplinair","muziek","theater"], rechtsvormen:["individuele kunstenaar (zzp)"] },
  { naam:"Gieskes-Strijbis Fonds", focus:"natuur/milieu, kunst en cultuur, democratie", url:"https://www.gieskesstrijbisfonds.nl", disciplines:["beeldende kunst","theater","interdisciplinair","erfgoed"], rechtsvormen:["stichting","vereniging"] },
  { naam:"NPO Fonds", focus:"video, audio, talentontwikkeling", url:"https://npo.nl/npofonds", disciplines:["film","digitale cultuur","muziek"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","bv/nv (commercieel)"] },
  { naam:"Ammodo Art", focus:"internationaal toonaangevende beeldende kunst en podiumkunst", url:"https://www.ammodo-art.org", disciplines:["beeldende kunst","dans","theater","muziek","podiumkunsten"], rechtsvormen:["stichting","vereniging"] },
  { naam:"Stroom Den Haag", focus:"beeldende kunst Den Haag", url:"https://stroom.nl", disciplines:["beeldende kunst","fotografie","digitale cultuur"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"], regio:"den haag" },
  { naam:"CBK Rotterdam", focus:"beeldende kunst Rotterdam", url:"https://www.cbkrotterdam.nl", disciplines:["beeldende kunst","fotografie","interdisciplinair"], rechtsvormen:["individuele kunstenaar (zzp)","stichting"], regio:"rotterdam" },
  { naam:"Filmcommission NL", focus:"feature film, animatie, documentaire", url:"https://filmcommission.nl/fund-financing/", disciplines:["film"], rechtsvormen:["individuele kunstenaar (zzp)","stichting","bv/nv (commercieel)"] },
  { naam:"Fondskwadraat", focus:"rentevrije leningen onder â‚¬8.000", url:"https://www.fondskwadraat.nl", disciplines:["beeldende kunst","muziek","theater","dans","interdisciplinair","design"], rechtsvormen:["individuele kunstenaar (zzp)","kunstenaarscollectief (informeel)"] },
];

/* Chips voor "eerder ontvangen" */
const PS_CHIPS_DATA = [
  "Stimuleringsfonds","Mondriaanfonds","Fonds Podiumkunsten","Filmfonds",
  "Nederlands Letterenfonds","Fonds voor Cultuurparticipatie","AFK","VSBFonds",
  "Gemeente","Cultuurfonds","DOEN","Nog geen"
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const esc   = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const sleep = ms => new Promise(r => setTimeout(r, ms));
const getV  = id => (document.getElementById(id)?.value||'').trim();
const getSelected = id => [...document.querySelectorAll(`#${id} .tag.selected`)].map(t=>t.dataset.val);

function markUncertain(s) {
  return String(s).replace(/ONZEKER â€“ handmatig controleren/gi,
    '<span class="unc">âš  ONZEKER</span>');
}

function stripHtml(html) {
  const t = document.createElement('div');
  t.innerHTML = html;
  return (t.textContent||t.innerText||'').replace(/\s+/g,' ').trim();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE INDICATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setPhase(n) {
  // n=1: form, n=2: progress, n=3: results
  [1,2,3].forEach(i => {
    const el = document.getElementById(`ph${i}`);
    const ln = document.getElementById(`phl${i}`);
    if (i < n)       { el.className='ph done';   el.querySelector('.ph-dot').textContent='âœ“'; if(ln) ln.classList.add('done'); }
    else if (i===n)  { el.className='ph active'; el.querySelector('.ph-dot').textContent=String(i); }
    else             { el.className='ph';        el.querySelector('.ph-dot').textContent=String(i); if(ln) ln.classList.remove('done'); }
  });
  ['screenForm','screenProgress','screenResults'].forEach((id,idx) => {
    document.getElementById(id).classList.toggle('active', idx+1===n);
  });
  window.scrollTo(0,0);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEY MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleKey(id, btn) {
  const el = document.getElementById(id);
  el.type = el.type==='password' ? 'text' : 'password';
  btn.textContent = el.type==='password' ? 'toon' : 'verberg';
}

function syncKeys() {
  appState.apiKeys.claude = getV('claudeKey');
  appState.apiKeys.apify  = getV('apifyToken');
  appState.apiKeys.serp   = getV('serpKey');
  const allFilled = appState.apiKeys.claude && appState.apiKeys.apify && appState.apiKeys.serp;
  const el = document.getElementById('keysStatus');
  el.textContent = allFilled ? 'âœ“ Alle sleutels ingevuld' : 'Vul alle drie sleutels in om te beginnen.';
  el.className   = 'keys-status' + (allFilled ? ' ok' : '');
  updateCta();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIOUS SUBSIDIES â€” state-driven rendering
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initPsChips() {
  const container = document.getElementById('psChips');
  container.innerHTML = PS_CHIPS_DATA.map(fonds =>
    `<span class="ps-chip" data-fonds="${esc(fonds)}" onclick="togglePsChip('${fonds}')">${esc(fonds)}</span>`
  ).join('');
}

function togglePsChip(fonds) {
  if (fonds === 'Nog geen') {
    // Clear all selected
    appState.previousSubsidies = [];
  } else {
    const idx = appState.previousSubsidies.findIndex(p => p.fonds === fonds);
    if (idx >= 0) {
      appState.previousSubsidies.splice(idx, 1);
    } else {
      appState.previousSubsidies.push({ fonds, regeling: '' });
    }
    // Deselect "Nog geen" if it was selected
    // (it's a pseudo-chip, no state entry needed)
  }
  renderPsSection();
}

function renderPsSection() {
  const selectedFondsen = new Set(appState.previousSubsidies.map(p => p.fonds));

  // Update chip selected state
  document.querySelectorAll('.ps-chip').forEach(chip => {
    const f = chip.dataset.fonds;
    chip.classList.toggle('selected',
      f === 'Nog geen' ? selectedFondsen.size === 0 && !f :
      selectedFondsen.has(f)
    );
  });

  // Render regeling inputs
  const list = document.getElementById('psRegelingList');
  list.innerHTML = appState.previousSubsidies.map((ps, idx) => `
    <div class="ps-regeling-row">
      <span class="ps-fonds-lbl">${esc(ps.fonds)}</span>
      <input
        type="text"
        placeholder="Welke regeling? bijv. Talentontwikkeling..."
        value="${esc(ps.regeling)}"
        oninput="updatePsRegeling(${idx}, this.value)"
      >
    </div>
  `).join('');
}

function updatePsRegeling(idx, value) {
  if (appState.previousSubsidies[idx]) {
    appState.previousSubsidies[idx].regeling = value;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAG GROUPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.tag-group').forEach(group => {
  const single = group.dataset.single === 'true';
  group.querySelectorAll('.tag').forEach(tag => {
    tag.addEventListener('click', () => {
      if (single) group.querySelectorAll('.tag.selected').forEach(t => { if(t!==tag) t.classList.remove('selected'); });
      tag.classList.toggle('selected');
      updateCta();
    });
  });
});
['naam','regio','achtergrond','projectOmschrijving','extraContext','portfolioUrl'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', updateCta);
});

function updateCta() {
  const hasKeys    = appState.apiKeys.claude && appState.apiKeys.apify && appState.apiKeys.serp;
  const hasProject = document.querySelectorAll('#rechtsVormTags .tag.selected').length > 0 ||
                     document.querySelectorAll('#disciplineTags .tag.selected').length > 0 ||
                     getV('projectOmschrijving').length > 10;
  document.getElementById('ctaBtn').disabled = !(hasKeys && hasProject);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PORTFOLIO / FILE HANDLERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchWebsite() {
  const url = getV('portfolioUrl');
  if (!url) return alert('Vul een URL in.');
  if (!appState.apiKeys.claude) return alert('Vul eerst je Claude API key in.');
  const status  = document.getElementById('urlStatus');
  const preview = document.getElementById('urlPreview');
  status.className='status-msg loading'; status.textContent='â³ Website wordt gelezen...';
  preview.classList.remove('visible');
  document.getElementById('fetchBtn').disabled = true;
  try {
    const text = await callClaude([{role:'user',content:`Haal de belangrijkste informatie op van deze website voor een subsidiescan van een Nederlandse kunstenaar. URL: ${url}\n\nZoek naar: naam, discipline, vertoningsgeschiedenis, festivals, samenwerkingen, lopende projecten. Max 350 woorden, feitelijk en specifiek.`}], 700);
    websiteContext = text;
    if (text.length < 40) throw new Error('Website niet bereikbaar of geen relevante content');
    status.className='status-msg success'; status.textContent='âœ“ Website gelezen.';
    preview.textContent = text.substring(0,280)+'...'; preview.classList.add('visible');
  } catch(e) {
    status.className='status-msg error'; status.textContent='âš ï¸ '+e.message; websiteContext='';
  }
  document.getElementById('fetchBtn').disabled = false;
}

function handleFileUpload(input) {
  const file = input.files[0]; if (!file) return;
  const status = document.getElementById('fileStatus');
  const preview= document.getElementById('filePreview');
  if (file.size > 20*1024*1024) { status.className='status-msg error'; status.textContent='âš ï¸ Bestand te groot (max 20MB).'; return; }
  status.className='status-msg loading'; status.textContent=`â³ "${file.name}" wordt ingelezen...`;
  preview.classList.remove('visible');
  if (!appState.apiKeys.claude) { status.className='status-msg error'; status.textContent='âš ï¸ Vul eerst je Claude API key in.'; return; }
  const isPDF = file.type==='application/pdf'||file.name.toLowerCase().endsWith('.pdf');
  if (isPDF) {
    const reader = new FileReader();
    reader.onload = async e => {
      try {
        const bytes = new Uint8Array(e.target.result);
        let bin=''; for(let i=0;i<bytes.byteLength;i++) bin+=String.fromCharCode(bytes[i]);
        const b64 = btoa(bin);
        const text = await callClaude([{role:'user',content:[
          {type:'document',source:{type:'base64',media_type:'application/pdf',data:b64}},
          {type:'text',text:'Geef een uitgebreide samenvatting van alle informatie relevant voor een Nederlandse subsidieaanvraag. Beschrijf: discipline, project, vertoningsgeschiedenis, partners, lopende subsidies, budget. Max 450 woorden.'}
        ]}], 900);
        documentContext = text;
        if (!text.trim()) throw new Error('Geen tekst gevonden in PDF');
        status.className='status-msg success'; status.textContent=`âœ“ "${file.name}" ingelezen.`;
        preview.textContent=text.substring(0,300)+'...'; preview.classList.add('visible');
      } catch(err) { status.className='status-msg error'; status.textContent=`âš ï¸ PDF: ${err.message}`; }
    };
    reader.readAsArrayBuffer(file);
  } else {
    const reader = new FileReader();
    reader.onload = e => {
      documentContext = e.target.result.substring(0,8000);
      status.className='status-msg success'; status.textContent=`âœ“ "${file.name}" ingelezen.`;
      preview.textContent=documentContext.substring(0,280)+'...'; preview.classList.add('visible');
    };
    reader.readAsText(file,'UTF-8');
  }
}

const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e=>{e.preventDefault();uploadZone.classList.add('dragover');});
uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e=>{e.preventDefault();uploadZone.classList.remove('dragover');if(e.dataTransfer.files[0]) handleFileUpload({files:e.dataTransfer.files});});
function togglePaste() { document.getElementById('pasteArea').classList.toggle('visible'); }
function savePastedText() {
  const text = getV('pasteText'); if (!text) return;
  documentContext = text.substring(0,8000);
  const s=document.getElementById('fileStatus'); s.className='status-msg success'; s.textContent='âœ“ Tekst opgeslagen als context.';
  const p=document.getElementById('filePreview'); p.textContent=documentContext.substring(0,280)+(documentContext.length>280?'...':''); p.classList.add('visible');
  document.getElementById('pasteArea').classList.remove('visible');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA COLLECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function collectProject() {
  const typeProject = [...getSelected('typeArtTags'), ...getSelected('typePartTags')];
  return {
    naam:                getV('naam'),
    rechtsvorm:          getSelected('rechtsVormTags'),
    disciplines:         getSelected('disciplineTags'),
    carriereFase:        getSelected('faseTags'),
    regio:               getV('regio'),
    achtergrond:         getV('achtergrond'),
    caribisch:           getSelected('caribischTags'),
    projectOmschrijving: getV('projectOmschrijving'),
    projectFase:         getSelected('faseProjTags'),
    locatie:             getSelected('locatieTags'),
    doel:                getSelected('doelTags'),
    typeProject,
    sociaal:             getSelected('sociaalTags'),
    bedrag:              getSelected('bedragTags'),
    previousSubsidies:   [...appState.previousSubsidies],
    psAndere:            getV('psAndere'),
    websiteContext,
    documentContext
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLAUDE API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function callClaude(messages, maxTokens=4096) {
  const resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
      'x-api-key': appState.apiKeys.claude
    },
    body: JSON.stringify({ model:'claude-sonnet-4-20250514', max_tokens: maxTokens, messages })
  });
  const data = await resp.json();
  if (!resp.ok || data.error) throw new Error(data.error?.message || `Claude fout ${resp.status}`);
  return data.content?.map(c=>c.text||'').join('')||'';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FONDS SELECTION â€” auto-select based on project
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectFondsForDiscovery(project) {
  const discSet   = new Set(project.disciplines.map(d=>d.toLowerCase()));
  const rvSet     = new Set(project.rechtsvorm.map(r=>r.toLowerCase()));
  const regioLow  = project.regio.toLowerCase();
  const sociaal   = project.sociaal.join(' ').toLowerCase();
  const prevNames = new Set(project.previousSubsidies.map(p=>p.fonds.toLowerCase()));

  const scored = FONDSEN_DB.map(f => {
    // Skip funds already received
    if (prevNames.size>0 && Array.from(prevNames).some(p =>
      f.naam.toLowerCase().includes(p) || p.includes(f.naam.toLowerCase().split(' ')[0])
    )) return {...f, score:-99};

    let score = 0;
    // Discipline match (primary signal)
    score += f.disciplines.filter(d => discSet.has(d)).length * 4;
    // Broad disciplines get a base
    if (f.disciplines.some(d => ['interdisciplinair','breed'].includes(d))) score += 1;
    // Regio bonus
    if (f.regio && regioLow.includes(f.regio)) score += 6;
    // Sociaal match
    if (f.sociaal && sociaal.includes(f.sociaal.split('/')[0])) score += 8;
    // Rechtsvorm compatibility
    if (rvSet.size > 0) {
      const rvMatch = f.rechtsvormen?.some(r => rvSet.has(r.toLowerCase()));
      score += rvMatch ? 3 : -8;
    }
    // Cultural background â†’ Prins Clausfonds bonus
    if (project.achtergrond && f.naam.toLowerCase().includes('prins claus')) score += 6;
    // Caribisch Nederland bonus
    if (project.caribisch?.length > 0 && f.caribisch) score += 10;
    if (project.caribisch?.length > 0 && f.naam.toLowerCase().includes('prins claus')) score += 4;
    return {...f, score};
  })
  .filter(f => f.score > 0)
  .sort((a,b) => b.score - a.score)
  .slice(0, 4); // Max 4 fondsen to keep analysis manageable

  return scored;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DISCOVERY â€” search for additional funds beyond FONDSEN_DB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function discoverAdditionalFonds(project) {
  const knownNames = new Set(FONDSEN_DB.map(f => f.naam.toLowerCase()));
  const disc = project.disciplines.join(', ') || 'kunst';
  const rv = project.rechtsvorm.join(', ') || '';
  const caribisch = project.caribisch?.length > 0 ? ' Caribisch Nederland' : '';

  // Build targeted search queries based on project profile
  const queries = [
    `subsidie fonds ${disc} kunstenaar Nederland`,
    `stichting fonds ${disc} subsidie aanvragen`,
    `kleine fondsen ${disc} kunstenaar${caribisch}`,
    `cultureel fonds ${disc} bijdrage aanvraag`
  ];

  // Add project-specific queries
  if (project.sociaal?.length > 0) queries.push(`fonds ${project.sociaal.join(' ')} kunst subsidie`);
  if (project.caribisch?.length > 0) queries.push(`subsidie fonds Caribisch Nederland kunst cultuur`);
  if (project.achtergrond) queries.push(`fonds culturele diversiteit ${project.achtergrond} kunstenaar`);

  const discoveredMap = new Map(); // url â†’ { naam, url, snippet }

  for (const q of queries.slice(0, 5)) { // Max 5 queries to conserve API calls
    try {
      const resp = await fetch(`https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(q)}&api_key=${appState.apiKeys.serp}&num=10`);
      if (!resp.ok) continue;
      const data = await resp.json();
      (data.organic_results || []).forEach(r => {
        if (!r.link) return;
        const domain = new URL(r.link).hostname.replace('www.','');
        // Skip known funds from FONDSEN_DB
        const isKnown = FONDSEN_DB.some(f => r.link.includes(new URL(f.url).hostname.replace('www.','')));
        if (isKnown) return;
        // Skip generic sites (not actual funds)
        const skipDomains = ['google.','wikipedia.','facebook.','instagram.','linkedin.','youtube.','rijksoverheid.nl','overheid.nl','kvk.nl','belastingdienst.nl','indeed.','werkenbij','vacature'];
        if (skipDomains.some(d => domain.includes(d))) return;
        if (!discoveredMap.has(domain)) {
          discoveredMap.set(domain, { naam: r.title || domain, url: r.link, snippet: r.snippet || '' });
        }
      });
    } catch(e) { /* skip */ }
  }

  if (discoveredMap.size === 0) return [];

  // Use Claude to evaluate which discovered sites are actual funds worth crawling
  const candidates = Array.from(discoveredMap.values()).slice(0, 12);
  const evalPrompt = `Je bent een expert in Nederlandse kunst- en cultuursubsidies.
Hieronder staan websites gevonden via een zoekopdracht. Bepaal welke ECHTE fondsen of stichtingen zijn die subsidies/bijdragen geven aan kunstenaars of culturele projecten.

Project disciplines: ${disc}
Rechtsvorm: ${rv}
${project.caribisch?.length > 0 ? 'Caribisch Nederland relevant: ja' : ''}

KANDIDATEN:
${candidates.map((c,i) => `${i+1}. ${c.naam}\n   URL: ${c.url}\n   ${c.snippet}`).join('\n\n')}

Geef UITSLUITEND JSON terug â€” een array van objecten voor fondsen die ECHT subsidies/bijdragen verstrekken.
Negeer: commerciÃ«le sites, nieuwssites, overheidslokketten, vacaturesites, social media.

[
  {
    "naam": "string (korte naam fonds)",
    "url": "string (homepage URL van het fonds)",
    "focus": "string (waarvoor geeft dit fonds subsidies, max 10 woorden)",
    "relevance": "string (waarom relevant voor dit project, max 10 woorden)"
  }
]

Als geen enkele kandidaat een echt fonds is, geef een lege array: []`;

  try {
    const rawText = await callClaude([{role:'user', content: evalPrompt}], 1500);
    const m = rawText.match(/```json\s*([\s\S]*?)\s*```/) || rawText.match(/(\[[\s\S]*\])/);
    const parsed = JSON.parse(m ? m[1] : rawText);
    if (!Array.isArray(parsed)) return [];

    // Convert to FONDSEN_DB-like format and return max 2 extra funds
    return parsed.slice(0, 2).map(f => ({
      naam: f.naam,
      focus: f.focus || '',
      url: f.url,
      disciplines: project.disciplines, // Assume match since Claude said relevant
      rechtsvormen: project.rechtsvorm.length > 0 ? project.rechtsvorm : ["individuele kunstenaar (zzp)","stichting"],
      _discovered: true, // Mark as discovered (not from DB)
      score: 5 // Base score for discovered funds
    }));
  } catch(e) {
    return []; // Silent fail â€” discovery is best-effort
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SERP API â€” targeted queries
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const URL_PRIORITY_KW = ['richtlijn','wie-kan-indienen','aanvraagvoorwaarden','uitsluitingscrit','projectaanvraag','individuele','instelling','voorwaarden','subsidie','regeling','aanvragen','criteria','pdf','opengesteld','deadline'];

function urlPriority(url) {
  const u = url.toLowerCase();
  for (let i=0; i<URL_PRIORITY_KW.length; i++) if (u.includes(URL_PRIORITY_KW[i])) return i;
  return 99;
}
function isRelevantUrl(url) { return URL_PRIORITY_KW.some(k => url.toLowerCase().includes(k)); }
function isPdfUrl(url)      { return url.toLowerCase().includes('.pdf'); }

async function searchWithSerp(domain) {
  const queries = [
    `site:${domain} richtlijnen`,
    `site:${domain} wie kan indienen`,
    `site:${domain} aanvraagvoorwaarden`,
    `site:${domain} uitsluitingscriteria`,
    `site:${domain} projectaanvraag`,
    `site:${domain} individuele makers`,
    `site:${domain} instellingen`
  ];
  const urlMap = new Map();
  for (const q of queries) {
    try {
      const resp = await fetch(`https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(q)}&api_key=${appState.apiKeys.serp}&num=8`);
      if (!resp.ok) continue;
      const data = await resp.json();
      (data.organic_results||[]).forEach(r => {
        if (r.link && r.link.toLowerCase().includes(domain)) urlMap.set(r.link, r.snippet||'');
      });
    } catch(e) { /* skip */ }
  }
  return Array.from(urlMap.keys()).slice(0,18);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APIFY CRAWL â€” single fonds
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function crawlFonds(fondsUrl, serpUrls, onStatus) {
  const startUrls = serpUrls.length > 0
    ? serpUrls.map(u=>({url:u}))
    : [{url: fondsUrl}];

  onStatus('start', `Starten â€” ${startUrls.length} URLs`);
  const runResp = await fetch(
    `https://api.apify.com/v2/acts/thu1710~my-actor/runs?token=${appState.apiKeys.apify}`,
    { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({startUrls, maxCrawlDepth:3, maxCrawledPages:30}) }
  );
  if (!runResp.ok) throw new Error(`Apify start mislukt (${runResp.status}): ${await runResp.text()}`);
  const runData = await runResp.json();
  const runId   = runData.data?.id;
  const dsId    = runData.data?.defaultDatasetId;
  if (!runId) throw new Error('Geen run ID van Apify');

  let status = 'RUNNING', polls = 0;
  while (['RUNNING','READY'].includes(status)) {
    await sleep(5000); polls++;
    const pd = await (await fetch(`https://api.apify.com/v2/actor-runs/${runId}?token=${appState.apiKeys.apify}`)).json();
    status = pd.data?.status || 'UNKNOWN';
    const pages = pd.data?.stats?.httpRequestsFinished ?? '?';
    onStatus('crawl', `${status} â€” ${pages} pagina's (${polls*5}s)`);
    if (polls >= 72) throw new Error('Timeout: crawl > 6 minuten');
  }
  if (status !== 'SUCCEEDED') throw new Error(`Crawl: ${status}`);

  onStatus('dataset', 'Dataset ophalen...');
  const items = await (await fetch(`https://api.apify.com/v2/datasets/${dsId}/items?token=${appState.apiKeys.apify}&format=json&limit=200&clean=true`)).json();
  if (!Array.isArray(items)) throw new Error('Onverwacht dataset formaat');

  // Priority sort
  const allSorted = [...items].sort((a,b) => {
    const au = a.url||'', bu = b.url||'';
    const ap = isPdfUrl(au) ? -5 : urlPriority(au);
    const bp = isPdfUrl(bu) ? -5 : urlPriority(bu);
    return ap-bp;
  });
  const prio  = allSorted.filter(i=>!isPdfUrl(i.url||'')&&isRelevantUrl(i.url||'')).slice(0,10);
  const pdfs  = allSorted.filter(i=>isPdfUrl(i.url||'')).slice(0,5);
  const other = allSorted.filter(i=>!isPdfUrl(i.url||'')&&!isRelevantUrl(i.url||'')).slice(0,3);
  const final = [...prio,...pdfs,...other].length > 0 ? [...prio,...pdfs,...other] : allSorted.slice(0,8);

  onStatus('done', `${prio.length} prio + ${pdfs.length} PDF + ${other.length} overig`);
  return final;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLAUDE EXTRACTION PROMPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildExtractionPrompt(bundle, fondsInfo) {
  return `Je bent een subsidie-analist gespecialiseerd in Nederlandse kunst- en cultuurfondsen.
Gebruik UITSLUITEND de aangeleverde bronnen. Verzin NIETS.
Als iets niet expliciet staat: schrijf "ONZEKER â€“ handmatig controleren".

Fonds: ${fondsInfo.naam} â€” ${fondsInfo.url}

DOEL: Extraheer ELKE individuele regeling met maximale focus op:
1. Doelgroep en toegestane aanvragers (individu? instelling? stichting? zzp?)
2. Uitgesloten aanvragers (KRITIEK â€” zoek: "niet voor", "uitgesloten", "alleen voor", "vereist KvK", "geen individuen", "geen zzp", "alleen instellingen")
3. Openstelling en deadline (zoek: "opent", "sluit", "deadline", "indienen voor", "aanvraagperiode")
4. Bedragen (zoek: â‚¬ bedragen, "maximaal", "minimum", "budget per aanvraag" â€” NIET totaalbudget fonds)
5. Projectfase

REGELS:
- toegestane_aanvragers: lijst van wie WEL kan aanvragen
- uitgesloten_aanvragers: lijst van wie NIET kan aanvragen â€” ALTIJD invullen als info beschikbaar
- Als pagina zegt "alleen instellingen": zet individuen in uitgesloten_aanvragers
- Als pagina zegt "ook individuele kunstenaars": zet in toegestane_aanvragers
- Als totaalbudget zichtbaar is (bijv. "â‚¬ 650.000 budget tijdvak"): zet dit NIET als max_bedrag

Geef UITSLUITEND JSON â€” begin met { eindig met }.

{
  "fonds_naam": "string",
  "fonds_url": "string",
  "fonds_omschrijving": "string (max 2 zinnen)",
  "regelingen": [
    {
      "naam": "string",
      "doelgroep": "string (beschrijf primaire doelgroep kort)",
      "toegestane_aanvragers": ["string"],
      "uitgesloten_aanvragers": ["string"],
      "openstelling": "string",
      "deadline": "string",
      "min_bedrag": "string",
      "max_bedrag": "string",
      "discipline": "string",
      "projectfase": "string",
      "harde_criteria": ["string"],
      "uitsluitingscriteria": ["string"],
      "evidence": [
        { "url": "string", "quote": "string (max 20 woorden)" }
      ]
    }
  ]
}

BRONNEN:
${bundle}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATCH ENGINE â€” regeling-level scoring & hard exclusions
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const EXCL_PATTERNS_INDIVIDU = [
  /niet voor individu/i,/geen individu/i,/geen zzp/i,/niet voor zzp/i,
  /alleen.*instelling/i,/uitsluitend.*instelling/i,/alleen voor.*stichting/i,
  /geen.*individuele/i,/niet.*individuele maker/i,/geen eenmanszaak/i
];
const INCL_PATTERNS_INDIVIDU = [
  /individuele kunstenaar/i,/zzp/i,/zelfstandig/i,/individuele maker/i,/ook.*individu/i
];

function detectExclusions(reg, project) {
  const excl = [];
  const rvLow = project.rechtsvorm.map(r=>r.toLowerCase()).join(' ');
  const isIndividu = rvLow.includes('individu')||rvLow.includes('zzp')||rvLow.includes('student');
  const isStichting= rvLow.includes('stichting');
  const isBv       = rvLow.includes('bv')||rvLow.includes('nv')||rvLow.includes('commerci');

  const uitgeslotenText = [...(reg.uitgesloten_aanvragers||[]), ...(reg.uitsluitingscriteria||[])].join(' ');
  const allText = [
    reg.doelgroep||'',
    ...(reg.toegestane_aanvragers||[]),
    ...(reg.uitgesloten_aanvragers||[]),
    ...(reg.uitsluitingscriteria||[]),
    ...(reg.harde_criteria||[])
  ].join(' ');

  if (isIndividu) {
    const hardExcluded = EXCL_PATTERNS_INDIVIDU.some(p=>p.test(uitgeslotenText)||p.test(allText));
    if (hardExcluded) {
      const hasOverride = INCL_PATTERNS_INDIVIDU.some(p=>p.test(reg.doelgroep||'')||p.test((reg.toegestane_aanvragers||[]).join(' ')));
      if (!hasOverride) excl.push(`Aanvrager is individu/ZZP â€” regeling richt zich op instellingen of sluit individuen expliciet uit`);
    }
    // Only-institutions check via toegestane_aanvragers
    const toegestane = (reg.toegestane_aanvragers||[]).join(' ').toLowerCase();
    if (!excl.length && toegestane.length>8 &&
        (toegestane.includes('instelling')||toegestane.includes('stichting')||toegestane.includes('organisatie')) &&
        !toegestane.includes('individu')&&!toegestane.includes('zzp')&&!toegestane.includes('maker')&&!toegestane.includes('zelfstandig')) {
      excl.push(`Toegestane aanvragers zijn instellingen/stichtingen â€” individuen niet vermeld`);
    }
  }
  if (isStichting && /niet voor stichting|geen stichting/i.test(uitgeslotenText)) {
    excl.push(`Aanvrager is stichting â€” regeling sluit stichtingen uit`);
  }
  if (isBv && /niet voor commerci|geen commerci|geen bv|geen nv/i.test(uitgeslotenText)) {
    excl.push(`Aanvrager is BV/NV â€” regeling sluit commerciÃ«le organisaties uit`);
  }

  // Regio mismatch
  const regio = project.regio.toLowerCase();
  const regioKW = ['amsterdam','rotterdam','den haag','utrecht','groningen','eindhoven','arnhem','tilburg'];
  const critText = (reg.harde_criteria||[]).join(' ').toLowerCase();
  const reqRegio = regioKW.find(r=>critText.includes(`alleen ${r}`)||critText.includes(`woonachtig in ${r}`)||critText.includes(`gevestigd in ${r}`));
  if (reqRegio && regio && !regio.includes(reqRegio)) {
    excl.push(`Regeling vereist vestiging in ${reqRegio} â€” project is gevestigd in ${project.regio||'onbekend'}`);
  }

  // Bedrag mismatch (hard: requested > max)
  const bedragTag = project.bedrag?.[0]||'';
  const maxStr = reg.max_bedrag||'';
  if (bedragTag==='â‚¬15.000+'&&maxStr&&!maxStr.includes('ONZEKER')) {
    const m = maxStr.replace(/\./g,'').match(/(\d+)/);
    if (m && parseInt(m[1])<15000) excl.push(`Gevraagd bedrag (â‚¬15.000+) overschrijdt max van regeling (${reg.max_bedrag})`);
  }

  return excl;
}

function computeScore(reg, project) {
  let s = 45;
  const disc  = (reg.discipline||'').toLowerCase();
  const doel  = (reg.doelgroep||'').toLowerCase();
  const fase  = (reg.projectfase||'').toLowerCase();
  const projDiscs = project.disciplines.map(d=>d.toLowerCase());
  const rvLow = project.rechtsvorm.map(r=>r.toLowerCase()).join(' ');

  // Discipline
  if (projDiscs.some(d=>disc.includes(d))) s+=22;
  else if (disc.includes('breed')||disc.includes('meerdere')||disc.includes('interdisciplinair')) s+=10;
  else s-=12;

  // Doelgroep match
  const isIndividu = rvLow.includes('individu')||rvLow.includes('zzp');
  if (isIndividu&&(doel.includes('individu')||doel.includes('zzp')||doel.includes('maker')||doel.includes('zelfstandig'))) s+=14;
  if (!isIndividu&&(doel.includes('instelling')||doel.includes('stichting'))) s+=10;

  // Projectfase
  const pf = project.projectFase.join(' ').toLowerCase();
  if (pf&&fase&&!fase.includes('onzeker')) {
    if (['onderzoek','productie','presentatie','talentontwikkeling','publicatie'].some(f=>pf.includes(f)&&fase.includes(f))) s+=10;
  }

  // Deadline status
  const ddl = (reg.deadline||'').toLowerCase();
  if (ddl&&!ddl.includes('onzeker')&&!ddl.includes('gesloten')) s+=5;
  if (ddl.includes('gesloten')) s-=22;

  // Bedrag
  const bedragMap = {'onder â‚¬1.000':500,'â‚¬1.000â€“â‚¬5.000':3000,'â‚¬5.000â€“â‚¬15.000':10000,'â‚¬15.000+':20000};
  const reqBedrag = bedragMap[project.bedrag?.[0]];
  if (reqBedrag&&reg.max_bedrag&&!reg.max_bedrag.includes('ONZEKER')) {
    const m = reg.max_bedrag.replace(/\./g,'').match(/(\d+)/);
    if (m) { const max=parseInt(m[1]); s+= max>=reqBedrag ? 5 : -8; }
  }

  // Sociaal
  const soc = project.sociaal.join(' ').toLowerCase();
  const allRegText = JSON.stringify(reg).toLowerCase();
  if (soc&&allRegText.includes(soc.split('/')[0])) s+=9;

  // Culturele achtergrond
  if (project.achtergrond&&allRegText.includes('culturele achtergrond')) s+=8;

  // Caribisch Nederland
  if (project.caribisch?.length > 0) {
    if (allRegText.includes('caribi')||allRegText.includes('antill')||allRegText.includes('bonaire')||allRegText.includes('curaÃ§ao')||allRegText.includes('saba')||allRegText.includes('sint eustatius')||allRegText.includes('slavernij')||allRegText.includes('trans-atlant')) s+=10;
  }

  return Math.max(0, Math.min(100, Math.round(s)));
}

function runMatchEngine(regelingen, project) {
  return regelingen.map(reg => {
    const exclusions = detectExclusions(reg, project);
    const isExcl     = exclusions.length > 0;
    const score      = isExcl ? 0 : computeScore(reg, project);
    const label      = isExcl ? 'UITGESLOTEN'
                     : score>=72 ? 'HOOG'
                     : score>=48 ? 'MIDDEL' : 'LAAG';
    return { ...reg, _uitsluitingsredenen: exclusions, _is_uitgesloten: isExcl, _score: score, _label: label };
  }).sort((a,b) => {
    const ord = {HOOG:0,MIDDEL:1,LAAG:2,UITGESLOTEN:3};
    return ord[a._label]!==ord[b._label] ? ord[a._label]-ord[b._label] : b._score-a._score;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function log(msg, type='') {
  const box = document.getElementById('logBox'); if (!box) return;
  const ts  = new Date().toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const cls = {ok:'log-ok',warn:'log-warn',err:'log-err'}[type]||'';
  box.innerHTML += `<div><span class="log-ts">[${ts}]</span><span class="${cls}">${esc(msg)}</span></div>`;
  box.scrollTop  = box.scrollHeight;
}

/* Fonds progress blocks (one per fonds) */
let fondsPB = {}; // fondsNaam â†’ { el, steps }

function initFondsPB(selectedFonds) {
  const container = document.getElementById('fondsProg');
  container.innerHTML = '';
  fondsPB = {};
  selectedFonds.forEach((f, i) => {
    const el = document.createElement('div');
    el.className = 'fonds-prog-item';
    el.id = `fpb${i}`;
    el.innerHTML = `
      <div class="fonds-prog-header">
        <span class="fonds-prog-icon">ğŸ›</span>
        <span class="fonds-prog-name">${esc(f.naam)}</span>
        <span class="fonds-prog-status" id="fps${i}">Wachten...</span>
      </div>
      <div class="fonds-prog-steps" id="fpsteps${i}">
        <div class="mini-step" id="ms${i}_1"><span class="mini-step-icon">ğŸ”</span>SerpAPI queries</div>
        <div class="mini-step" id="ms${i}_2"><span class="mini-step-icon">ğŸ•·</span>Apify crawl</div>
        <div class="mini-step" id="ms${i}_3"><span class="mini-step-icon">ğŸ“¥</span>Dataset ophalen</div>
        <div class="mini-step" id="ms${i}_4"><span class="mini-step-icon">ğŸ¤–</span>Claude extractie</div>
        <div class="mini-step" id="ms${i}_5"><span class="mini-step-icon">âš¡</span>Match berekening</div>
      </div>`;
    container.appendChild(el);
    fondsPB[f.naam] = { idx: i };
  });
}

function setFondsPB(fondsNaam, state, statusText='') {
  const pb = fondsPB[fondsNaam]; if (!pb) return;
  const el = document.getElementById(`fpb${pb.idx}`);
  const st = document.getElementById(`fps${pb.idx}`);
  if (!el) return;
  el.className = 'fonds-prog-item ' + state;
  if (statusText && st) st.textContent = statusText;
}

function setMiniStep(fondsNaam, stepN, state) {
  const pb = fondsPB[fondsNaam]; if (!pb) return;
  const el = document.getElementById(`ms${pb.idx}_${stepN}`); if (!el) return;
  el.className = 'mini-step ' + state;
  const icons = {1:'ğŸ”',2:'ğŸ•·',3:'ğŸ“¥',4:'ğŸ¤–',5:'âš¡'};
  el.querySelector('.mini-step-icon').textContent =
    state==='done' ? 'âœ…' : state==='error' ? 'âŒ' : icons[stepN];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN ENTRY: runFullSubsidyDiscovery
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startDiscovery() {
  syncKeys();
  appState.project = collectProject();
  appState.crawlResults = [];
  appState.matchResults = [];

  setPhase(2);

  const selectedFonds = selectFondsForDiscovery(appState.project);
  if (!selectedFonds.length) {
    alert('Geen passende fondsen gevonden op basis van je profiel. Vul discipline of rechtsvorm in.');
    setPhase(1); return;
  }

  // Discovery: search for additional funds beyond FONDSEN_DB
  log('Zoeken naar aanvullende fondsen buiten de database...', 'ok');
  let discoveredFonds = [];
  try {
    discoveredFonds = await discoverAdditionalFonds(appState.project);
    if (discoveredFonds.length > 0) {
      log(`${discoveredFonds.length} extra fonds(en) ontdekt: ${discoveredFonds.map(f=>f.naam).join(', ')}`, 'ok');
    } else {
      log('Geen aanvullende fondsen gevonden â€” doorgaan met database-selectie.', 'warn');
    }
  } catch(e) {
    log(`Discovery overgeslagen: ${e.message}`, 'warn');
  }

  // Combine: DB-selected + discovered (max 6 total)
  const allFonds = [...selectedFonds, ...discoveredFonds].slice(0, 6);

  initFondsPB(allFonds);
  log(`${allFonds.length} fondsen geselecteerd: ${allFonds.map(f=>f.naam).join(', ')}${discoveredFonds.length>0?' (incl. '+discoveredFonds.length+' ontdekt)':''}`, 'ok');

  await runFullSubsidyDiscovery(allFonds, appState.project);
}

async function runFullSubsidyDiscovery(selectedFonds, project) {
  let allMatchedRegelingen = [];

  for (const fonds of selectedFonds) {
    setFondsPB(fonds.naam, 'active', 'Bezig...');
    log(`--- Starten: ${fonds.naam} ---`);

    try {
      // â”€â”€ Step 1: SerpAPI
      setMiniStep(fonds.naam, 1, 'active');
      log(`SerpAPI queries voor ${new URL(fonds.url).hostname}...`);
      const serpUrls = await searchWithSerp(new URL(fonds.url).hostname);
      log(`${serpUrls.length} URLs gevonden`, 'ok');
      setMiniStep(fonds.naam, 1, 'done');

      // â”€â”€ Step 2+3: Crawl
      setMiniStep(fonds.naam, 2, 'active');
      const pages = await crawlFonds(fonds.url, serpUrls, (step, msg) => {
        log(`${fonds.naam}: ${msg}`);
        setFondsPB(fonds.naam, 'active', msg);
        if (step==='done') { setMiniStep(fonds.naam, 2, 'done'); setMiniStep(fonds.naam, 3, 'done'); }
      });
      log(`${pages.length} pagina's opgehaald`, 'ok');

      // â”€â”€ Step 4: Claude extractie
      setMiniStep(fonds.naam, 4, 'active');
      setFondsPB(fonds.naam, 'active', 'Claude analyseert...');
      const MAX_CH = 8500;
      const bundle = pages.map((item,i) => {
        const raw = item.markdown||item.text||item.pageContent||item.html||'';
        return `--- BRON ${i+1}: ${item.url} ---\n${stripHtml(raw).substring(0,MAX_CH)}`;
      }).join('\n\n');
      log(`Bundle ~${Math.round(bundle.length/1000)}k tekens`);

      const rawText = await callClaude([{role:'user',content:buildExtractionPrompt(bundle,fonds)}], 4096);
      let crawlData;
      try {
        const m = rawText.match(/```json\s*([\s\S]*?)\s*```/)||rawText.match(/(\{[\s\S]*\})/);
        crawlData = JSON.parse(m?m[1]:rawText);
      } catch(e) { throw new Error('JSON parse: '+e.message); }

      const regelingen = crawlData.regelingen||[];
      log(`${regelingen.length} regelingen geÃ«xtraheerd uit ${fonds.naam}`, 'ok');
      setMiniStep(fonds.naam, 4, 'done');

      // â”€â”€ Step 5: Match
      setMiniStep(fonds.naam, 5, 'active');
      const matched = runMatchEngine(regelingen, project);
      // Tag each regeling with its fonds
      matched.forEach(r => { r._fonds_naam=crawlData.fonds_naam||fonds.naam; r._fonds_url=crawlData.fonds_url||fonds.url; r._fonds_omschrijving=crawlData.fonds_omschrijving||''; });
      allMatchedRegelingen.push(...matched);
      setMiniStep(fonds.naam, 5, 'done');

      appState.crawlResults.push({ fonds, crawlData, matched });
      const nH=matched.filter(r=>r._label==='HOOG').length;
      const nM=matched.filter(r=>r._label==='MIDDEL').length;
      const nU=matched.filter(r=>r._label==='UITGESLOTEN').length;
      setFondsPB(fonds.naam, 'done', `${nH}Ã—HOOG, ${nM}Ã—MIDDEL, ${nU}Ã—UITG`);
      log(`${fonds.naam}: klaar â€” ${nH} HOOG, ${nM} MIDDEL, ${nU} UITGESLOTEN`, 'ok');

    } catch(err) {
      setFondsPB(fonds.naam, 'error', err.message.substring(0,60));
      log(`FOUT ${fonds.naam}: ${err.message}`, 'err');
    }
  }

  // Global sort: HOOG first, then by score
  allMatchedRegelingen.sort((a,b) => {
    const ord={HOOG:0,MIDDEL:1,LAAG:2,UITGESLOTEN:3};
    return ord[a._label]!==ord[b._label] ? ord[a._label]-ord[b._label] : b._score-a._score;
  });
  appState.matchResults = allMatchedRegelingen;

  await sleep(300);
  setPhase(3);
  renderResults();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDERING â€” RESULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResults() {
  const allMatches = appState.matchResults;
  const proj       = appState.project;
  const now        = new Date().toLocaleDateString('nl-NL',{day:'numeric',month:'long',year:'numeric'});

  // Filter: only show matches >= 50%
  const MIN_SCORE = 50;
  const matches   = allMatches.filter(r => r._score >= MIN_SCORE);
  const nHidden   = allMatches.length - matches.length;

  document.getElementById('resMeta').textContent =
    `${now} â€” ${proj.naam||proj.disciplines.join(', ')||'project'} â€” ${appState.crawlResults.length} fondsen geanalyseerd`;

  // Stat bar (showing only visible matches)
  const nH=matches.filter(r=>r._label==='HOOG').length;
  const nM=matches.filter(r=>r._label==='MIDDEL').length;
  document.getElementById('statBar').innerHTML = `
    <div class="stat green"><div class="stat-n">${nH}</div><div class="stat-l">Hoog</div></div>
    <div class="stat orange"><div class="stat-n">${nM}</div><div class="stat-l">Middel</div></div>
    <div class="stat blue"><div class="stat-n">${matches.length}</div><div class="stat-l">Getoond</div></div>
    ${nHidden>0?`<div class="stat"><div class="stat-n" style="font-size:1rem;color:var(--muted);">${nHidden}</div><div class="stat-l">Verborgen (&lt;50%)</div></div>`:''}`;

  // Group by fonds, render sections â€” only show fonds sections that have visible matches
  let html = '';
  let globalIdx = 0;

  appState.crawlResults.forEach(({ fonds, crawlData, matched }) => {
    const visibleMatched = matched.filter(r => r._score >= MIN_SCORE);
    if (visibleMatched.length === 0) return; // Skip fonds with no visible matches

    const nFH=visibleMatched.filter(r=>r._label==='HOOG').length;
    const nFM=visibleMatched.filter(r=>r._label==='MIDDEL').length;
    const nFHidden=matched.length - visibleMatched.length;

    html += `
      <div class="fonds-section-hd">
        <span class="fsh-icon">${fonds._discovered?'ğŸ”':'ğŸ›'}</span>
        <div class="fsh-text">
          <h3>${esc(crawlData.fonds_naam||fonds.naam)}${fonds._discovered?' <span style="font-size:.65rem;color:var(--muted);font-family:DM Sans,sans-serif;font-weight:500;">(ontdekt)</span>':''}</h3>
          <p>${esc(crawlData.fonds_omschrijving||fonds.focus||'')}</p>
        </div>
        <div class="fsh-counts">
          ${nFH?`<span class="count-badge cb-hoog">${nFH} HOOG</span>`:''}
          ${nFM?`<span class="count-badge cb-middel">${nFM} MIDDEL</span>`:''}
          ${nFHidden>0?`<span class="count-badge cb-uitg">${nFHidden} verborgen</span>`:''}
        </div>
        <div class="fsh-url"><a href="${esc(crawlData.fonds_url||fonds.url)}" target="_blank" rel="noopener">${esc(crawlData.fonds_url||fonds.url)} â†—</a></div>
      </div>`;

    visibleMatched.forEach(reg => {
      html += renderMatchCard(reg, globalIdx++);
    });
  });

  document.getElementById('resultsBody').innerHTML = html || '<div style="text-align:center;padding:3rem;color:var(--muted);">Geen regelingen met 50% of hoger gevonden. Probeer je profiel aan te passen.</div>';

  // Open first HOOG card
  const firstHoog = matches.findIndex(r=>r._label==='HOOG');
  if (firstHoog>=0) toggleCard(firstHoog);

  // Raw JSON (includes all results, including hidden)
  document.getElementById('rawJson').textContent = JSON.stringify({
    project: appState.project,
    crawlResults: appState.crawlResults.map(c=>({ fonds:c.fonds.naam, regelingen:c.crawlData.regelingen?.length })),
    matches: allMatches,
    filter: { minScore: MIN_SCORE, shown: matches.length, hidden: nHidden }
  }, null, 2);
}

function renderMatchCard(reg, i) {
  const sc        = {HOOG:'s-hoog',MIDDEL:'s-middel',LAAG:'s-laag',UITGESLOTEN:'s-uitg'}[reg._label]||'s-laag';
  const fillClass = reg._score>=72?'':reg._score>=48?'mid':'low';
  const toegestane= (reg.toegestane_aanvragers||[]).filter(Boolean);
  const uitgesloten=(reg.uitgesloten_aanvragers||[]).filter(Boolean);
  const criteria  = (reg.harde_criteria||[]).map(c=>`<div class="ci soft"><span class="ci-dot">â†’</span><span>${markUncertain(esc(c))}</span></div>`).join('');
  const exclCrit  = (reg.uitsluitingscriteria||[]).map(c=>`<div class="ci hard"><span class="ci-dot">âœ•</span><span>${markUncertain(esc(c))}</span></div>`).join('');
  const evidence  = (reg.evidence||[]).map(ev=>`<div class="ev-item"><a class="ev-url" href="${esc(ev.url)}" target="_blank">${esc(ev.url)}</a><div class="ev-quote">"${markUncertain(esc(ev.quote||''))}"</div></div>`).join('');
  const dtTags    = toegestane.map(t=>`<span class="dt-ok">âœ“ ${esc(t)}</span>`).join('')+uitgesloten.map(t=>`<span class="dt-warn">âœ• ${esc(t)}</span>`).join('');

  return `
  <div class="rc">
    <div class="rc-head" id="rch${i}" onclick="toggleCard(${i})">
      <div style="flex:1;min-width:0;">
        <div class="rc-name">${esc(reg.naam||'Onbekende regeling')}</div>
        ${reg.doelgroep?`<div class="rc-sub">${esc(reg.doelgroep)}</div>`:''}
      </div>
      <span class="score-badge ${sc}">${reg._label}</span>
      ${reg._label!=='UITGESLOTEN'?`<span style="font-size:.7rem;font-weight:700;color:var(--muted);flex-shrink:0;">${reg._score}%</span>`:''}
      <span class="chevron" id="rcc${i}">â–¾</span>
    </div>
    <div class="rc-body" id="rcb${i}">
      ${reg._is_uitgesloten?`
        <div class="excl-ban">
          <div class="excl-ban-lbl">â›” Uitgesloten â€” redenen</div>
          <ul>${(reg._uitsluitingsredenen||[]).map(r=>`<li>${esc(r)}</li>`).join('')}</ul>
        </div>`:''}
      <div class="dg">
        <div class="dc hl"><div class="dc-lbl">Openstelling</div><div class="dc-val">${markUncertain(esc(reg.openstelling||'â€”'))}</div></div>
        <div class="dc hl"><div class="dc-lbl">Deadline</div><div class="dc-val">${markUncertain(esc(reg.deadline||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Min. bedrag</div><div class="dc-val">${markUncertain(esc(reg.min_bedrag||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Max. bedrag</div><div class="dc-val">${markUncertain(esc(reg.max_bedrag||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Discipline</div><div class="dc-val">${markUncertain(esc(reg.discipline||'â€”'))}</div></div>
        <div class="dc"><div class="dc-lbl">Projectfase</div><div class="dc-val">${markUncertain(esc(reg.projectfase||'â€”'))}</div></div>
        ${reg.doelgroep?`<div class="dc" style="grid-column:1/-1;"><div class="dc-lbl">Doelgroep</div><div class="dc-val">${markUncertain(esc(reg.doelgroep))}${dtTags?`<div class="dt-tags">${dtTags}</div>`:''}</div></div>`:''}
      </div>
      ${!reg._is_uitgesloten?`
        <div class="score-bar-wrap">
          <div class="sb-row"><span>Matchscore</span><strong>${reg._score}%</strong></div>
          <div class="score-bar"><div class="score-fill ${fillClass}" style="width:${reg._score}%;"></div></div>
        </div>`:''}
      ${criteria?`<div class="crit-sec" style="margin-top:.8rem;"><h4>Harde criteria</h4><div class="crit-list">${criteria}</div></div>`:''}
      ${exclCrit?`<div class="crit-sec"><h4>âš ï¸ Uitsluitingscriteria</h4><div class="crit-list">${exclCrit}</div></div>`:''}
      ${evidence?`<div style="margin-top:.7rem;"><div style="font-size:.68rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.38rem;">Bronnen</div>${evidence}</div>`:''}
    </div>
  </div>`;
}

function toggleCard(i) {
  const body=document.getElementById(`rcb${i}`);
  const chev=document.getElementById(`rcc${i}`);
  const head=document.getElementById(`rch${i}`);
  if(!body) return;
  const isOpen=body.classList.contains('open');
  body.classList.toggle('open',!isOpen);
  if(chev) chev.classList.toggle('open',!isOpen);
  if(head) head.classList.toggle('open',!isOpen);
}

function toggleRaw() {
  const raw=document.getElementById('rawJson');
  const tog=document.getElementById('rawToggle');
  const open=raw.style.display==='block';
  raw.style.display=open?'none':'block';
  tog.textContent=open?'â–¸ Bekijk ruwe JSON':'â–¾ Verberg ruwe JSON';
}

function copyResultsJson() {
  navigator.clipboard.writeText(document.getElementById('rawJson').textContent||'').then(()=>{
    const b=event.target; b.textContent='âœ“ Gekopieerd!'; setTimeout(()=>b.textContent='ğŸ“‹ JSON',2000);
  });
}

function resetAll() {
  appState.project=null; appState.crawlResults=[]; appState.matchResults=[];
  websiteContext=''; documentContext='';
  document.getElementById('logBox').innerHTML='';
  setPhase(1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
initPsChips();
renderPsSection();
setPhase(1);
syncKeys();
updateCta();
</script>
</body>
</html>
