<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subsidiescan v4 ‚Äî Anh Thu Pham</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f4f8;
    --primary: #4a3fa5;
    --primary-light: #7b72d4;
    --accent: #c9a7e8;
    --accent2: #a8d8d0;
    --text: #1a1830;
    --muted: #7a7899;
    --border: #e4e2f0;
    --gradient: linear-gradient(135deg, #e8e4f8 0%, #f0e8f8 40%, #e4f0f8 100%);
    --warn: #f0e6d3;
    --warn-border: #e0c89a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg); color: var(--text); min-height: 100vh;
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(74,63,165,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(201,167,232,0.12) 0%, transparent 60%);
  }
  header {
    padding: 1.5rem 2.5rem; display: flex; align-items: center; gap: 1rem;
    border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.7);
    backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 10;
  }
  .logo-mark {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-family: 'DM Serif Display', serif; color: white; font-size: 1.1rem; flex-shrink: 0;
  }
  .header-text h1 { font-family: 'DM Serif Display', serif; font-size: 1.1rem; color: var(--primary); }
  .header-text p { font-size: 0.72rem; color: var(--muted); font-weight: 300; }
  .badge { background: var(--primary); color: white; font-size: 0.6rem; padding: 0.15rem 0.5rem; border-radius: 100px; font-weight: 600; letter-spacing: 0.05em; margin-left: 0.5rem; vertical-align: middle; }
  .main { max-width: 800px; margin: 0 auto; padding: 2.5rem 1.5rem 5rem; }
  .intro-card {
    background: var(--gradient); border: 1px solid var(--border); border-radius: 20px;
    padding: 2rem 2.5rem; margin-bottom: 2rem; position: relative; overflow: hidden;
  }
  .intro-card::after { content: '‚ú¶'; position: absolute; right: 2rem; top: 1.5rem; font-size: 2rem; color: var(--primary-light); opacity: 0.25; }
  .intro-card h2 { font-family: 'DM Serif Display', serif; font-size: 1.4rem; color: var(--primary); margin-bottom: 0.4rem; }
  .intro-card p { color: var(--muted); font-size: 0.88rem; line-height: 1.6; }
  .feature-pills { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 1rem; }
  .pill { background: white; border: 1px solid var(--border); border-radius: 100px; padding: 0.3rem 0.8rem; font-size: 0.75rem; color: var(--primary); font-weight: 500; }
  .form-card {
    background: white; border: 1px solid var(--border); border-radius: 20px;
    padding: 2rem 2.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 20px rgba(74,63,165,0.05);
  }
  .section-title {
    font-family: 'DM Serif Display', serif; font-size: 1.05rem; color: var(--primary);
    margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.6rem;
  }
  .num {
    width: 26px; height: 26px; background: var(--primary); color: white;
    border-radius: 8px; display: flex; align-items: center; justify-content: center;
    font-size: 0.72rem; font-family: 'DM Sans', sans-serif; font-weight: 600; flex-shrink: 0;
  }
  .field { margin-bottom: 1.25rem; }
  label { display: block; font-size: 0.82rem; font-weight: 600; color: var(--text); margin-bottom: 0.4rem; }
  .sublabel { font-size: 0.74rem; color: var(--muted); font-weight: 400; margin-left: 0.2rem; }
  .field-note { font-size: 0.78rem; color: var(--muted); line-height: 1.5; margin-bottom: 0.5rem; }
  input[type="text"], textarea, select {
    width: 100%; padding: 0.75rem 1rem; border: 1.5px solid var(--border); border-radius: 12px;
    font-family: 'DM Sans', sans-serif; font-size: 0.88rem; color: var(--text);
    background: #fafafa; transition: border-color 0.2s, box-shadow 0.2s; outline: none; -webkit-appearance: none;
  }
  input:focus, textarea:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(74,63,165,0.08); background: white; }
  textarea { resize: vertical; min-height: 90px; line-height: 1.5; }
  .tag-group { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.4rem; }
  .tag {
    padding: 0.38rem 0.8rem; border: 1.5px solid var(--border); border-radius: 100px;
    font-size: 0.78rem; cursor: pointer; transition: all 0.18s; background: #fafafa;
    user-select: none; font-family: 'DM Sans', sans-serif;
  }
  .tag:hover { border-color: var(--primary-light); background: #f0eef8; }
  .tag.selected { background: var(--primary); color: white; border-color: var(--primary); }
  .regio-info {
    display: none; background: #e8f4f0; border: 1px solid #b8ddd4;
    border-radius: 12px; padding: 1rem 1.25rem; margin-top: 0.75rem; font-size: 0.82rem; color: #2a5a50;
  }
  .regio-info.visible { display: block; }
  .regio-info strong { display: block; margin-bottom: 0.3rem; font-size: 0.78rem; }

  /* Upload / document section */
  .upload-zone {
    border: 2px dashed var(--border); border-radius: 14px; padding: 1.5rem;
    text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary-light); background: #f0eef8; }
  .upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
  .upload-zone .icon { font-size: 1.8rem; margin-bottom: 0.4rem; }
  .upload-zone p { font-size: 0.82rem; color: var(--muted); }
  .upload-zone strong { color: var(--primary); font-size: 0.85rem; }
  .status-msg { margin-top: 0.6rem; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 8px; display: none; }
  .status-msg.success { background: #e8f4f0; color: #2a5a50; display: block; }
  .status-msg.loading { background: #f0eef8; color: var(--primary); display: block; }
  .status-msg.error { background: #fde8e8; color: #8a2020; display: block; }
  .context-preview { background: #f5f4f8; border: 1px solid var(--border); border-radius: 10px; padding: 0.75rem 1rem; margin-top: 0.6rem; font-size: 0.78rem; color: var(--muted); max-height: 100px; overflow-y: auto; display: none; line-height: 1.5; }
  .context-preview.visible { display: block; }
  .or-divider { text-align: center; color: var(--muted); font-size: 0.78rem; margin: 0.75rem 0; position: relative; }
  .or-divider::before, .or-divider::after { content: ''; position: absolute; top: 50%; width: 42%; height: 1px; background: var(--border); }
  .or-divider::before { left: 0; } .or-divider::after { right: 0; }
  .url-row { display: flex; gap: 0.5rem; align-items: center; }
  .url-row input { flex: 1; }
  .url-fetch-btn {
    padding: 0.75rem 1rem; background: var(--primary); color: white; border: none; border-radius: 12px;
    font-family: 'DM Sans', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0;
  }
  .url-fetch-btn:hover { background: var(--primary-light); }
  .url-fetch-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Paste doc area */
  .paste-toggle { font-size: 0.78rem; color: var(--primary); cursor: pointer; text-decoration: underline; text-underline-offset: 2px; margin-top: 0.5rem; display: inline-block; }
  .paste-area { display: none; margin-top: 0.75rem; }
  .paste-area.visible { display: block; }
  .paste-area textarea { min-height: 120px; font-size: 0.82rem; }
  .paste-save-btn {
    margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none;
    border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 600; cursor: pointer;
  }

  .generate-btn {
    width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white; border: none; border-radius: 14px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem;
    font-weight: 600; cursor: pointer; transition: all 0.2s; letter-spacing: 0.02em;
    box-shadow: 0 4px 20px rgba(74,63,165,0.25); margin-top: 0.5rem;
  }
  .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(74,63,165,0.35); }
  .generate-btn:active { transform: translateY(0); }
  .loading { display: none; text-align: center; padding: 3rem; background: white; border-radius: 20px; border: 1px solid var(--border); }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-steps { margin-top: 1rem; }
  .loading-step { font-size: 0.8rem; color: var(--muted); padding: 0.3rem 0; transition: color 0.3s; }
  .loading-step.active { color: var(--primary); font-weight: 600; }
  .loading-step.done { color: var(--accent2); }
  .result-card { display: none; background: white; border: 1px solid var(--border); border-radius: 20px; padding: 2.5rem; box-shadow: 0 2px 20px rgba(74,63,165,0.06); }
  .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); gap: 1rem; flex-wrap: wrap; }
  .result-header h2 { font-family: 'DM Serif Display', serif; color: var(--primary); font-size: 1.3rem; }
  .result-header p { font-size: 0.78rem; color: var(--muted); margin-top: 0.2rem; }
  .btn-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
  .btn-secondary { padding: 0.55rem 1.1rem; border: 1.5px solid var(--border); border-radius: 10px; background: white; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; color: var(--text); transition: all 0.2s; }
  .btn-secondary:hover { border-color: var(--primary-light); background: #f5f3fc; }
  .result-content { line-height: 1.78; font-size: 0.9rem; color: var(--text); }
  .result-content p { margin-bottom: 0.7rem; color: #3a3860; }
  .fonds-card { background: var(--gradient); border: 1px solid var(--border); border-radius: 14px; padding: 1.25rem 1.5rem; margin: 1rem 0; }
  .fonds-card h3 { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--primary); margin-bottom: 0.5rem; }
  .warn-card { background: var(--warn); border: 1px solid var(--warn-border); border-radius: 14px; padding: 1.25rem 1.5rem; margin: 1rem 0; }
  .warn-card h3 { font-size: 0.9rem; color: #8a6020; margin-bottom: 0.4rem; }
  .section-header { font-family: 'DM Serif Display', serif; font-size: 1.15rem; color: var(--primary); margin: 1.5rem 0 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
  .reset-btn { margin-top: 1.5rem; padding: 0.65rem 1.4rem; border: 1.5px solid var(--border); border-radius: 12px; background: white; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; color: var(--muted); transition: all 0.2s; }
  .reset-btn:hover { color: var(--text); border-color: var(--muted); }
  @media (max-width: 600px) {
    .main { padding: 1.5rem 1rem 3rem; }
    .form-card, .result-card { padding: 1.5rem; }
    header { padding: 1rem 1.25rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo-mark">A</div>
  <div class="header-text">
    <h1>Subsidiescan Tool <span class="badge">v4</span></h1>
    <p>Anh Thu Pham ‚Äî Subsidieadviseur voor kunstenaars</p>
  </div>
</header>

<div class="main">
  <div class="intro-card">
    <h2>Subsidiescan ‚ú¶</h2>
    <p>Vul het klantprofiel in. De tool matcht op discipline, rechtsvorm, regio en sociaal thema ‚Äî en zoekt actief naar kleinere stichtingen en gemeentelijke subsidies.</p>
    <div class="feature-pills">
      <span class="pill">üèõÔ∏è Rechtsvorm-filter</span>
      <span class="pill">üìç Regio & gemeentelijk</span>
      <span class="pill">üåê Website lezen</span>
      <span class="pill">üìÑ Document plakken of uploaden</span>
      <span class="pill">üîç Kleinere fondsen</span>
    </div>
  </div>

  <div id="formSection">

    <!-- API KEY -->
    <div class="form-card" style="border-color: #c9a7e8; background: linear-gradient(135deg, #faf8ff, #f5f0ff);">
      <div class="section-title" style="margin-bottom:0.75rem;"><span class="num" style="background:var(--accent);">üîë</span> Jouw Anthropic API Key</div>
      <p class="field-note" style="margin-bottom:0.75rem;">De tool heeft een API key nodig om Claude aan te roepen. Je key wordt <strong>alleen lokaal gebruikt</strong> en nooit opgeslagen. Haal je key op via <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--primary);">console.anthropic.com</a>.</p>
      <input type="password" id="apiKey" placeholder="sk-ant-api03-..." style="font-family:monospace; font-size:0.82rem;">
    </div>

    <!-- BLOK 1: Klantprofiel -->
    <div class="form-card">
      <div class="section-title"><span class="num">1</span> Klantprofiel</div>

      <div class="field">
        <label>Naam <span class="sublabel">(optioneel)</span></label>
        <input type="text" id="naam" placeholder="bijv. naam van de kunstenaar">
      </div>

      <div class="field">
        <label>Rechtsvorm <span class="sublabel">‚Äî sommige fondsen financieren alleen individuen, andere alleen organisaties</span></label>
        <div class="tag-group" id="rechtsVormTags">
          <span class="tag" data-val="individuele kunstenaar (zzp)">Individuele kunstenaar / ZZP</span>
          <span class="tag" data-val="kunstenaarscollectief (informeel)">Kunstenaarscollectief (informeel)</span>
          <span class="tag" data-val="stichting">Stichting</span>
          <span class="tag" data-val="vereniging">Vereniging</span>
          <span class="tag" data-val="bv/nv (commercieel)">BV / NV (commercieel)</span>
          <span class="tag" data-val="student (geen kvk)">Student (geen KvK)</span>
        </div>
      </div>

      <div class="field">
        <label>Kunstdiscipline(s)</label>
        <div class="tag-group" id="disciplineTags">
          <span class="tag" data-val="beeldende kunst">Beeldende kunst</span>
          <span class="tag" data-val="muziek">Muziek</span>
          <span class="tag" data-val="theater">Theater</span>
          <span class="tag" data-val="dans">Dans</span>
          <span class="tag" data-val="film">Film</span>
          <span class="tag" data-val="design">Design</span>
          <span class="tag" data-val="architectuur">Architectuur</span>
          <span class="tag" data-val="digitale cultuur">Digitale cultuur</span>
          <span class="tag" data-val="mode/textiel">Mode / Textiel</span>
          <span class="tag" data-val="literatuur">Literatuur</span>
          <span class="tag" data-val="fotografie">Fotografie</span>
          <span class="tag" data-val="erfgoed">Erfgoed</span>
          <span class="tag" data-val="podiumkunsten">Podiumkunsten</span>
          <span class="tag" data-val="interdisciplinair">Interdisciplinair</span>
        </div>
      </div>

      <div class="field">
        <label>Carri√®refase</label>
        <div class="tag-group" id="faseTags">
          <span class="tag" data-val="startend (0-3 jaar)">Startend (0‚Äì3 jaar)</span>
          <span class="tag" data-val="gevestigd (3-10 jaar)">Gevestigd (3‚Äì10 jaar)</span>
          <span class="tag" data-val="ervaren (10+ jaar)">Ervaren (10+ jaar)</span>
          <span class="tag" data-val="student">Student</span>
        </div>
      </div>

      <div class="field">
        <label>Woonplaats / stad</label>
        <input type="text" id="regio" placeholder="bijv. Amsterdam, Den Haag, Rotterdam, Utrecht..." oninput="updateRegioInfo(this.value)">
        <div class="regio-info" id="regioInfo"></div>
      </div>

      <div class="field">
        <label>Culturele achtergrond <span class="sublabel">(optioneel ‚Äî relevant voor Prins Clausfonds, DNB Fonds)</span></label>
        <input type="text" id="achtergrond" placeholder="bijv. Vietnamese roots, Surinaamse achtergrond...">
      </div>
    </div>

    <!-- BLOK 2: Portfolio & Documenten -->
    <div class="form-card">
      <div class="section-title"><span class="num">2</span> Portfolio & Documenten <span class="sublabel" style="font-family:'DM Sans',sans-serif;font-size:0.76rem;color:var(--muted);font-weight:400;margin-left:0.2rem">‚Äî optioneel maar sterk aanbevolen</span></div>

      <div class="field">
        <label>Website of portfolio-URL</label>
        <p class="field-note">De AI leest de website en haalt zelf op: vertoningsgeschiedenis, festivals, samenwerkingen, kunstcontext ‚Äî precies wat bepaalt bij welk fonds iemand past.</p>
        <div class="url-row">
          <input type="text" id="portfolioUrl" placeholder="https://www.kunstenaarnaam.nl">
          <button class="url-fetch-btn" id="fetchBtn" onclick="fetchWebsite()">üåê Lezen</button>
        </div>
        <div class="status-msg" id="urlStatus"></div>
        <div class="context-preview" id="urlPreview"></div>
      </div>

      <div class="or-divider">of</div>

      <div class="field">
        <label>Projectplan, CV of portfolio uploaden of plakken</label>
        <p class="field-note">Upload een PDF of .txt bestand ‚Äî de AI leest de volledige inhoud inclusief afbeeldingen en opmaak. Of klik op "Tekst plakken" om tekst handmatig in te voeren.</p>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileUpload').click()">
          <div class="icon">üìÑ</div>
          <strong>Klik om PDF of .txt te uploaden</strong>
          <p>of sleep een bestand hierheen ‚Äî max 20MB</p>
        </div>
        <input type="file" id="fileUpload" accept=".pdf,.txt,.md" onchange="handleFileUpload(this)" style="display:none">
        <span class="paste-toggle" onclick="togglePaste()">‚úèÔ∏è Liever tekst plakken (bijv. uit een PDF of Word)?</span>
        <div class="paste-area" id="pasteArea">
          <textarea id="pasteText" placeholder="Plak hier de inhoud van je projectplan, CV of portfolio..."></textarea>
          <button class="paste-save-btn" onclick="savePastedText()">‚úì Opslaan als context</button>
        </div>
        <div class="status-msg" id="fileStatus"></div>
        <div class="context-preview" id="filePreview"></div>
      </div>
    </div>

    <!-- BLOK 3: Project -->
    <div class="form-card">
      <div class="section-title"><span class="num">3</span> Het project</div>

      <div class="field">
        <label>Beschrijf het project zo concreet mogelijk</label>
        <textarea id="projectOmschrijving" placeholder="bijv. Een filmmaker maakt een video-installatie over stedelijke verandering in Amsterdam. Opnames zijn gepland voor najaar 2025..."></textarea>
      </div>

      <div class="field">
        <label>Projectfase</label>
        <div class="tag-group" id="faseProjTags">
          <span class="tag" data-val="idee/concept">Idee / concept</span>
          <span class="tag" data-val="onderzoek">Onderzoek</span>
          <span class="tag" data-val="ontwikkeling/pre-productie">Ontwikkeling / pre-productie</span>
          <span class="tag" data-val="productie">Productie</span>
          <span class="tag" data-val="post-productie">Post-productie</span>
          <span class="tag" data-val="presentatie/distributie">Presentatie / distributie</span>
        </div>
      </div>

      <div class="field">
        <label>Type activiteit</label>
        <div class="tag-group" id="typeTags">
          <span class="tag" data-val="nieuw werk maken">Nieuw werk</span>
          <span class="tag" data-val="presentatie/tentoonstelling">Presentatie</span>
          <span class="tag" data-val="onderzoek">Onderzoek</span>
          <span class="tag" data-val="educatie/participatie">Educatie / Participatie</span>
          <span class="tag" data-val="internationale samenwerking">Internationaal</span>
          <span class="tag" data-val="community/sociaal">Community / Sociaal</span>
          <span class="tag" data-val="digitaal/technologie">Digitaal / Tech</span>
          <span class="tag" data-val="crowdfunding">Crowdfunding</span>
        </div>
      </div>

      <div class="field">
        <label>Maatschappelijke focus <span class="sublabel">(selecteer indien van toepassing)</span></label>
        <div class="tag-group" id="sociaalTags">
          <span class="tag" data-val="polarisatie/radicalisering">Polarisatie / radicalisering</span>
          <span class="tag" data-val="trans-Atlantisch slavernij/erfgoed">Slavernij / erfgoed</span>
          <span class="tag" data-val="klimaat/duurzaamheid">Klimaat / duurzaamheid</span>
          <span class="tag" data-val="sociaal-maatschappelijk">Sociaal-maatschappelijk</span>
          <span class="tag" data-val="inclusie/diversiteit">Inclusie / diversiteit</span>
        </div>
      </div>

      <div class="field">
        <label>Gevraagd subsidiebedrag</label>
        <div class="tag-group" id="bedragTags">
          <span class="tag" data-val="onder ‚Ç¨1.000">Onder ‚Ç¨1.000</span>
          <span class="tag" data-val="‚Ç¨1.000‚Äì‚Ç¨5.000">‚Ç¨1.000 ‚Äì ‚Ç¨5.000</span>
          <span class="tag" data-val="‚Ç¨5.000‚Äì‚Ç¨15.000">‚Ç¨5.000 ‚Äì ‚Ç¨15.000</span>
          <span class="tag" data-val="‚Ç¨15.000+">‚Ç¨15.000+</span>
          <span class="tag" data-val="onbekend">Onbekend</span>
        </div>
      </div>

      <div class="field">
        <label>Extra context <span class="sublabel">(eerdere subsidies, deadlines, partners etc.)</span></label>
        <textarea id="extraContext" placeholder="bijv. heeft eerder Mondriaanfonds aangevraagd maar afgewezen, werkt samen met Paradiso..." style="min-height:70px;"></textarea>
      </div>
    </div>

    <button class="generate-btn" onclick="generateScan()">‚ú¶ Subsidiescan genereren</button>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loadingSection">
    <div class="spinner"></div>
    <p style="font-weight:600;color:var(--primary);">Subsidiescan wordt gegenereerd...</p>
    <div class="loading-steps">
      <div class="loading-step active" id="ls1">‚ë† Klantprofiel & rechtsvorm analyseren</div>
      <div class="loading-step" id="ls2">‚ë° Fondsen matchen op discipline en rechtsvorm</div>
      <div class="loading-step" id="ls3">‚ë¢ Regio & gemeentelijke subsidies ophalen</div>
      <div class="loading-step" id="ls4">‚ë£ Portfolio en documenten verwerken</div>
      <div class="loading-step" id="ls5">‚ë§ Rapport samenstellen</div>
    </div>
  </div>

  <!-- RESULT -->
  <div class="result-card" id="resultSection">
    <div class="result-header">
      <div>
        <h2>Subsidiescan Resultaat</h2>
        <p id="resultMeta"></p>
      </div>
      <div class="btn-row">
        <button class="btn-secondary" onclick="copyResult()">üìã Kopi√´ren</button>
        <button class="btn-secondary" onclick="window.print()">üñ®Ô∏è Afdrukken</button>
      </div>
    </div>
    <div class="result-content" id="resultContent"></div>
    <button class="reset-btn" onclick="resetForm()">‚Üê Nieuwe scan</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Tag selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.tag-group').forEach(group => {
  group.querySelectorAll('.tag').forEach(tag => {
    tag.addEventListener('click', () => tag.classList.toggle('selected'));
  });
});

function getSelected(id) {
  return [...document.querySelectorAll(`#${id} .tag.selected`)].map(t => t.dataset.val);
}

// ‚îÄ‚îÄ Regional info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REGIO_FONDSEN = {
  'amsterdam': { fondsen: ['Amsterdam Fonds voor de Kunsten (AFK)', 'TBI Klimaatterrein', 'W139'], gemeentelijk: 'Gemeente Amsterdam ‚Äî Kunst & Cultuur subsidies' },
  'den haag': { fondsen: ['Stroom Den Haag', 'Gemeentefonds Den Haag Cultuur'], gemeentelijk: 'Gemeente Den Haag ‚Äî cultuursubsidies' },
  'rotterdam': { fondsen: ['CBK Rotterdam', 'Prins Bernhard Cultuurfonds Zuid-Holland'], gemeentelijk: 'Gemeente Rotterdam ‚Äî Cultuursubsidies' },
  'utrecht': { fondsen: ['K.F. Hein Fonds', 'Prins Bernhard Cultuurfonds Utrecht'], gemeentelijk: 'Gemeente Utrecht ‚Äî Cultuursubsidies' },
  'eindhoven': { fondsen: ['Prins Bernhard Cultuurfonds Noord-Brabant'], gemeentelijk: 'Gemeente Eindhoven ‚Äî Cultuur en Erfgoed' },
  'groningen': { fondsen: ['Prins Bernhard Cultuurfonds Groningen'], gemeentelijk: 'Gemeente Groningen ‚Äî Cultuursubsidies' },
  'arnhem': { fondsen: ['Gelderse Cultuurfonds'], gemeentelijk: 'Gemeente Arnhem ‚Äî Cultuursubsidie' },
  'tilburg': { fondsen: ['Prins Bernhard Cultuurfonds Noord-Brabant'], gemeentelijk: 'Gemeente Tilburg ‚Äî Cultuursubsidies' },
};
function updateRegioInfo(val) {
  const key = Object.keys(REGIO_FONDSEN).find(k => val.toLowerCase().includes(k));
  const box = document.getElementById('regioInfo');
  if (key) {
    const r = REGIO_FONDSEN[key];
    box.innerHTML = `<strong>üìç Regionale fondsen voor ${val}:</strong>${r.fondsen.join(', ')} ‚Äî en: ${r.gemeentelijk}`;
    box.classList.add('visible');
  } else box.classList.remove('visible');
}

// ‚îÄ‚îÄ Fondsenlijst met rechtsvorm info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FONDSEN = [
  { naam: "Nederlands Filmfonds", focus: "film, documentaire, animatie, korte film", url: "https://www.filmfonds.nl", disciplines: ["film"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "bv/nv (commercieel)"] },
  { naam: "Filmcommission NL", focus: "filmproductie en financiering", url: "https://filmcommission.nl/fund-financing/", disciplines: ["film"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "bv/nv (commercieel)"] },
  { naam: "Stimuleringsfonds Creatieve Industrie", focus: "design, architectuur, digitale cultuur", url: "https://www.stimuleringsfonds.nl/subsidies", disciplines: ["design","architectuur","digitale cultuur"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "kunstenaarscollectief (informeel)"] },
  { naam: "Mondriaanfonds ‚Äî Werkbijdrage", focus: "beeldende kunst, fotografie ‚Äî individuele kunstenaars", url: "https://www.mondriaanfonds.nl", disciplines: ["beeldende kunst","fotografie"], rechtsvormen: ["individuele kunstenaar (zzp)"], note: "Let op: 'kunstenaar'-definitie is streng. Filmmaker kwalificeert alleen als werk in kunstdomein is vertoond (museum, galerie, kunstfestival) ‚Äî niet bij reguliere filmfestivalcategorie.", warn: true },
  { naam: "Cultuurfonds", focus: "breed cultureel", url: "https://www.cultuurfonds.nl", disciplines: ["beeldende kunst","muziek","theater","dans","literatuur","fotografie","erfgoed","interdisciplinair","mode/textiel"], rechtsvormen: ["individuele kunstenaar (zzp)", "stichting", "vereniging", "kunstenaarscollectief (informeel)"] },
  { naam: "Fonds ZOZ (Cultuurfonds)", focus: "polarisatie en radicalisering verminderen", url: "https://fondszoz.nl", disciplines: ["interdisciplinair","theater","muziek","beeldende kunst","film"], sociaal: "polarisatie/radicalisering", rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam: "DNB Fonds (Cultuurfonds)", focus: "trans-Atlantisch slavernij erfgoed", url: "https://www.cultuurfonds.nl/fondsen/dnb-fonds", disciplines: ["beeldende kunst","theater","dans","literatuur","interdisciplinair","film"], sociaal: "trans-Atlantisch slavernij/erfgoed", rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam: "VSBFonds", focus: "educatie en participatie", url: "https://www.vsbfonds.nl", disciplines: ["beeldende kunst","muziek","theater","dans","podiumkunsten"], rechtsvormen: ["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam: "Amsterdam Fonds voor de Kunsten (AFK)", focus: "Amsterdam-gebaseerde kunstenaars", url: "https://www.amsterdamsfondsvoordekunsten.nl", regio: "amsterdam", disciplines: ["beeldende kunst","muziek","theater","dans","film","literatuur","interdisciplinair","fotografie"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting","kunstenaarscollectief (informeel)"] },
  { naam: "Prins Clausfonds", focus: "kunstenaars met niet-Europese culturele achtergrond", url: "https://princeclausfund.nl", disciplines: ["interdisciplinair","beeldende kunst","dans","muziek","theater","film"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting"] },
  { naam: "Dioraphte", focus: "podiumkunsten, erfgoed, sociale initiatieven", url: "https://dioraphte.nl", disciplines: ["theater","dans","muziek","erfgoed","beeldende kunst","podiumkunsten"], rechtsvormen: ["stichting","vereniging"] },
  { naam: "Voordekunst (crowdfunding)", focus: "crowdfunding voor kunstenaars", url: "https://www.voordekunst.nl", disciplines: ["beeldende kunst","muziek","theater","dans","film","literatuur","interdisciplinair","mode/textiel"], rechtsvormen: ["individuele kunstenaar (zzp)","kunstenaarscollectief (informeel)","stichting"], type: "crowdfunding" },
  { naam: "Fonds voor Cultuurparticipatie", focus: "participatie en educatie", url: "https://cultuurparticipatie.nl", disciplines: ["educatie/participatie","muziek","dans","theater","beeldende kunst"], rechtsvormen: ["stichting","vereniging"] },
  { naam: "K.F. Hein Fonds", focus: "Utrecht regio", url: "https://kfhein.nl", regio: "utrecht", disciplines: ["beeldende kunst","muziek","theater","dans"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging"] },
  { naam: "TBI Klimaatterrein", focus: "klimaat & duurzaamheid, Amsterdam", url: "https://www.tbi-klimaattrein.nl", regio: "amsterdam", sociaal: "klimaat/duurzaamheid", disciplines: ["interdisciplinair","digitale cultuur","beeldende kunst"], rechtsvormen: ["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam: "Nationaal Digitaal Erfgoed", focus: "digitaal erfgoed", url: "https://netwerkdigitaalerfgoed.nl", disciplines: ["digitale cultuur","erfgoed"], rechtsvormen: ["stichting","vereniging","individuele kunstenaar (zzp)"] },
  { naam: "Stroom Den Haag", focus: "beeldende kunst Den Haag", url: "https://stroom.nl", regio: "den haag", disciplines: ["beeldende kunst","fotografie","digitale cultuur"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting"] },
  { naam: "CBK Rotterdam", focus: "beeldende kunst Rotterdam", url: "https://cbk.nl", regio: "rotterdam", disciplines: ["beeldende kunst","fotografie","interdisciplinair"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting"] },
  { naam: "Prins Bernhard Cultuurfonds", focus: "diverse disciplines, regionaal", url: "https://www.cultuurfonds.nl/prins-bernhard-cultuurfonds", disciplines: ["beeldende kunst","muziek","theater","dans","literatuur","erfgoed","film"], rechtsvormen: ["individuele kunstenaar (zzp)","stichting","vereniging","kunstenaarscollectief (informeel)"] },
  { naam: "W139", focus: "experimentele beeldende kunst Amsterdam", url: "https://w139.nl", regio: "amsterdam", disciplines: ["beeldende kunst","interdisciplinair","film"], rechtsvormen: ["individuele kunstenaar (zzp)","kunstenaarscollectief (informeel)"] },
];

// ‚îÄ‚îÄ Context storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let websiteContext = '';
let documentContext = '';

// ‚îÄ‚îÄ Website fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWebsite() {
  const url = document.getElementById('portfolioUrl').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!url) { alert('Vul een URL in.'); return; }
  if (!apiKey) { alert('Vul eerst je API key in bovenaan de pagina.'); return; }
  const status = document.getElementById('urlStatus');
  const preview = document.getElementById('urlPreview');
  const btn = document.getElementById('fetchBtn');
  status.className = 'status-msg loading'; status.textContent = '‚è≥ Website wordt gelezen...';
  preview.classList.remove('visible'); btn.disabled = true;
  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST", headers: { "Content-Type": "application/json", "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true", "x-api-key": apiKey },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514", max_tokens: 1000,
        messages: [{ role: "user", content: `Haal de belangrijkste informatie op van deze website voor een subsidiescan van een Nederlandse kunstenaar. URL: ${url}\n\nZoek naar:\n- Naam en discipline\n- Vertoningsgeschiedenis (filmfestivals, musea, galeries, kunstfestivals)\n- Specifieke festivals of instellingen (bijv. IDFA, Eye, Stedelijk Museum)\n- Of werk in kunst- of commerci√´le context verscheen\n- Prijzen, nominaties\n- Samenwerkingen, partners\n- Lopende projecten\n\nWees feitelijk en specifiek. Als je de site niet kunt bereiken, zeg dat eerlijk.` }]
      })
    });
    const data = await response.json();
    websiteContext = data.content?.map(c => c.text || '').join('') || '';
    if (websiteContext.length < 50 || websiteContext.toLowerCase().includes('niet kunt bereiken')) {
      status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Website kon niet worden gelezen. Probeer tekst te plakken.'; websiteContext = '';
    } else {
      status.className = 'status-msg success'; status.textContent = '‚úì Website gelezen ‚Äî wordt meegenomen in de scan.';
      preview.textContent = websiteContext.substring(0, 300) + '...'; preview.classList.add('visible');
    }
  } catch(e) {
    status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Fout bij ophalen website.'; websiteContext = '';
  }
  btn.disabled = false;
}

// ‚îÄ‚îÄ File upload ‚Äî PDF + txt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleFileUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const status = document.getElementById('fileStatus');
  const preview = document.getElementById('filePreview');

  if (file.size > 20 * 1024 * 1024) {
    status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Bestand te groot (max 20MB).'; return;
  }

  status.className = 'status-msg loading'; status.textContent = `‚è≥ "${file.name}" wordt ingelezen...`;
  preview.classList.remove('visible');

  const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) {
    status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Vul eerst je API key in bovenaan de pagina.'; return;
  }

  if (isPDF) {
    // Read as ArrayBuffer, convert to base64 manually
    const reader = new FileReader();
    reader.onload = async function(e) {
      try {
        const arrayBuffer = e.target.result;
        const bytes = new Uint8Array(arrayBuffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        const base64 = btoa(binary);

        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "anthropic-version": "2023-06-01",
            "anthropic-dangerous-direct-browser-access": "true",
            "x-api-key": apiKey
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [{
              role: "user",
              content: [
                {
                  type: "document",
                  source: { type: "base64", media_type: "application/pdf", data: base64 }
                },
                {
                  type: "text",
                  text: "Lees dit document volledig en geef een uitgebreide samenvatting van alle informatie die relevant is voor een Nederlandse subsidieaanvraag. Beschrijf: de kunstenaar en discipline, het project en artistieke visie, de vertoningsgeschiedenis en context (kunstdomein vs. commercieel), samenwerkingspartners, al lopende subsidies of aanvragen, budget en financieringsbehoeften, eventuele LOI's of steunbetuigingen, en alle andere details die fondsen belangrijk vinden. Wees specifiek en feitelijk ‚Äî benoem namen van festivals, instellingen, bedragen."
                }
              ]
            }]
          })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        documentContext = data.content?.map(c => c.text || '').join('') || '';
        if (!documentContext.trim()) throw new Error('Geen tekst gevonden');

        status.className = 'status-msg success';
        status.textContent = `‚úì "${file.name}" volledig ingelezen ‚Äî AI heeft de inhoud geanalyseerd.`;
        preview.textContent = documentContext.substring(0, 400) + '...';
        preview.classList.add('visible');

      } catch(err) {
        console.error('PDF fout:', err);
        status.className = 'status-msg error';
        status.textContent = `‚ö†Ô∏è PDF kon niet worden verwerkt: ${err.message}. Probeer "Tekst plakken" als alternatief.`;
      }
    };
    reader.onerror = () => {
      status.className = 'status-msg error';
      status.textContent = '‚ö†Ô∏è Bestand kon niet worden gelezen.';
    };
    reader.readAsArrayBuffer(file); // ‚Üê key fix: ArrayBuffer instead of DataURL

  } else {
    // Plain text
    const reader = new FileReader();
    reader.onload = (e) => {
      documentContext = e.target.result.substring(0, 8000);
      status.className = 'status-msg success'; status.textContent = `‚úì "${file.name}" ingelezen.`;
      preview.textContent = documentContext.substring(0, 300) + '...'; preview.classList.add('visible');
    };
    reader.onerror = () => { status.className = 'status-msg error'; status.textContent = '‚ö†Ô∏è Bestand kon niet worden gelezen.'; };
    reader.readAsText(file, 'UTF-8');
  }
}

// ‚îÄ‚îÄ Paste text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function togglePaste() {
  document.getElementById('pasteArea').classList.toggle('visible');
}
function savePastedText() {
  const text = document.getElementById('pasteText').value.trim();
  if (!text) return;
  documentContext = text.substring(0, 8000);
  const status = document.getElementById('fileStatus');
  const preview = document.getElementById('filePreview');
  status.className = 'status-msg success'; status.textContent = '‚úì Tekst opgeslagen als context voor de scan.';
  preview.textContent = documentContext.substring(0, 300) + (documentContext.length > 300 ? '...' : ''); preview.classList.add('visible');
  document.getElementById('pasteArea').classList.remove('visible');
}

// ‚îÄ‚îÄ Drag & drop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const zone = document.getElementById('uploadZone');
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
zone.addEventListener('drop', e => {
  e.preventDefault(); zone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) handleFileUpload({ files: e.dataTransfer.files });
});

// ‚îÄ‚îÄ Loading animation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function animateLoading() {
  let i = 0;
  const iv = setInterval(() => {
    if (i > 0) { document.getElementById(`ls${i}`).classList.remove('active'); document.getElementById(`ls${i}`).classList.add('done'); }
    i++;
    if (i <= 5) document.getElementById(`ls${i}`).classList.add('active');
    else clearInterval(iv);
  }, 900);
}

// ‚îÄ‚îÄ Generate scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateScan() {
  const naam = document.getElementById('naam').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  if (!apiKey) { alert('Vul eerst je API key in bovenaan de pagina.'); return; }
  const regio = document.getElementById('regio').value.trim();
  const achtergrond = document.getElementById('achtergrond').value.trim();
  const projectOmschrijving = document.getElementById('projectOmschrijving').value.trim();
  const extraContext = document.getElementById('extraContext').value.trim();

  const rechtsvorm = getSelected('rechtsVormTags');
  const disciplines = getSelected('disciplineTags');
  const fase = getSelected('faseTags');
  const faseProj = getSelected('faseProjTags');
  const typeProject = getSelected('typeTags');
  const sociaal = getSelected('sociaalTags');
  const bedrag = getSelected('bedragTags');

  if (!projectOmschrijving && disciplines.length === 0) { alert('Vul minimaal een projectomschrijving of discipline in.'); return; }

  document.getElementById('formSection').style.display = 'none';
  document.getElementById('loadingSection').style.display = 'block';
  animateLoading();

  const regioLower = regio.toLowerCase();
  const disciplineSet = new Set(disciplines);
  const rechtsSet = new Set(rechtsvorm);

  const scored = FONDSEN.map(f => {
    let score = 0;
    score += f.disciplines.filter(d => disciplineSet.has(d)).length * 3;
    if (f.regio && regioLower.includes(f.regio)) score += 5;
    if (f.sociaal && sociaal.includes(f.sociaal)) score += 6;
    if (typeProject.includes('crowdfunding') && f.type === 'crowdfunding') score += 6;
    if (achtergrond && f.naam.includes('Prins Clausfonds')) score += 4;
    // Rechtsvorm match ‚Äî boost if compatible, penalize if incompatible
    if (rechtsvorm.length > 0) {
      const compatible = f.rechtsvormen?.some(r => rechtsSet.has(r));
      if (compatible) score += 3;
      else score -= 5; // incompatible rechtsvorm
    }
    return { ...f, score };
  }).filter(f => f.score > 0).sort((a,b) => b.score - a.score);

  const topFondsen = scored.slice(0, 5);
  const fondsInfo = topFondsen.map((f,i) => `${i+1}. ${f.naam} ‚Äî ${f.focus} ‚Äî ${f.url}${f.note ? '\n   ‚ö†Ô∏è Let op: ' + f.note : ''}\n   Geschikt voor: ${f.rechtsvormen?.join(', ')}`).join('\n\n');

  const regioKey = Object.keys(REGIO_FONDSEN).find(k => regioLower.includes(k));
  const regioExtra = regioKey ? `Regionale fondsen voor ${regio}: ${REGIO_FONDSEN[regioKey].fondsen.join(', ')} ‚Äî en: ${REGIO_FONDSEN[regioKey].gemeentelijk}` : '';

  const prompt = `Je bent een gespecialiseerde subsidieadviseur voor kunstenaars in Nederland. Schrijf een professionele, grondige subsidiescan in het Nederlands.

KLANTPROFIEL:
- Naam: ${naam || 'niet opgegeven'}
- Rechtsvorm: ${rechtsvorm.join(', ') || 'niet opgegeven'}
- Discipline(s): ${disciplines.join(', ') || 'niet opgegeven'}
- Carri√®refase: ${fase.join(', ') || 'niet opgegeven'}
- Woonplaats: ${regio || 'niet opgegeven'}
- Culturele achtergrond: ${achtergrond || 'niet opgegeven'}
- Projectomschrijving: ${projectOmschrijving || 'niet opgegeven'}
- Projectfase: ${faseProj.join(', ') || 'niet opgegeven'}
- Type activiteit: ${typeProject.join(', ') || 'niet opgegeven'}
- Maatschappelijke focus: ${sociaal.join(', ') || 'geen'}
- Gevraagd bedrag: ${bedrag.join(', ') || 'onbekend'}
- Extra context: ${extraContext || 'geen'}

${websiteContext ? `WEBSITE/PORTFOLIO ANALYSE:\n${websiteContext}\n` : ''}
${documentContext ? `PROJECTPLAN / DOCUMENT:\n${documentContext}\n` : ''}

VOORGESELECTEERDE FONDSEN (gematcht op discipline, rechtsvorm en regio):
${fondsInfo}

REGIONALE AANVULLINGEN:
${regioExtra || 'Geen specifieke regiofondsen gevonden ‚Äî adviseer de klant om bij de gemeente te informeren naar cultuursubsidies.'}

OPDRACHT:
Schrijf een complete subsidiescan:

1. PROFIEL SAMENVATTING ‚Äî wie is de klant, wat is het project, welke rechtsvorm, en wat heb je opgemaakt uit website of document (indien aanwezig)

2. AANBEVOLEN FONDSEN ‚Äî voor elk fonds: naam, waarom het past (inclusief of de rechtsvorm matcht), de voornaamste criteria, een concrete tip voor de aanvraag, en de website URL

3. AANDACHTSPUNTEN & DEFINITIEKWESTIES ‚Äî bespreek eventuele valkuilen zoals de 'kunstenaar'-definitie bij bepaalde fondsen, of fondsen die niet openstaan voor de rechtsvorm van deze klant. Wees eerlijk en specifiek.

4. KLEINERE STICHTINGEN & GEMEENTELIJKE SUBSIDIES ‚Äî noem minimaal 2-3 kleinere of lokale fondsen die relevant kunnen zijn. Wees concreet en realistisch voor Nederland.

5. VOLGENDE STAPPEN ‚Äî prioriteer: welke fondsen eerst, welke informatie nog nodig is, en wat de klant nu moet doen.

Toon: professioneel maar toegankelijk. Eerlijk over kansen en risico's. Geen markdown-symbolen. Gebruik duidelijke kopjes en lopende tekst.`;

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true",
        "x-api-key": apiKey
      },
      body: JSON.stringify({ model: "claude-sonnet-4-20250514", max_tokens: 1000, messages: [{ role: "user", content: prompt }] })
    });
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    const text = data.content?.map(c => c.text || '').join('') || 'Er is iets misgegaan.';
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'block';
    const now = new Date().toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' });
    document.getElementById('resultMeta').textContent = `Gegenereerd op ${now}${naam ? ' ¬∑ ' + naam : ''}`;
    document.getElementById('resultContent').innerHTML = formatResult(text);
  } catch(err) {
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('formSection').style.display = 'block';
    alert(`Er is een fout opgetreden: ${err.message}`);
  }
}

function formatResult(text) {
  const HEADERS = ['PROFIEL','AANBEVOLEN','AANDACHT','KLEINE','VOLGENDE','SAMENVATTING','STAP'];
  let html = '';
  for (let line of text.split('\n')) {
    line = line.trim();
    if (!line) { html += '<br>'; continue; }
    if (HEADERS.some(h => line.toUpperCase().startsWith(h)) && line.length < 80) {
      html += `<div class="section-header">${line}</div>`;
    } else if (/^\d+\.\s[A-Z]/.test(line) && line.length < 120) {
      html += `<div class="fonds-card"><h3>${line}</h3>`;
    } else if (line.toLowerCase().includes('let op') || line.toLowerCase().includes('‚ö†Ô∏è')) {
      html += `<div class="warn-card"><h3>‚ö†Ô∏è Aandachtspunt</h3><p>${line.replace('‚ö†Ô∏è','').trim()}</p></div>`;
    } else if (line.startsWith('- ') || line.startsWith('‚Ä¢ ')) {
      html += `<p style="padding-left:1rem">‚Üí ${line.substring(2)}</p>`;
    } else {
      html += `<p>${line}</p>`;
    }
  }
  return html;
}

function copyResult() {
  navigator.clipboard.writeText(document.getElementById('resultContent').innerText).then(() => {
    const b = event.target; b.textContent = '‚úì Gekopieerd!'; setTimeout(() => b.textContent = 'üìã Kopi√´ren', 2000);
  });
}
function resetForm() {
  document.getElementById('resultSection').style.display = 'none';
  document.getElementById('formSection').style.display = 'block';
  websiteContext = ''; documentContext = '';
  window.scrollTo(0, 0);
}
</script>
</body>
</html>
